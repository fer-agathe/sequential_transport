<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>4&nbsp; Faster Algorithm – Sequential Conditional (Marginally Optimal) Transport on Probabilistic Graphs for Interpretable Counterfactual Fairness</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./gaussian-dep.html" rel="next">
<link href="./transport-fast-grid.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script src="site_libs/quarto-contrib/pseudocode-2.4.1/pseudocode.min.js"></script>
<link href="site_libs/quarto-contrib/pseudocode-2.4.1/pseudocode.min.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({ TeX: { extensions: ["color.js"] }});
</script>
<script type="text/x-mathjax-config">
	MathJax.Hub.Register.StartupHook("TeX color Ready", function() {
	   MathJax.Extension["TeX/color"].colors["wongBlack"] = '#000000';
		 MathJax.Extension["TeX/color"].colors["wongGold"] = '#E69F00';
		 MathJax.Extension["TeX/color"].colors["wongLightBlue"] = '#56B4E9';
		 MathJax.Extension["TeX/color"].colors["wongGreen"] = '#009E73';
		 MathJax.Extension["TeX/color"].colors["wongYellow"] = '#F0E442';
		 MathJax.Extension["TeX/color"].colors["wongBlue"] = '#0072B2';
		 MathJax.Extension["TeX/color"].colors["wongOrange"] = '#D55E00';
		 MathJax.Extension["TeX/color"].colors["wongPurple"] = '#CC79A7';


		 MathJax.Extension["TeX/color"].colors["IBMBlue"] = '#648FFF';
		 MathJax.Extension["TeX/color"].colors["IBMPurple"] = '#785EF0';
		 MathJax.Extension["TeX/color"].colors["IBMMagenta"] = '#DC267F';
		 MathJax.Extension["TeX/color"].colors["IBMOrange"] = '#FE6100';
		 MathJax.Extension["TeX/color"].colors["IBMYellow"] = '#FFB000';
	});
</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Sequential Conditional (Marginally Optimal) Transport on Probabilistic Graphs for Interpretable Counterfactual Fairness</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/fer-agathe/sequential_transport"> <i class="bi bi-github" role="img" aria-label="GitHub">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./gaussian.html">II. Simulations</a></li><li class="breadcrumb-item"><a href="./algorithm-5.html"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Faster Algorithm</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">I. Optimal Transport</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./optimal-transport.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Optimal Transport</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">II. Simulations</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./gaussian.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Gaussian Simulations</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./transport-fast-grid.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Fast Transport on a Grid with Numerical Covariates</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./algorithm-5.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Faster Algorithm</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./gaussian-dep.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Wrong Causal Assumptions</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">III. Counterfactuals with Law Dataset</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./classifier.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Classifier</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cf-naive.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Naive Approach</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cf-fairadapt.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Fairadapt</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cf-ot.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Multivariate Optimal Transport</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cf-seq-transport.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Sequential Transport</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./cf-comparison.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Counterfactuals: comparison</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">IV. Counterfactuals with Other Datasets</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./example-adult.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Adult Dataset</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./example-compas.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">COMPAS Dataset</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#data-generation" id="toc-data-generation" class="nav-link active" data-scroll-target="#data-generation"><span class="header-section-number">4.1</span> Data Generation</a></li>
  <li><a href="#optimal-transport" id="toc-optimal-transport" class="nav-link" data-scroll-target="#optimal-transport"><span class="header-section-number">4.2</span> Optimal Transport</a></li>
  <li><a href="#sequential-transport-step-by-step-example" id="toc-sequential-transport-step-by-step-example" class="nav-link" data-scroll-target="#sequential-transport-step-by-step-example"><span class="header-section-number">4.3</span> Sequential Transport: Step by Step Example</a>
  <ul class="collapse">
  <li><a href="#topological-ordering" id="toc-topological-ordering" class="nav-link" data-scroll-target="#topological-ordering"><span class="header-section-number">4.3.1</span> Topological Ordering</a></li>
  <li><a href="#transport-of-the-first-variable" id="toc-transport-of-the-first-variable" class="nav-link" data-scroll-target="#transport-of-the-first-variable"><span class="header-section-number">4.3.2</span> Transport of the First Variable</a></li>
  <li><a href="#transport-of-the-second-variable" id="toc-transport-of-the-second-variable" class="nav-link" data-scroll-target="#transport-of-the-second-variable"><span class="header-section-number">4.3.3</span> Transport of the Second Variable</a></li>
  <li><a href="#transport-of-the-subsequent-variables" id="toc-transport-of-the-subsequent-variables" class="nav-link" data-scroll-target="#transport-of-the-subsequent-variables"><span class="header-section-number">4.3.4</span> Transport of the Subsequent Variables</a></li>
  </ul></li>
  <li><a href="#wrapping-up-the-sequential-transport-function" id="toc-wrapping-up-the-sequential-transport-function" class="nav-link" data-scroll-target="#wrapping-up-the-sequential-transport-function"><span class="header-section-number">4.4</span> Wrapping up: The Sequential Transport Function</a></li>
  <li><a href="#comparison-sequential-transport-and-multivariate-optimal-transport" id="toc-comparison-sequential-transport-and-multivariate-optimal-transport" class="nav-link" data-scroll-target="#comparison-sequential-transport-and-multivariate-optimal-transport"><span class="header-section-number">4.5</span> Comparison: Sequential Transport and Multivariate Optimal Transport</a></li>
  <li><a href="#transport-of-a-new-individual" id="toc-transport-of-a-new-individual" class="nav-link" data-scroll-target="#transport-of-a-new-individual"><span class="header-section-number">4.6</span> Transport of a New Individual</a>
  <ul class="collapse">
  <li><a href="#optimal-transport-1" id="toc-optimal-transport-1" class="nav-link" data-scroll-target="#optimal-transport-1"><span class="header-section-number">4.6.1</span> Optimal Transport</a></li>
  <li><a href="#sequential-transport" id="toc-sequential-transport" class="nav-link" data-scroll-target="#sequential-transport"><span class="header-section-number">4.6.2</span> Sequential Transport</a></li>
  <li><a href="#sec-regression-model" id="toc-sec-regression-model" class="nav-link" data-scroll-target="#sec-regression-model"><span class="header-section-number">4.6.3</span> Hypothetical Model</a></li>
  <li><a href="#visualization" id="toc-visualization" class="nav-link" data-scroll-target="#visualization"><span class="header-section-number">4.6.4</span> Visualization</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./gaussian.html">II. Simulations</a></li><li class="breadcrumb-item"><a href="./algorithm-5.html"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Faster Algorithm</span></a></li></ol></nav>
<div class="quarto-title">
<h1 class="title"><span id="sec-alg-3" class="quarto-section-identifier"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Faster Algorithm</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<!-- In the terminal: -->
<!-- quarto add leovan/quarto-pseudocode -->
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Objectives
</div>
</div>
<div class="callout-body-container callout-body">
<p>In this chapter, we illustrate the interpretable counterfactual fairness methodology based on sequential transport on simulated data.</p>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Required packages and definition of colours.</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ks)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dichromat)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(fairadapt)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(expm)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cluster)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>colours <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">0</span><span class="st">`</span> <span class="ot">=</span> <span class="st">"#5BBCD6"</span>, </span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">1</span><span class="st">`</span> <span class="ot">=</span> <span class="st">"#FF0000"</span>, </span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">A =</span> <span class="st">"#00A08A"</span>, </span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">B =</span> <span class="st">"#F2AD00"</span>, </span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">with =</span> <span class="st">"#046C9A"</span>, </span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">without =</span> <span class="st">"#C93312"</span>, </span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">2</span><span class="st">`</span> <span class="ot">=</span> <span class="st">"#0B775E"</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Colour scale from colour of class 0 to class 1</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>colfunc <span class="ot">&lt;-</span> <span class="fu">colorRampPalette</span>(<span class="fu">c</span>(colours[<span class="st">"0"</span>], colours[<span class="st">"1"</span>]))</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>scl <span class="ot">&lt;-</span> scales<span class="sc">::</span><span class="fu">alpha</span>(<span class="fu">colfunc</span>(<span class="dv">9</span>),.<span class="dv">9</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="data-generation" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="data-generation"><span class="header-section-number">4.1</span> Data Generation</h2>
<p>Consider a causal structural model with a sensitive attribute <span class="math inline">\(s\)</span> with no parents, two legitimate features <span class="math inline">\(x_1\)</span> and <span class="math inline">\(x_2\)</span>, and an outcome <span class="math inline">\(y\)</span>.</p>
<p>Let us draw 100 observation per group. For group 0, we draw values from a multivariate Gaussian distribution with mean -1 and the following variance-covariance matrix: <span class="math inline">\(\Sigma_0 = \begin{bmatrix}1.2^2 &amp; \frac{1.2^2}{2}\\ \frac{1.2^2}{2} &amp; 1.2^2\end{bmatrix}\)</span>. For group 1, we draw values from a multivariate Gaussian distribution with mean 1.5 and with the following variance-covariance matrix: <span class="math inline">\(\Sigma_0 = \begin{bmatrix}.9^2 &amp; -\frac{4\times .9^2}{10}\\ -\frac{4 \times .9^2}{2} &amp; .9^2\end{bmatrix}\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Number of observations per group</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>) <span class="co"># set the seed for reproductible results</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>n0 <span class="ot">&lt;-</span> <span class="dv">200</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co"># First bivariate Gaussian distribution: group s=0</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>M0 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="sc">-</span><span class="dv">1</span>)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>S0 <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>, .<span class="dv">5</span>, .<span class="dv">5</span>,<span class="dv">1</span>) <span class="sc">*</span> <span class="fl">1.2</span><span class="sc">^</span><span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>X0 <span class="ot">&lt;-</span> mnormt<span class="sc">::</span><span class="fu">rmnorm</span>(n0, M0, S0)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>D_SXY_0 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">S =</span> <span class="dv">0</span>,</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">X1 =</span> X0[, <span class="dv">1</span>],</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">X2 =</span> X0[, <span class="dv">2</span>]</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Second bivariate Gaussian distribution: group s=1</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>n1 <span class="ot">&lt;-</span> <span class="dv">400</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>M1 <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fl">1.5</span>, <span class="fl">1.5</span>)</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>S1 <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="sc">-</span>.<span class="dv">4</span>, <span class="sc">-</span>.<span class="dv">4</span>, <span class="dv">1</span>) <span class="sc">*</span> .<span class="dv">9</span><span class="sc">^</span><span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">2</span>)</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>X1 <span class="ot">&lt;-</span> mnormt<span class="sc">::</span><span class="fu">rmnorm</span>(n1, M1, S1)</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>D_SXY_1 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">S =</span> <span class="dv">1</span>,</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">X1 =</span> X1[,<span class="dv">1</span>],</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">X2 =</span> X1[,<span class="dv">2</span>]</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Assume the response variable, <span class="math inline">\(Y\)</span>, to be a binary variable that depends on the covariates of each group. More specifically, assume that it is drawn from a Bernoulli distribution with probability of occurrence being linked through a logistic function to <span class="math inline">\(x_1\)</span> and <span class="math inline">\(x_2\)</span>, i.e., <span class="math inline">\(Y \sim \mathcal{B}(p(S))\)</span>, where <span class="math inline">\(p(S)\)</span> differs among groups: <span class="math display">\[
p(S) = \begin{cases}
\frac{\exp{(\eta_0})}{1+\exp{(\eta_0)}}, &amp; \text{if } S = 0,\\
\frac{\exp{(\eta_1})}{1+\exp{(\eta_1)}}, &amp; \text{if } S = 1,
\end{cases}
\]</span> where <span class="math display">\[
\begin{cases}
\eta_0 = \frac{1.2 x_1 + 1.6x2}{2}\\
\eta_1 = \frac{.8 x_1 + 2.4x2}{2}.
\end{cases}
\]</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Drawing random binary response variable Y with logistic model for each group</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>eta_0 <span class="ot">&lt;-</span> (D_SXY_0<span class="sc">$</span>X1 <span class="sc">*</span> <span class="fl">1.2</span> <span class="sc">+</span> D_SXY_0<span class="sc">$</span>X2 <span class="sc">/</span> <span class="dv">2</span> <span class="sc">*</span> .<span class="dv">8</span>) <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>eta_1 <span class="ot">&lt;-</span> (D_SXY_1<span class="sc">$</span>X1 <span class="sc">*</span> .<span class="dv">8</span> <span class="sc">+</span> D_SXY_1<span class="sc">$</span>X2 <span class="sc">/</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fl">1.2</span>) <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>p_0 <span class="ot">&lt;-</span> <span class="fu">exp</span>(eta_0) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(eta_0))</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>p_1 <span class="ot">&lt;-</span> <span class="fu">exp</span>(eta_1) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(eta_1))</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>D_SXY_0<span class="sc">$</span>Y <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n0, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">prob =</span> p_0)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>D_SXY_1<span class="sc">$</span>Y <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n1, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">prob =</span> p_1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We merge the two datasets in a single one</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>D_SXY <span class="ot">&lt;-</span> <span class="fu">rbind</span>(D_SXY_0, D_SXY_1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And we create two datasets that contain individuals from group 0 only, and individuals from group 1 only:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Dataset with individuals in group 0 only</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>D_SXY0 <span class="ot">&lt;-</span> D_SXY[D_SXY<span class="sc">$</span>S <span class="sc">==</span> <span class="dv">0</span>, ]</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Dataset with individuals in group 1 only</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>D_SXY1 <span class="ot">&lt;-</span> D_SXY[D_SXY<span class="sc">$</span>S <span class="sc">==</span> <span class="dv">1</span>,]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For illustration, we would like to display the contour of the density in each group on the graphs. To do so, we rely on a kernel density estimation:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Computation of smoothing parameters (bandwidth) for kernel density estimation</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>H0 <span class="ot">&lt;-</span> <span class="fu">Hpi</span>(D_SXY0[, <span class="fu">c</span>(<span class="st">"X1"</span>,<span class="st">"X2"</span>)])</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>H1 <span class="ot">&lt;-</span> <span class="fu">Hpi</span>(D_SXY1[, <span class="fu">c</span>(<span class="st">"X1"</span>,<span class="st">"X2"</span>)])</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculating multivariate densities in each group</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>f0_2d <span class="ot">&lt;-</span> <span class="fu">kde</span>(D_SXY0[, <span class="fu">c</span>(<span class="st">"X1"</span>,<span class="st">"X2"</span>)], <span class="at">H =</span> H0, <span class="at">xmin =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">5</span>, <span class="sc">-</span><span class="dv">5</span>), <span class="at">xmax =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">5</span>))</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>f1_2d <span class="ot">&lt;-</span> <span class="fu">kde</span>(D_SXY1[, <span class="fu">c</span>(<span class="st">"X1"</span>,<span class="st">"X2"</span>)], <span class="at">H =</span> H1, <span class="at">xmin =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">5</span>, <span class="sc">-</span><span class="dv">5</span>), <span class="at">xmax =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="optimal-transport" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="optimal-transport"><span class="header-section-number">4.2</span> Optimal Transport</h2>
<p>First, for comparison purposes, since <span class="math inline">\(X_1\)</span> and <span class="math inline">\(X_2\)</span> are drawn from a multivariate Gaussian distribution, we can compute the transported values using the closed form formula.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>AA <span class="ot">&lt;-</span> <span class="fu">sqrtm</span>(S0) <span class="sc">%*%</span> S1 <span class="sc">%*%</span> (<span class="fu">sqrtm</span>(S0))</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>AA <span class="ot">&lt;-</span> <span class="fu">solve</span>(<span class="fu">sqrtm</span>(S0)) <span class="sc">%*%</span> <span class="fu">sqrtm</span>(AA) <span class="sc">%*%</span> <span class="fu">solve</span>((<span class="fu">sqrtm</span>(S0)))</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>OT <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="fu">as.vector</span>(M1 <span class="sc">+</span> AA <span class="sc">%*%</span> (x <span class="sc">-</span> M0))</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>transport_ot <span class="ot">&lt;-</span> <span class="fu">t</span>(<span class="fu">apply</span>(D_SXY_0[, <span class="fu">c</span>(<span class="st">"X1"</span>, <span class="st">"X2"</span>)], <span class="dv">1</span>, OT))</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(transport_ot)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          [,1]      [,2]
[1,] 1.1430798 1.2649116
[2,] 2.7236725 1.6419332
[3,] 0.9081769 3.0476527
[4,] 2.3834575 0.3864673
[5,] 1.1289562 1.0649093
[6,] 2.3374791 1.8850306</code></pre>
</div>
</div>
</section>
<section id="sequential-transport-step-by-step-example" class="level2" data-number="4.3">
<h2 data-number="4.3" class="anchored" data-anchor-id="sequential-transport-step-by-step-example"><span class="header-section-number">4.3</span> Sequential Transport: Step by Step Example</h2>
<section id="topological-ordering" class="level3" data-number="4.3.1">
<h3 data-number="4.3.1" class="anchored" data-anchor-id="topological-ordering"><span class="header-section-number">4.3.1</span> Topological Ordering</h3>
<p>We first need to assume a causal structure. We define the adjacency matrix of the graph.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>variables <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"S"</span>, <span class="st">"X1"</span>, <span class="st">"X2"</span>, <span class="st">"Y"</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>adj <span class="ot">&lt;-</span> <span class="fu">matrix</span>(</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># S  X1 X2 Y</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>,<span class="co"># S</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>,<span class="co"># X1</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>,<span class="co"># X2</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>  <span class="co"># Y</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">ncol =</span> <span class="fu">length</span>(variables),</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">dimnames =</span> <span class="fu">rep</span>(<span class="fu">list</span>(variables), <span class="dv">2</span>),</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">byrow =</span> <span class="cn">TRUE</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The causal graph can be plotted:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>causal_graph <span class="ot">&lt;-</span> fairadapt<span class="sc">::</span><span class="fu">graphModel</span>(adj)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(causal_graph)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-causal-graph" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-causal-graph-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.1: Assumed Causal Graph
</figcaption>
<div aria-describedby="fig-causal-graph-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="algorithm-5_files/figure-html/fig-causal-graph-1.png" class="img-fluid figure-img" width="672">
</div>
</figure>
</div>
</div>
</div>
<p>Let us set the sensitive name <code>s</code> and its value in the source distribution <code>S_0</code>. We also set the outcome name, <code>y</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> D_SXY</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>s <span class="ot">&lt;-</span>  <span class="st">"S"</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>S_0 <span class="ot">&lt;-</span>  <span class="dv">0</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="st">"Y"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Thanks to the <code class="sourceCode r"><span class="fu">topologicalOrdering</span>()</code> function from <code>{fairadapt}</code>, we can get a topological ordering from the adjacency matrix. We redefine this function here.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Topological Ordering</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @source This function comes from the fairadapt package. Drago Plecko,</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co">#'         Nicolai Meinshausen (2020). Fair data adaptation with quantile</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="co">#'         preservation Journal of Machine Learning Research, 21.242, 1-44.</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="co">#'         URL https://www.jmlr.org/papers/v21/19-966.html.</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param adj_mat Adjacency matrix with names of the variables for both rows and</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="co">#'        columns.</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return A character vector (names of the variables) providing a topological</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="co">#'         ordering.</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>topological_ordering <span class="ot">&lt;-</span> <span class="cf">function</span>(adj_mat) {</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>  nrw <span class="ot">&lt;-</span> <span class="fu">nrow</span>(adj_mat)</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>  num_walks <span class="ot">&lt;-</span> adj_mat</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_len</span>(nrw <span class="sc">+</span> <span class="dv">1</span>L)) {</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>    num_walks <span class="ot">&lt;-</span> adj_mat <span class="sc">+</span> num_walks <span class="sc">%*%</span> adj_mat</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>  comparison_matrix <span class="ot">&lt;-</span> num_walks <span class="sc">&gt;</span> <span class="dv">0</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>  top_order <span class="ot">&lt;-</span> <span class="fu">colnames</span>(adj_mat)</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_len</span>(nrw <span class="sc">-</span> <span class="dv">1</span>L)) {</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (j <span class="cf">in</span> <span class="fu">seq.int</span>(i <span class="sc">+</span> <span class="dv">1</span>L, nrw)) {</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (comparison_matrix[top_order[j], top_order[i]]) {</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>        top_order <span class="ot">&lt;-</span> <span class="fu">swap</span>(top_order, i, j)</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>  top_order</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a><span class="co">#' Swap Two Elements in a Matrix.</span></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a><span class="co">#' @source This function comes from the fairadapt package. Drago Plecko,</span></span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a><span class="co">#'         Nicolai Meinshausen (2020). Fair data adaptation with quantile</span></span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a><span class="co">#'         preservation Journal of Machine Learning Research, 21.242, 1-44.</span></span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a><span class="co">#'         URL https://www.jmlr.org/papers/v21/19-966.html.</span></span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param x A matrix.</span></span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param i Index of the first element to swap.</span></span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param j Index of the second element to swap.</span></span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a><span class="co">#' @return The matrix x where the i-th and j-th elements have been swapped.</span></span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a><span class="co">#' @noRd</span></span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>swap <span class="ot">&lt;-</span> <span class="cf">function</span>(x, i, j) {</span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>  keep <span class="ot">&lt;-</span> x[i]</span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a>  x[i] <span class="ot">&lt;-</span> x[j]</span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a>  x[j] <span class="ot">&lt;-</span> keep</span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a>  x</span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>top_order <span class="ot">&lt;-</span> <span class="fu">topological_ordering</span>(adj)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>top_order</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "S"  "X1" "X2" "Y" </code></pre>
</div>
</div>
</section>
<section id="transport-of-the-first-variable" class="level3" data-number="4.3.2">
<h3 data-number="4.3.2" class="anchored" data-anchor-id="transport-of-the-first-variable"><span class="header-section-number">4.3.2</span> Transport of the First Variable</h3>
<p>Let us extract the names of the variables that will be transported:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>variables <span class="ot">&lt;-</span> top_order[<span class="sc">!</span>top_order <span class="sc">%in%</span> <span class="fu">c</span>(s, y)]</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>variables</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "X1" "X2"</code></pre>
</div>
</div>
<p>We will therefore begin with transporting the first variable from this ordering, X1.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>x_name <span class="ot">&lt;-</span> <span class="st">"X1"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We will need to know whether this variable is numerical or not. Depending on this, we need to apply a different methodology to transport an observation <span class="math inline">\(x_1\)</span> from group <span class="math inline">\(S=0\)</span> to <span class="math inline">\(S=1\)</span>:</p>
<ul>
<li>If <span class="math inline">\(X_1\)</span> is a <strong>numerical variable</strong>, we will first compute the empirical quantile of that observation in group <span class="math inline">\(S=0\)</span>, i.e., <span class="math inline">\(F_{X_1|S=0}(x_1)\)</span>. Then, in the other group, <span class="math inline">\(S=1\)</span>, we will compute the sample quantile corresponding to a probability of <span class="math inline">\(F_{X_1|S=0}(x)\)</span>, i.e., <span class="math inline">\(x_1^* = T(x_1) = Q_{X_1 | S=1}\left( F_{X_1|S=0}(x_1) \right)\)</span>.</li>
<li>If <span class="math inline">\(X_1\)</span> is a <strong>categorical variable</strong>, we will simply draw a class from the empirical distribution of <span class="math inline">\(X_1 | S=1\)</span> and consider it to be the counterfactual value of <span class="math inline">\(x_1\)</span>.</li>
</ul>
<p>The individuals to transport are those from group <span class="math inline">\(S=0\)</span>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Observations in group S_0</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>individuals <span class="ot">&lt;-</span> data <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="sc">!!</span><span class="fu">sym</span>(s) <span class="sc">==</span> <span class="sc">!!</span>S_0)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The value of the variable that will be transported;</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>indiv_x <span class="ot">&lt;-</span> individuals <span class="sc">|&gt;</span> <span class="fu">pull</span>(<span class="sc">!!</span>x_name)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(indiv_x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -1.6725708  0.8704500 -0.8448547 -0.4469006 -1.8242234  0.4688982</code></pre>
</div>
</div>
<p>We check whether it is numerical:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>is_x_num <span class="ot">&lt;-</span> <span class="fu">is.numeric</span>(indiv_x)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>is_x_num</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
<p>Since the variable is numerical, we compute the empirical cumulative distribution function in group <span class="math inline">\(S=0\)</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Data in group S=0</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>data_0 <span class="ot">&lt;-</span> data <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="sc">!!</span><span class="fu">sym</span>(s) <span class="sc">==</span> <span class="sc">!!</span>S_0)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Observation of the variable to transport in that group</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>x_S0 <span class="ot">&lt;-</span> data_0 <span class="sc">|&gt;</span> <span class="fu">pull</span>(<span class="sc">!!</span>x_name)</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Empirical cumulative distribution function</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>F_X_S0 <span class="ot">&lt;-</span> <span class="fu">ecdf</span>(x_S0)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then, we can use this ecdf to compute the empirical quantile of all observations from group <span class="math inline">\(S=0\)</span>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="fu">F_X_S0</span>(indiv_x)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(f)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.260 0.930 0.560 0.685 0.215 0.890</code></pre>
</div>
</div>
<p>The transported value for each observation is simply the empirical quantile corresponding to a probability <code>f</code> in group <span class="math inline">\(S=1\)</span>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Data in group S=1</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>data_1 <span class="ot">&lt;-</span> data <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="sc">!!</span><span class="fu">sym</span>(s) <span class="sc">!=</span> <span class="sc">!!</span>S_0)</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Values of the variable of interest in group S=1</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>x_S1 <span class="ot">&lt;-</span> data_1 <span class="sc">|&gt;</span> <span class="fu">pull</span>(<span class="sc">!!</span>x_name)</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>transported <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">quantile</span>(x_S1, <span class="at">probs =</span> f))</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(transported)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.9432205 2.9180187 1.7502764 1.9797669 0.8352953 2.6139733</code></pre>
</div>
</div>
<p>Had the variable <span class="math inline">\(X_1\)</span> been qualitative, we would have had drawn a class from the values of <span class="math inline">\(X_1\)</span> in group <span class="math inline">\(S=1\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Do not run</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>transported <span class="ot">&lt;-</span> <span class="fu">sample</span>(x_S1, <span class="at">size =</span> <span class="fu">length</span>(x_S0), <span class="at">replace =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We store these values in a list for later use:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>list_transported <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>list_transported[[x_name]] <span class="ot">&lt;-</span> transported</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="transport-of-the-second-variable" class="level3" data-number="4.3.3">
<h3 data-number="4.3.3" class="anchored" data-anchor-id="transport-of-the-second-variable"><span class="header-section-number">4.3.3</span> Transport of the Second Variable</h3>
<p>Now that we have transported <span class="math inline">\(X_1\)</span>, we need to transport <span class="math inline">\(X_2\)</span> which also depends on <span class="math inline">\(S\)</span>, but also on <span class="math inline">\(S_1\)</span>. Again, we will need to consider two cases, depending on the type of <span class="math inline">\(X_2\)</span>.</p>
<p>Let us redefine the name of the variable of interest:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>x_name <span class="ot">&lt;-</span> <span class="st">"X2"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We get the names of the parents:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>parents <span class="ot">&lt;-</span> <span class="fu">colnames</span>(adj)[adj[, x_name] <span class="sc">==</span> <span class="dv">1</span>]</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>parents</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "S"  "X1"</code></pre>
</div>
</div>
<p>The values of the current variable in group group:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>x_S0 <span class="ot">&lt;-</span> data_0 <span class="sc">|&gt;</span> <span class="fu">pull</span>(<span class="sc">!!</span>x_name)</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>x_S1 <span class="ot">&lt;-</span> data_1 <span class="sc">|&gt;</span> <span class="fu">pull</span>(<span class="sc">!!</span>x_name)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We check its type:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>is_x_num <span class="ot">&lt;-</span> <span class="fu">is.numeric</span>(x_S0)</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>is_x_num</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
<p>The characteristics of the parent variables:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>parents_characteristics <span class="ot">&lt;-</span> data_0 <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">!!</span>parents, <span class="sc">-!!</span>s)</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(parents_characteristics)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          X1
1 -1.6725708
2  0.8704500
3 -0.8448547
4 -0.4469006
5 -1.8242234
6  0.4688982</code></pre>
</div>
</div>
<p>We isolate the characteristics of the parents in each group:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>data_0_parents <span class="ot">&lt;-</span> data_0 <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">!!</span>parents) <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">-!!</span>s)</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>data_1_parents <span class="ot">&lt;-</span> data_1 <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">!!</span>parents) <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">-!!</span>s)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then, for each observation in group <span class="math inline">\(S=0\)</span>, we compute its distance to all other observations withing the same group. We use the Gower’s distance which allows to handle mixed variables. The distance <span class="math inline">\(D(i,j)\)</span> between two observations <span class="math inline">\(i\)</span> and <span class="math inline">\(j\)</span> each represented by a vector of <span class="math inline">\(p\)</span> characteristics (<span class="math inline">\(p\)</span> features) is computed as: <span class="math display">\[D(i,j) = \frac{\sum_{k=1}^{p}\omega_k d_k(i,j)}{\sum_{k=1}^{p} \omega_k},\]</span> where <span class="math inline">\(\omega_k\)</span> are possible weights attributed to variable <span class="math inline">\(k\)</span> and <span class="math inline">\(d_k(i,j)\)</span> is the distance between the <span class="math inline">\(k\)</span>-th characteristic, which depends on its type. If the <span class="math inline">\(k\)</span>-th characteristic is numerical: <span class="math inline">\(d_k(i,j) = \frac{|x_{ik} - x_{jk}|}{R_k}\)</span>, where <span class="math inline">\(R_k = \max(x_k) - \min(x_k)\)</span>. If the <span class="math inline">\(k\)</span>-th characteristic is categorical, the distance is simply equal to 1 if the two observations <span class="math inline">\(i\)</span> and <span class="math inline">\(j\)</span> share the same characteristic, and 0 otherwise: <span class="math inline">\(d_k(i,j) = \begin{cases}1, x_{ik} = x_{jk}\\ 0, x_{ik} \ne x_{jk}\end{cases}\)</span>.</p>
<p>The distances will be used as weights to compute the CDF.</p>
<p>Let us compute these distances for each observation from group <span class="math inline">\(S=0\)</span>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>weights_S0 <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">daisy</span>(data_0_parents, <span class="at">metric =</span> <span class="st">"gower"</span>))</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>weights_S0 <span class="ot">&lt;-</span> weights_S0</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(weights_S0)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 200 200</code></pre>
</div>
</div>
<p>The row <span class="math inline">\(i\)</span> of <code>weights_S0</code> contains the distance of observation <span class="math inline">\(i\)</span> to all other observations from <span class="math inline">\(S=0\)</span> using the characteristics of the parents. For each observation, let us also compute the sum of these distances.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>tot_weights_S0 <span class="ot">&lt;-</span> <span class="fu">apply</span>(weights_S0, <span class="at">MARGIN =</span> <span class="dv">1</span>, sum)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(tot_weights_S0)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 200</code></pre>
</div>
</div>
<p>Now, let us prepare a table with the values of the characteristics of the parents where variables that were influenced by <span class="math inline">\(S\)</span> have previously been transported. In this example, <span class="math inline">\(X_1\)</span> is a parent of <span class="math inline">\(X_2\)</span> and has been transported in the first step.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>data_0_parents_t <span class="ot">&lt;-</span> data_0_parents <span class="co">#init</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (parent <span class="cf">in</span> parents) {</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># does the parent depend on the sensitive variable</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (parent <span class="sc">%in%</span> <span class="fu">names</span>(list_transported)) {</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>    data_0_parents_t <span class="ot">&lt;-</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>      data_0_parents_t <span class="sc">|&gt;</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="sc">!!</span><span class="fu">sym</span>(parent) <span class="sc">:</span><span class="er">=</span> list_transported[[parent]])</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(data_0_parents_t)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         X1
1 0.9432205
2 2.9180187
3 1.7502764
4 1.9797669
5 0.8352953
6 2.6139733</code></pre>
</div>
</div>
<p>Now, we can compute the distance between the parents from group <span class="math inline">\(S=0\)</span> (where some parent characteristics may have been transported previously) to each observation in group <span class="math inline">\(S=1\)</span>. Note that here, the <code class="sourceCode r"><span class="fu">daisy</span>()</code> function from {<code>cluster</code>} does not allow to compute the distances of each observation from one matrix to each observation of another matrix; we need to stack the two matrices and compute the distance from each observation to all the others. This is absolutely not optimal, since we will compute a lots of unrequired distances.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>combined <span class="ot">&lt;-</span> <span class="fu">rbind</span>(data_0_parents_t, data_1_parents)</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>gower_dist <span class="ot">&lt;-</span> <span class="fu">daisy</span>(combined, <span class="at">metric =</span> <span class="st">"gower"</span>)</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>gower_matrix <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(gower_dist)</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>gower_matrix <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> gower_matrix</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(gower_matrix)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 600 600</code></pre>
</div>
</div>
<p>We only need to extract the distances of all observation from group <span class="math inline">\(S=0\)</span> to observations in group <span class="math inline">\(S=1\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>n_0 <span class="ot">&lt;-</span> <span class="fu">nrow</span>(data_0_parents_t)</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>n_1 <span class="ot">&lt;-</span> <span class="fu">nrow</span>(data_1_parents)</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>weights_S1 <span class="ot">&lt;-</span> gower_matrix[<span class="dv">1</span><span class="sc">:</span>n_0, (n_0 <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(n_0 <span class="sc">+</span> n_1), drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>weights_S1 <span class="ot">&lt;-</span> weights_S1 <span class="sc">+</span> <span class="fl">1e-8</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>weights_S1 <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> (weights_S1)<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(weights_S1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 200 400</code></pre>
</div>
</div>
<p>The <span class="math inline">\(i\)</span>-th row of <code>weights_S1</code> gives the distances of the <span class="math inline">\(i\)</span>-th (transported) observation from group <span class="math inline">\(S=0\)</span> to all the observations in group <span class="math inline">\(S=1\)</span>. Let us also compute the sum of distances for each of these observations.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>tot_weights_S1 <span class="ot">&lt;-</span> <span class="fu">apply</span>(weights_S1, <span class="at">MARGIN =</span> <span class="dv">1</span>, sum)</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(tot_weights_S1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 200</code></pre>
</div>
</div>
<p>Then, to transport <span class="math inline">\(X_2\)</span>, we need to adopt a different strategy depending on its type (numeric or factor).</p>
<section id="case-of-a-numeric-variable" class="level4" data-number="4.3.3.1">
<h4 data-number="4.3.3.1" class="anchored" data-anchor-id="case-of-a-numeric-variable"><span class="header-section-number">4.3.3.1</span> Case of a Numeric Variable</h4>
<p>If the variable we need to transport is numerical, we can compute the empirical distribution function. For each observation in <span class="math inline">\(S=0\)</span>, we compute :</p>
<p><span class="math display">\[F_{X_2 | X_1^*, S=0}(x) = \frac{\sum_{i=1}^{n_0} D(x, x_{2,i}) \times \mathrm{I}(x_{2,i} \leq x)}{\sum_{i=1}^{n_0} D(x, x_{2,i})}.\]</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Empirical distribution function</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>f <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">length</span>(x_S0))</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(x_S0)) {</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>  f[i] <span class="ot">&lt;-</span> weights_S0[i, ] <span class="sc">%*%</span> (x_S0 <span class="sc">&lt;=</span> x_S0[i]) <span class="sc">/</span> tot_weights_S0[i]</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a><span class="co"># To avoid making the `weighted.quantile()` function to crash:</span></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>f[f<span class="sc">==</span><span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">-</span>(<span class="fl">1e-8</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then, we can compute the weighted quantiles in group <span class="math inline">\(S=1\)</span> at the obtained probabilities. We only keep the closest observations: here we keep only the 5th closest points and set the weight of other points to 0.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>num_neighbors <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>transported <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">length</span>(x_S0))</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(x_S0)) {</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>  wts <span class="ot">&lt;-</span> weights_S1[i, ]</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>  wts[<span class="sc">-</span><span class="fu">order</span>(wts, <span class="at">decreasing =</span> <span class="cn">TRUE</span>)[<span class="dv">1</span><span class="sc">:</span>num_neighbors]] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>  transported[i] <span class="ot">&lt;-</span> Hmisc<span class="sc">::</span><span class="fu">wtd.quantile</span>(</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> x_S1, <span class="at">weights =</span> wts, <span class="at">probs =</span> f[i]</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in Hmisc::wtd.quantile(x = x_S1, weights = wts, probs = f[i]): probable
complete loss of accuracy in modulus</code></pre>
</div>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(transported)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 200</code></pre>
</div>
</div>
</section>
<section id="case-of-a-factor-variable" class="level4" data-number="4.3.3.2">
<h4 data-number="4.3.3.2" class="anchored" data-anchor-id="case-of-a-factor-variable"><span class="header-section-number">4.3.3.2</span> Case of a Factor Variable</h4>
<p>If the variable to transport is a factor variable, we first fit a multinomial model to predict the class of that variable in group <span class="math inline">\(S=1\)</span>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Not run here</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>fit_indix_x <span class="ot">&lt;-</span> nnet<span class="sc">::</span><span class="fu">multinom</span>(</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>  class <span class="sc">~</span> .,</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> data_1_parents <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">class =</span> x_S1)</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then, we use that model to predict the values using the parents characteristics from group <span class="math inline">\(S=0\)</span>, where the previously transported characteristics were transported:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Not run here</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>pred_probs <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit_indix_x, <span class="at">type =</span> <span class="st">"probs"</span>, <span class="at">newdata =</span> data_0_parents_t)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For each prediction, we obtain a vector with estimated probabilities to belong in each category of the factor variable. We draw a class randomly using these probabilities as weights.</p>
<div class="cell">
<pre class="rn cell-code"><code># Not run here
drawn_class &lt;- apply(
  pred_probs, 1, function(x) sample(1:ncol(pred_probs), prob = x, size = 1)
)</code></pre>
</div>
<p>Then, we just format the obtained class.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Not run here</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>transported <span class="ot">&lt;-</span> <span class="fu">colnames</span>(pred_probs)[drawn_class]</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.factor</span>(x_S1)) {</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>  transported <span class="ot">&lt;-</span> <span class="fu">factor</span>(transported, <span class="at">levels =</span> <span class="fu">levels</span>(x_S1))</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The transported value can be stored.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Not run here</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>list_transported[[x_name]] <span class="ot">&lt;-</span> transported</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="transport-of-the-subsequent-variables" class="level3" data-number="4.3.4">
<h3 data-number="4.3.4" class="anchored" data-anchor-id="transport-of-the-subsequent-variables"><span class="header-section-number">4.3.4</span> Transport of the Subsequent Variables</h3>
<p>If there are more variables in the graph, we can continue using the same procedure as in the transport of the second variable.</p>
</section>
</section>
<section id="wrapping-up-the-sequential-transport-function" class="level2" data-number="4.4">
<h2 data-number="4.4" class="anchored" data-anchor-id="wrapping-up-the-sequential-transport-function"><span class="header-section-number">4.4</span> Wrapping up: The Sequential Transport Function</h2>
<p>Let us wrap up the previous steps in a function.</p>
<div class="cell">
<details class="code-fold">
<summary>R codes for the <code class="sourceCode r"><span class="fu">seq_trans</span>()</code> function.</summary>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Sequential Transport Using a Pre-Defined Causal Graph</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' The sensitive attribute, S, is assumed to be a binary variable with value</span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' $S_0$ in the source distribution and $S_1$ in the target distribution.</span></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param data Data frame with the observations.</span></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param adj Adjacency matrix for the causal graph.</span></span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param s Name of the sensitive attribute column in the data.</span></span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param S_0 Label of the sensitive attribute in the source distribution.</span></span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param y Name of the outcome variable in the data.</span></span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param num_neighbors Number of neighbors to use in the weighted quantile</span></span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a><span class="co">#'        estimation. Default to 5.</span></span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param silent If `TRUE`, the messages showing progress in the estimation are</span></span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a><span class="co">#'        not shown. Default to `silent=FALSE`.</span></span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a><span class="co">#' @returns A list with the following elements:</span></span>
<span id="cb61-17"><a href="#cb61-17" aria-hidden="true" tabindex="-1"></a><span class="co">#' * `transported`: A named list with the transported values. The names are those of the variables.</span></span>
<span id="cb61-18"><a href="#cb61-18" aria-hidden="true" tabindex="-1"></a><span class="co">#' * `weights`: A list with the weights of each observation in the two groups.</span></span>
<span id="cb61-19"><a href="#cb61-19" aria-hidden="true" tabindex="-1"></a><span class="co">#' * `ecdf`: A list with empirical distribution functions for numerical variables.</span></span>
<span id="cb61-20"><a href="#cb61-20" aria-hidden="true" tabindex="-1"></a><span class="co">#' * `ecdf_values`: A list with the values of the ecdf evaluated for each observation in the source distribution.</span></span>
<span id="cb61-21"><a href="#cb61-21" aria-hidden="true" tabindex="-1"></a><span class="co">#' * `fit_for_categ`: A list with the estimated multinomial models to predict categories using parents characteristics</span></span>
<span id="cb61-22"><a href="#cb61-22" aria-hidden="true" tabindex="-1"></a><span class="co">#' * `params`: A list with some parameters used to transport observations:</span></span>
<span id="cb61-23"><a href="#cb61-23" aria-hidden="true" tabindex="-1"></a><span class="co">#'     * `adj`: Adjacency matrix.</span></span>
<span id="cb61-24"><a href="#cb61-24" aria-hidden="true" tabindex="-1"></a><span class="co">#'     * `top_order`: Topological ordering.</span></span>
<span id="cb61-25"><a href="#cb61-25" aria-hidden="true" tabindex="-1"></a><span class="co">#'     * `s`: Name of the sensitive attribute.</span></span>
<span id="cb61-26"><a href="#cb61-26" aria-hidden="true" tabindex="-1"></a><span class="co">#'     * `S_0`: Label of the sensitive attribute in the source distribution.</span></span>
<span id="cb61-27"><a href="#cb61-27" aria-hidden="true" tabindex="-1"></a><span class="co">#'     * `y`: Name of the outcome variable in the data.</span></span>
<span id="cb61-28"><a href="#cb61-28" aria-hidden="true" tabindex="-1"></a><span class="co">#'     * `num_neighbors`: Number of neighbors used when computing quantiles.</span></span>
<span id="cb61-29"><a href="#cb61-29" aria-hidden="true" tabindex="-1"></a><span class="co">#' @md</span></span>
<span id="cb61-30"><a href="#cb61-30" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb61-31"><a href="#cb61-31" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb61-32"><a href="#cb61-32" aria-hidden="true" tabindex="-1"></a><span class="co">#' @importFrom stats predict ecdf quantile</span></span>
<span id="cb61-33"><a href="#cb61-33" aria-hidden="true" tabindex="-1"></a><span class="co">#' @importFrom dplyr across filter mutate pull select</span></span>
<span id="cb61-34"><a href="#cb61-34" aria-hidden="true" tabindex="-1"></a><span class="co">#' @importFrom tidyselect where</span></span>
<span id="cb61-35"><a href="#cb61-35" aria-hidden="true" tabindex="-1"></a><span class="co">#' @importFrom rlang sym !! := is_character</span></span>
<span id="cb61-36"><a href="#cb61-36" aria-hidden="true" tabindex="-1"></a><span class="co">#' @importFrom cluster daisy</span></span>
<span id="cb61-37"><a href="#cb61-37" aria-hidden="true" tabindex="-1"></a><span class="co">#' @importFrom Hmisc wtd.quantile</span></span>
<span id="cb61-38"><a href="#cb61-38" aria-hidden="true" tabindex="-1"></a><span class="co">#' @importFrom nnet multinom</span></span>
<span id="cb61-39"><a href="#cb61-39" aria-hidden="true" tabindex="-1"></a>seq_trans <span class="ot">&lt;-</span> <span class="cf">function</span>(data,</span>
<span id="cb61-40"><a href="#cb61-40" aria-hidden="true" tabindex="-1"></a>                      adj,</span>
<span id="cb61-41"><a href="#cb61-41" aria-hidden="true" tabindex="-1"></a>                      s,</span>
<span id="cb61-42"><a href="#cb61-42" aria-hidden="true" tabindex="-1"></a>                      S_0,</span>
<span id="cb61-43"><a href="#cb61-43" aria-hidden="true" tabindex="-1"></a>                      y,</span>
<span id="cb61-44"><a href="#cb61-44" aria-hidden="true" tabindex="-1"></a>                      <span class="at">num_neighbors =</span> <span class="dv">5</span>,</span>
<span id="cb61-45"><a href="#cb61-45" aria-hidden="true" tabindex="-1"></a>                      <span class="at">silent =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb61-46"><a href="#cb61-46" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Make sure character variables are encoded as factors</span></span>
<span id="cb61-47"><a href="#cb61-47" aria-hidden="true" tabindex="-1"></a>  data <span class="ot">&lt;-</span></span>
<span id="cb61-48"><a href="#cb61-48" aria-hidden="true" tabindex="-1"></a>    data <span class="sc">|&gt;</span></span>
<span id="cb61-49"><a href="#cb61-49" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">where</span>(is_character), <span class="sc">~</span><span class="fu">as.factor</span>(.x)))</span>
<span id="cb61-50"><a href="#cb61-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-51"><a href="#cb61-51" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Topological ordering</span></span>
<span id="cb61-52"><a href="#cb61-52" aria-hidden="true" tabindex="-1"></a>  top_order <span class="ot">&lt;-</span> <span class="fu">topological_ordering</span>(adj)</span>
<span id="cb61-53"><a href="#cb61-53" aria-hidden="true" tabindex="-1"></a>  variables <span class="ot">&lt;-</span> top_order[<span class="sc">!</span>top_order <span class="sc">%in%</span> <span class="fu">c</span>(s, y)]</span>
<span id="cb61-54"><a href="#cb61-54" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Observations in group S_0</span></span>
<span id="cb61-55"><a href="#cb61-55" aria-hidden="true" tabindex="-1"></a>  data_0 <span class="ot">&lt;-</span> data <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="sc">!!</span><span class="fu">sym</span>(s) <span class="sc">==</span> <span class="sc">!!</span>S_0)</span>
<span id="cb61-56"><a href="#cb61-56" aria-hidden="true" tabindex="-1"></a>  data_1 <span class="ot">&lt;-</span> data <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="sc">!!</span><span class="fu">sym</span>(s) <span class="sc">!=</span> <span class="sc">!!</span>S_0)</span>
<span id="cb61-57"><a href="#cb61-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-58"><a href="#cb61-58" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Lists where results will be stored</span></span>
<span id="cb61-59"><a href="#cb61-59" aria-hidden="true" tabindex="-1"></a>  list_transported <span class="ot">&lt;-</span> <span class="fu">list</span>()  <span class="co"># Transported values</span></span>
<span id="cb61-60"><a href="#cb61-60" aria-hidden="true" tabindex="-1"></a>  list_weights <span class="ot">&lt;-</span> <span class="fu">list</span>()      <span class="co"># Weights</span></span>
<span id="cb61-61"><a href="#cb61-61" aria-hidden="true" tabindex="-1"></a>  list_ecdf <span class="ot">&lt;-</span> <span class="fu">list</span>()         <span class="co"># Empirical dist. function</span></span>
<span id="cb61-62"><a href="#cb61-62" aria-hidden="true" tabindex="-1"></a>  list_ecdf_values <span class="ot">&lt;-</span> <span class="fu">list</span>()  <span class="co"># Evaluated values of the ecdf</span></span>
<span id="cb61-63"><a href="#cb61-63" aria-hidden="true" tabindex="-1"></a>  fit_for_categ <span class="ot">&lt;-</span> <span class="fu">list</span>()     <span class="co"># Fitted multinomial models for categ. variables</span></span>
<span id="cb61-64"><a href="#cb61-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-65"><a href="#cb61-65" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (x_name <span class="cf">in</span> variables) {</span>
<span id="cb61-66"><a href="#cb61-66" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (silent <span class="sc">==</span> <span class="cn">FALSE</span>) <span class="fu">cat</span>(<span class="st">"Transporting "</span>, x_name, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb61-67"><a href="#cb61-67" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Names of the parent variables</span></span>
<span id="cb61-68"><a href="#cb61-68" aria-hidden="true" tabindex="-1"></a>    parents <span class="ot">&lt;-</span> <span class="fu">colnames</span>(adj)[adj[, x_name] <span class="sc">==</span> <span class="dv">1</span>]</span>
<span id="cb61-69"><a href="#cb61-69" aria-hidden="true" tabindex="-1"></a>    <span class="co"># values of current x in each group</span></span>
<span id="cb61-70"><a href="#cb61-70" aria-hidden="true" tabindex="-1"></a>    x_S0 <span class="ot">&lt;-</span> data_0 <span class="sc">|&gt;</span> <span class="fu">pull</span>(<span class="sc">!!</span>x_name)</span>
<span id="cb61-71"><a href="#cb61-71" aria-hidden="true" tabindex="-1"></a>    x_S1 <span class="ot">&lt;-</span> data_1 <span class="sc">|&gt;</span> <span class="fu">pull</span>(<span class="sc">!!</span>x_name)</span>
<span id="cb61-72"><a href="#cb61-72" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check whether X is numeric</span></span>
<span id="cb61-73"><a href="#cb61-73" aria-hidden="true" tabindex="-1"></a>    is_x_num <span class="ot">&lt;-</span> <span class="fu">is.numeric</span>(x_S0)</span>
<span id="cb61-74"><a href="#cb61-74" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Characteristics of the parent variables (if any)</span></span>
<span id="cb61-75"><a href="#cb61-75" aria-hidden="true" tabindex="-1"></a>    parents_characteristics <span class="ot">&lt;-</span> data_0 <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">!!</span>parents, <span class="sc">-!!</span>s)</span>
<span id="cb61-76"><a href="#cb61-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-77"><a href="#cb61-77" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(parents_characteristics) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb61-78"><a href="#cb61-78" aria-hidden="true" tabindex="-1"></a>      data_0_parents <span class="ot">&lt;-</span> data_0 <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">!!</span>parents) <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">-!!</span>s)</span>
<span id="cb61-79"><a href="#cb61-79" aria-hidden="true" tabindex="-1"></a>      data_1_parents <span class="ot">&lt;-</span> data_1 <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">!!</span>parents) <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">-!!</span>s)</span>
<span id="cb61-80"><a href="#cb61-80" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Weights in S_0</span></span>
<span id="cb61-81"><a href="#cb61-81" aria-hidden="true" tabindex="-1"></a>      weights_S0 <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">daisy</span>(data_0_parents, <span class="at">metric =</span> <span class="st">"gower"</span>))</span>
<span id="cb61-82"><a href="#cb61-82" aria-hidden="true" tabindex="-1"></a>      tot_weights_S0 <span class="ot">&lt;-</span> <span class="fu">apply</span>(weights_S0, <span class="at">MARGIN =</span> <span class="dv">1</span>, sum)</span>
<span id="cb61-83"><a href="#cb61-83" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Weights in S_1</span></span>
<span id="cb61-84"><a href="#cb61-84" aria-hidden="true" tabindex="-1"></a>      <span class="co"># First, we need to get the transported values for the parents, if necessary</span></span>
<span id="cb61-85"><a href="#cb61-85" aria-hidden="true" tabindex="-1"></a>      data_0_parents_t <span class="ot">&lt;-</span> data_0_parents <span class="co">#init</span></span>
<span id="cb61-86"><a href="#cb61-86" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (parent <span class="cf">in</span> parents) {</span>
<span id="cb61-87"><a href="#cb61-87" aria-hidden="true" tabindex="-1"></a>        <span class="co"># does the parent depend on the sensitive variable</span></span>
<span id="cb61-88"><a href="#cb61-88" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (parent <span class="sc">%in%</span> <span class="fu">names</span>(list_transported)) {</span>
<span id="cb61-89"><a href="#cb61-89" aria-hidden="true" tabindex="-1"></a>          data_0_parents_t <span class="ot">&lt;-</span></span>
<span id="cb61-90"><a href="#cb61-90" aria-hidden="true" tabindex="-1"></a>            data_0_parents_t <span class="sc">|&gt;</span></span>
<span id="cb61-91"><a href="#cb61-91" aria-hidden="true" tabindex="-1"></a>            <span class="fu">mutate</span>(<span class="sc">!!</span><span class="fu">sym</span>(parent) <span class="sc">:</span><span class="er">=</span> list_transported[[parent]])</span>
<span id="cb61-92"><a href="#cb61-92" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb61-93"><a href="#cb61-93" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb61-94"><a href="#cb61-94" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Unfortunately, we will compute a lot of distances not needed</span></span>
<span id="cb61-95"><a href="#cb61-95" aria-hidden="true" tabindex="-1"></a>      combined <span class="ot">&lt;-</span> <span class="fu">rbind</span>(data_0_parents_t, data_1_parents)</span>
<span id="cb61-96"><a href="#cb61-96" aria-hidden="true" tabindex="-1"></a>      gower_dist <span class="ot">&lt;-</span> <span class="fu">daisy</span>(combined, <span class="at">metric =</span> <span class="st">"gower"</span>)</span>
<span id="cb61-97"><a href="#cb61-97" aria-hidden="true" tabindex="-1"></a>      gower_matrix <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(gower_dist)</span>
<span id="cb61-98"><a href="#cb61-98" aria-hidden="true" tabindex="-1"></a>      n_0 <span class="ot">&lt;-</span> <span class="fu">nrow</span>(data_0_parents_t)</span>
<span id="cb61-99"><a href="#cb61-99" aria-hidden="true" tabindex="-1"></a>      n_1 <span class="ot">&lt;-</span> <span class="fu">nrow</span>(data_1_parents)</span>
<span id="cb61-100"><a href="#cb61-100" aria-hidden="true" tabindex="-1"></a>      weights_S1 <span class="ot">&lt;-</span> gower_matrix[<span class="dv">1</span><span class="sc">:</span>n_0, (n_0 <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(n_0 <span class="sc">+</span> n_1), drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb61-101"><a href="#cb61-101" aria-hidden="true" tabindex="-1"></a>      weights_S1 <span class="ot">&lt;-</span> weights_S1 <span class="sc">+</span> <span class="fl">1e-8</span></span>
<span id="cb61-102"><a href="#cb61-102" aria-hidden="true" tabindex="-1"></a>      weights_S1 <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> (weights_S1)<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb61-103"><a href="#cb61-103" aria-hidden="true" tabindex="-1"></a>      tot_weights_S1 <span class="ot">&lt;-</span> <span class="fu">apply</span>(weights_S1, <span class="at">MARGIN =</span> <span class="dv">1</span>, sum)</span>
<span id="cb61-104"><a href="#cb61-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-105"><a href="#cb61-105" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (is_x_num <span class="sc">==</span> <span class="cn">TRUE</span>) {</span>
<span id="cb61-106"><a href="#cb61-106" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Numerical variable to transport</span></span>
<span id="cb61-107"><a href="#cb61-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-108"><a href="#cb61-108" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Empirical distribution function</span></span>
<span id="cb61-109"><a href="#cb61-109" aria-hidden="true" tabindex="-1"></a>        f <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">length</span>(x_S0))</span>
<span id="cb61-110"><a href="#cb61-110" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(x_S0)) {</span>
<span id="cb61-111"><a href="#cb61-111" aria-hidden="true" tabindex="-1"></a>          f[i] <span class="ot">&lt;-</span> weights_S0[i, ] <span class="sc">%*%</span> (x_S0 <span class="sc">&lt;=</span> x_S0[i]) <span class="sc">/</span> tot_weights_S0[i]</span>
<span id="cb61-112"><a href="#cb61-112" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb61-113"><a href="#cb61-113" aria-hidden="true" tabindex="-1"></a>        list_ecdf_values[[x_name]] <span class="ot">&lt;-</span> f</span>
<span id="cb61-114"><a href="#cb61-114" aria-hidden="true" tabindex="-1"></a>        f[f<span class="sc">==</span><span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">-</span>(<span class="fl">1e-8</span>)</span>
<span id="cb61-115"><a href="#cb61-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-116"><a href="#cb61-116" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Transported values</span></span>
<span id="cb61-117"><a href="#cb61-117" aria-hidden="true" tabindex="-1"></a>        transported <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">length</span>(x_S0))</span>
<span id="cb61-118"><a href="#cb61-118" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(x_S0)) {</span>
<span id="cb61-119"><a href="#cb61-119" aria-hidden="true" tabindex="-1"></a>          wts <span class="ot">&lt;-</span> weights_S1[i, ]</span>
<span id="cb61-120"><a href="#cb61-120" aria-hidden="true" tabindex="-1"></a>          wts[<span class="sc">-</span><span class="fu">order</span>(wts, <span class="at">decreasing =</span> <span class="cn">TRUE</span>)[<span class="dv">1</span><span class="sc">:</span>num_neighbors]] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb61-121"><a href="#cb61-121" aria-hidden="true" tabindex="-1"></a>          transported[i] <span class="ot">&lt;-</span> Hmisc<span class="sc">::</span><span class="fu">wtd.quantile</span>(</span>
<span id="cb61-122"><a href="#cb61-122" aria-hidden="true" tabindex="-1"></a>            <span class="at">x =</span> x_S1, <span class="at">weights =</span> weights_S1[i, ], <span class="at">probs =</span> f[i]</span>
<span id="cb61-123"><a href="#cb61-123" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb61-124"><a href="#cb61-124" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb61-125"><a href="#cb61-125" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb61-126"><a href="#cb61-126" aria-hidden="true" tabindex="-1"></a>        <span class="co"># X is non numeric and has parents</span></span>
<span id="cb61-127"><a href="#cb61-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-128"><a href="#cb61-128" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Fit a model to predict the categorical variables given the</span></span>
<span id="cb61-129"><a href="#cb61-129" aria-hidden="true" tabindex="-1"></a>        <span class="co"># characteristics of the parents in group to transport into</span></span>
<span id="cb61-130"><a href="#cb61-130" aria-hidden="true" tabindex="-1"></a>        fit_indix_x <span class="ot">&lt;-</span> nnet<span class="sc">::</span><span class="fu">multinom</span>(</span>
<span id="cb61-131"><a href="#cb61-131" aria-hidden="true" tabindex="-1"></a>          x_S0 <span class="sc">~</span> .,</span>
<span id="cb61-132"><a href="#cb61-132" aria-hidden="true" tabindex="-1"></a>          <span class="at">data =</span> data_1_parents <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">x_S0 =</span> x_S1)</span>
<span id="cb61-133"><a href="#cb61-133" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb61-134"><a href="#cb61-134" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Predictions with that model for transported parents</span></span>
<span id="cb61-135"><a href="#cb61-135" aria-hidden="true" tabindex="-1"></a>        pred_probs <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit_indix_x, <span class="at">type =</span> <span class="st">"probs"</span>, <span class="at">newdata =</span> data_0_parents_t)</span>
<span id="cb61-136"><a href="#cb61-136" aria-hidden="true" tabindex="-1"></a>        <span class="co"># For each observation, random draw of the class, using the pred probs</span></span>
<span id="cb61-137"><a href="#cb61-137" aria-hidden="true" tabindex="-1"></a>        <span class="co"># as weights</span></span>
<span id="cb61-138"><a href="#cb61-138" aria-hidden="true" tabindex="-1"></a>        drawn_class <span class="ot">&lt;-</span> <span class="fu">apply</span>(</span>
<span id="cb61-139"><a href="#cb61-139" aria-hidden="true" tabindex="-1"></a>          pred_probs, <span class="dv">1</span>,</span>
<span id="cb61-140"><a href="#cb61-140" aria-hidden="true" tabindex="-1"></a>          <span class="cf">function</span>(x) <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(pred_probs), <span class="at">prob =</span> x, <span class="at">size =</span> <span class="dv">1</span>)</span>
<span id="cb61-141"><a href="#cb61-141" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb61-142"><a href="#cb61-142" aria-hidden="true" tabindex="-1"></a>        transported <span class="ot">&lt;-</span> <span class="fu">colnames</span>(pred_probs)[drawn_class]</span>
<span id="cb61-143"><a href="#cb61-143" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">is.factor</span>(x_S1)) {</span>
<span id="cb61-144"><a href="#cb61-144" aria-hidden="true" tabindex="-1"></a>          transported <span class="ot">&lt;-</span> <span class="fu">factor</span>(transported, <span class="at">levels =</span> <span class="fu">levels</span>(x_S1))</span>
<span id="cb61-145"><a href="#cb61-145" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb61-146"><a href="#cb61-146" aria-hidden="true" tabindex="-1"></a>        fit_for_categ[[x_name]] <span class="ot">&lt;-</span> fit_indix_x</span>
<span id="cb61-147"><a href="#cb61-147" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb61-148"><a href="#cb61-148" aria-hidden="true" tabindex="-1"></a>      list_transported[[x_name]] <span class="ot">&lt;-</span> transported</span>
<span id="cb61-149"><a href="#cb61-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-150"><a href="#cb61-150" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Store weights for possible later use</span></span>
<span id="cb61-151"><a href="#cb61-151" aria-hidden="true" tabindex="-1"></a>      list_weights[[x_name]] <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb61-152"><a href="#cb61-152" aria-hidden="true" tabindex="-1"></a>        <span class="at">w_S0 =</span> <span class="fu">list</span>(<span class="at">weights =</span> weights_S0, <span class="at">tot_weights =</span> tot_weights_S0),</span>
<span id="cb61-153"><a href="#cb61-153" aria-hidden="true" tabindex="-1"></a>        <span class="at">w_S1 =</span> <span class="fu">list</span>(<span class="at">weights =</span> weights_S1, <span class="at">tot_weights =</span> tot_weights_S1)</span>
<span id="cb61-154"><a href="#cb61-154" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb61-155"><a href="#cb61-155" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb61-156"><a href="#cb61-156" aria-hidden="true" tabindex="-1"></a>      <span class="co"># No parents</span></span>
<span id="cb61-157"><a href="#cb61-157" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (is_x_num <span class="sc">==</span> <span class="cn">TRUE</span>) {</span>
<span id="cb61-158"><a href="#cb61-158" aria-hidden="true" tabindex="-1"></a>        <span class="co"># X is numerical and has no parents</span></span>
<span id="cb61-159"><a href="#cb61-159" aria-hidden="true" tabindex="-1"></a>        F_X_S0 <span class="ot">&lt;-</span> <span class="fu">ecdf</span>(x_S0)</span>
<span id="cb61-160"><a href="#cb61-160" aria-hidden="true" tabindex="-1"></a>        list_ecdf[[x_name]] <span class="ot">&lt;-</span> F_X_S0</span>
<span id="cb61-161"><a href="#cb61-161" aria-hidden="true" tabindex="-1"></a>        f <span class="ot">&lt;-</span> <span class="fu">F_X_S0</span>(x_S0)</span>
<span id="cb61-162"><a href="#cb61-162" aria-hidden="true" tabindex="-1"></a>        list_ecdf_values[[x_name]] <span class="ot">&lt;-</span> f</span>
<span id="cb61-163"><a href="#cb61-163" aria-hidden="true" tabindex="-1"></a>        transported <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">quantile</span>(x_S1, <span class="at">probs =</span> f))</span>
<span id="cb61-164"><a href="#cb61-164" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb61-165"><a href="#cb61-165" aria-hidden="true" tabindex="-1"></a>        <span class="co"># X is not numerical and has no parents</span></span>
<span id="cb61-166"><a href="#cb61-166" aria-hidden="true" tabindex="-1"></a>        transported <span class="ot">&lt;-</span> <span class="fu">sample</span>(x_S1, <span class="at">size =</span> <span class="fu">length</span>(x_S0), <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb61-167"><a href="#cb61-167" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">is.factor</span>(x_S1)) {</span>
<span id="cb61-168"><a href="#cb61-168" aria-hidden="true" tabindex="-1"></a>          transported <span class="ot">&lt;-</span> <span class="fu">factor</span>(transported, <span class="at">levels =</span> <span class="fu">levels</span>(x_S1))</span>
<span id="cb61-169"><a href="#cb61-169" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb61-170"><a href="#cb61-170" aria-hidden="true" tabindex="-1"></a>          transported <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(transported)</span>
<span id="cb61-171"><a href="#cb61-171" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb61-172"><a href="#cb61-172" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb61-173"><a href="#cb61-173" aria-hidden="true" tabindex="-1"></a>      list_transported[[x_name]] <span class="ot">&lt;-</span> transported</span>
<span id="cb61-174"><a href="#cb61-174" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb61-175"><a href="#cb61-175" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb61-176"><a href="#cb61-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-177"><a href="#cb61-177" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(</span>
<span id="cb61-178"><a href="#cb61-178" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(</span>
<span id="cb61-179"><a href="#cb61-179" aria-hidden="true" tabindex="-1"></a>      <span class="at">transported =</span> list_transported,</span>
<span id="cb61-180"><a href="#cb61-180" aria-hidden="true" tabindex="-1"></a>      <span class="at">weights =</span> list_weights,</span>
<span id="cb61-181"><a href="#cb61-181" aria-hidden="true" tabindex="-1"></a>      <span class="at">ecdf =</span> list_ecdf,</span>
<span id="cb61-182"><a href="#cb61-182" aria-hidden="true" tabindex="-1"></a>      <span class="at">ecdf_values =</span> list_ecdf_values,</span>
<span id="cb61-183"><a href="#cb61-183" aria-hidden="true" tabindex="-1"></a>      <span class="at">fit_for_categ =</span> fit_for_categ,</span>
<span id="cb61-184"><a href="#cb61-184" aria-hidden="true" tabindex="-1"></a>      <span class="at">params =</span> <span class="fu">list</span>(</span>
<span id="cb61-185"><a href="#cb61-185" aria-hidden="true" tabindex="-1"></a>        <span class="at">adj =</span> adj,</span>
<span id="cb61-186"><a href="#cb61-186" aria-hidden="true" tabindex="-1"></a>        <span class="at">top_order =</span> top_order,</span>
<span id="cb61-187"><a href="#cb61-187" aria-hidden="true" tabindex="-1"></a>        <span class="at">s =</span> s,</span>
<span id="cb61-188"><a href="#cb61-188" aria-hidden="true" tabindex="-1"></a>        <span class="at">S_0 =</span> S_0,</span>
<span id="cb61-189"><a href="#cb61-189" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> y,</span>
<span id="cb61-190"><a href="#cb61-190" aria-hidden="true" tabindex="-1"></a>        <span class="at">num_neighbors =</span> num_neighbors</span>
<span id="cb61-191"><a href="#cb61-191" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb61-192"><a href="#cb61-192" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb61-193"><a href="#cb61-193" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb61-194"><a href="#cb61-194" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We can then call this function to transport our data in a single call of that function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>transported <span class="ot">&lt;-</span> <span class="fu">seq_trans</span>(<span class="at">data =</span> D_SXY, <span class="at">adj =</span> adj, <span class="at">s =</span> <span class="st">"S"</span>, <span class="at">S_0 =</span> <span class="dv">0</span>, <span class="at">y =</span> <span class="st">"Y"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Transporting  X1 
Transporting  X2 </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in Hmisc::wtd.quantile(x = x_S1, weights = weights_S1[i, ], probs =
f[i]): probable complete loss of accuracy in modulus</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in regularize.values(x, y, ties, missing(ties), na.rm = na.rm):
collapsing to unique 'x' values</code></pre>
</div>
</div>
</section>
<section id="comparison-sequential-transport-and-multivariate-optimal-transport" class="level2" data-number="4.5">
<h2 data-number="4.5" class="anchored" data-anchor-id="comparison-sequential-transport-and-multivariate-optimal-transport"><span class="header-section-number">4.5</span> Comparison: Sequential Transport and Multivariate Optimal Transport</h2>
<p>Let us compare the transported values obtained with this algorithm to those obtained with optimal transport.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>tb_results <span class="ot">&lt;-</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>(transport_ot) <span class="sc">|&gt;</span> <span class="fu">set_names</span>(<span class="st">"X1"</span>, <span class="st">"X2"</span>) <span class="sc">|&gt;</span></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">id =</span> <span class="fu">row_number</span>(), <span class="at">type =</span> <span class="st">"OT"</span>) <span class="sc">|&gt;</span></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tibble</span>(</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">X1 =</span> transported<span class="sc">$</span>transported<span class="sc">$</span>X1,</span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">X2 =</span> transported<span class="sc">$</span>transported<span class="sc">$</span>X2,</span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">X3 =</span> transported<span class="sc">$</span>transported<span class="sc">$</span>X3,</span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a>      <span class="at">type =</span> <span class="st">"seq_t"</span></span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">|&gt;</span></span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">id =</span> <span class="fu">row_number</span>())</span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true" tabindex="-1"></a>tb_results_col <span class="ot">&lt;-</span> </span>
<span id="cb66-15"><a href="#cb66-15" aria-hidden="true" tabindex="-1"></a>  tb_results <span class="sc">|&gt;</span> </span>
<span id="cb66-16"><a href="#cb66-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> type, <span class="at">values_from =</span> <span class="fu">c</span>(<span class="st">"X1"</span>, <span class="st">"X2"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In <a href="#fig-comparison-ot-seq-t" class="quarto-xref">Figure&nbsp;<span>4.2</span></a>, we plot observations from the initial group in green Then we add the transported values with sequential transport assuming that <span class="math inline">\(x_2\)</span> is influenced by <span class="math inline">\(x_2\)</span>, in black. Lastly, we plot the transported values using optimal multivariate transport and represent them in red.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>  D_SXY_0<span class="sc">$</span>X1, D_SXY_0<span class="sc">$</span>X2, </span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="st">"#0B775E"</span>, <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">cex =</span> .<span class="dv">5</span>,</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlim =</span> <span class="fu">range</span>(<span class="fu">c</span>(tb_results<span class="sc">$</span>X1, D_SXY_0<span class="sc">$</span>X1)),</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylim =</span> <span class="fu">range</span>(<span class="fu">c</span>(tb_results<span class="sc">$</span>X2, D_SXY_0<span class="sc">$</span>X2), <span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">"X1"</span>, <span class="at">ylab =</span> <span class="st">"X2"</span></span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(</span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a>  tb_results_col<span class="sc">$</span>X1_OT, </span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a>  tb_results_col<span class="sc">$</span>X2_OT, </span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">type =</span> <span class="st">"p"</span>, <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">cex =</span> .<span class="dv">5</span>, <span class="at">col =</span> <span class="st">"#C93312"</span></span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb67-13"><a href="#cb67-13" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(</span>
<span id="cb67-14"><a href="#cb67-14" aria-hidden="true" tabindex="-1"></a>  tb_results_col<span class="sc">$</span>X1_seq_t, tb_results_col<span class="sc">$</span>X2_seq_t, </span>
<span id="cb67-15"><a href="#cb67-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">cex =</span> .<span class="dv">5</span>, <span class="at">col =</span> <span class="st">"black"</span></span>
<span id="cb67-16"><a href="#cb67-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb67-17"><a href="#cb67-17" aria-hidden="true" tabindex="-1"></a><span class="fu">segments</span>(</span>
<span id="cb67-18"><a href="#cb67-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">x0 =</span> D_SXY_0<span class="sc">$</span>X1,</span>
<span id="cb67-19"><a href="#cb67-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">y0 =</span> D_SXY_0<span class="sc">$</span>X2,</span>
<span id="cb67-20"><a href="#cb67-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> tb_results_col<span class="sc">$</span>X1_OT,</span>
<span id="cb67-21"><a href="#cb67-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">y1 =</span> tb_results_col<span class="sc">$</span>X2_OT, <span class="at">col =</span> <span class="fu">alpha</span>(<span class="st">"#C93312"</span>, .<span class="dv">2</span>))</span>
<span id="cb67-22"><a href="#cb67-22" aria-hidden="true" tabindex="-1"></a><span class="fu">segments</span>(</span>
<span id="cb67-23"><a href="#cb67-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">x0 =</span> D_SXY_0<span class="sc">$</span>X1,</span>
<span id="cb67-24"><a href="#cb67-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">y0 =</span> D_SXY_0<span class="sc">$</span>X2,</span>
<span id="cb67-25"><a href="#cb67-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> tb_results_col<span class="sc">$</span>X1_seq_t,</span>
<span id="cb67-26"><a href="#cb67-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">y1 =</span> tb_results_col<span class="sc">$</span>X2_seq_t, <span class="at">col =</span> <span class="fu">alpha</span>(<span class="st">"black"</span>, .<span class="dv">2</span>))</span>
<span id="cb67-27"><a href="#cb67-27" aria-hidden="true" tabindex="-1"></a><span class="fu">segments</span>(</span>
<span id="cb67-28"><a href="#cb67-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">x0 =</span> tb_results_col<span class="sc">$</span>X1_OT,</span>
<span id="cb67-29"><a href="#cb67-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">y0 =</span> tb_results_col<span class="sc">$</span>X2_OT,</span>
<span id="cb67-30"><a href="#cb67-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> tb_results_col<span class="sc">$</span>X1_seq_t,</span>
<span id="cb67-31"><a href="#cb67-31" aria-hidden="true" tabindex="-1"></a>  <span class="at">y1 =</span> tb_results_col<span class="sc">$</span>X2_seq_t, <span class="at">col =</span> <span class="fu">alpha</span>(<span class="st">"gray"</span>, .<span class="dv">3</span>))</span>
<span id="cb67-32"><a href="#cb67-32" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(</span>
<span id="cb67-33"><a href="#cb67-33" aria-hidden="true" tabindex="-1"></a>  <span class="st">"topleft"</span>, <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">"Obs"</span>, <span class="st">"OT"</span>, <span class="st">"Seq. T."</span>),</span>
<span id="cb67-34"><a href="#cb67-34" aria-hidden="true" tabindex="-1"></a>  <span class="at">pch =</span> <span class="dv">19</span>,</span>
<span id="cb67-35"><a href="#cb67-35" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"#0B775E"</span>, <span class="st">"#C93312"</span>, <span class="st">"black"</span>), <span class="at">bty=</span><span class="st">"n"</span></span>
<span id="cb67-36"><a href="#cb67-36" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-comparison-ot-seq-t" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-comparison-ot-seq-t-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.2: Optimal transport and sequential transport with algorithm 3
</figcaption>
<div aria-describedby="fig-comparison-ot-seq-t-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="algorithm-5_files/figure-html/fig-comparison-ot-seq-t-1.png" class="img-fluid figure-img" width="384">
</div>
</figure>
</div>
</div>
</div>
<p>We can visualize the distance of each transported individual depending on the method used to create them.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>  tb_results_col<span class="sc">$</span>X1_OT, tb_results_col<span class="sc">$</span>X2_OT, </span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="st">"#C93312"</span>, <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">cex =</span> .<span class="dv">5</span>,</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlim =</span> <span class="fu">range</span>(<span class="fu">c</span>(tb_results<span class="sc">$</span>X1, D_SXY_0<span class="sc">$</span>X1)),</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylim =</span> <span class="fu">range</span>(<span class="fu">c</span>(tb_results<span class="sc">$</span>X2, D_SXY_0<span class="sc">$</span>X2), <span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">"X1"</span>, <span class="at">ylab =</span> <span class="st">"X2"</span></span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(</span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>  tb_results_col<span class="sc">$</span>X1_seq_t, tb_results_col<span class="sc">$</span>X2_seq_t, </span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">cex =</span> .<span class="dv">5</span>, <span class="at">col =</span> <span class="st">"black"</span></span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a><span class="fu">segments</span>(</span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">x0 =</span> tb_results_col<span class="sc">$</span>X1_OT,</span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">y0 =</span> tb_results_col<span class="sc">$</span>X2_OT,</span>
<span id="cb68-15"><a href="#cb68-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> tb_results_col<span class="sc">$</span>X1_seq_t,</span>
<span id="cb68-16"><a href="#cb68-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">y1 =</span> tb_results_col<span class="sc">$</span>X2_seq_t, <span class="at">col =</span> <span class="fu">alpha</span>(<span class="st">"black"</span>, .<span class="dv">3</span>)</span>
<span id="cb68-17"><a href="#cb68-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb68-18"><a href="#cb68-18" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(</span>
<span id="cb68-19"><a href="#cb68-19" aria-hidden="true" tabindex="-1"></a>  <span class="st">"topleft"</span>, <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">"OT"</span>, <span class="st">"Seq. T."</span>),</span>
<span id="cb68-20"><a href="#cb68-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">pch =</span> <span class="dv">19</span>,</span>
<span id="cb68-21"><a href="#cb68-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"#C93312"</span>, <span class="st">"black"</span>), <span class="at">bty=</span><span class="st">"n"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-comparison-ot-seq-t-without-obs" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-comparison-ot-seq-t-without-obs-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.3: Comparison of Optimal transport and sequential transport
</figcaption>
<div aria-describedby="fig-comparison-ot-seq-t-without-obs-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="algorithm-5_files/figure-html/fig-comparison-ot-seq-t-without-obs-1.png" class="img-fluid figure-img" width="384">
</div>
</figure>
</div>
</div>
</div>
<p>Let us compare the bivariate estimated densities.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Computation of smoothing parameters (bandwidth) for kernel density estimation</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>H0 <span class="ot">&lt;-</span> <span class="fu">Hpi</span>(D_SXY0[, <span class="fu">c</span>(<span class="st">"X1"</span>, <span class="st">"X2"</span>)])</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>H1 <span class="ot">&lt;-</span> <span class="fu">Hpi</span>(D_SXY1[, <span class="fu">c</span>(<span class="st">"X1"</span>, <span class="st">"X2"</span>)])</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>H1_OT <span class="ot">&lt;-</span> <span class="fu">Hpi</span>(transport_ot)</span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>transport_seq <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">X1 =</span> transported<span class="sc">$</span>transported<span class="sc">$</span>X1,</span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">X2 =</span> transported<span class="sc">$</span>transported<span class="sc">$</span>X2</span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a>H1_SEQ <span class="ot">&lt;-</span> <span class="fu">Hpi</span>(transport_seq)</span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculating multivariate densities in each group S=0 and S=1</span></span>
<span id="cb69-14"><a href="#cb69-14" aria-hidden="true" tabindex="-1"></a>f0_2d <span class="ot">&lt;-</span> <span class="fu">kde</span>(D_SXY0[, <span class="fu">c</span>(<span class="st">"X1"</span>, <span class="st">"X2"</span>)], <span class="at">H =</span> H0, <span class="at">xmin =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">5</span>, <span class="sc">-</span><span class="dv">5</span>), <span class="at">xmax =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">5</span>))</span>
<span id="cb69-15"><a href="#cb69-15" aria-hidden="true" tabindex="-1"></a>f1_2d <span class="ot">&lt;-</span> <span class="fu">kde</span>(D_SXY1[, <span class="fu">c</span>(<span class="st">"X1"</span>, <span class="st">"X2"</span>)], <span class="at">H =</span> H1, <span class="at">xmin =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">5</span>, <span class="sc">-</span><span class="dv">5</span>), <span class="at">xmax =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">5</span>))</span>
<span id="cb69-16"><a href="#cb69-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-17"><a href="#cb69-17" aria-hidden="true" tabindex="-1"></a>f1_2d_OT <span class="ot">&lt;-</span> <span class="fu">kde</span>(transport_ot, <span class="at">H =</span> H1_OT, <span class="at">xmin =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">5</span>, <span class="sc">-</span><span class="dv">5</span>), <span class="at">xmax =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">5</span>))</span>
<span id="cb69-18"><a href="#cb69-18" aria-hidden="true" tabindex="-1"></a>f1_2d_SEQ <span class="ot">&lt;-</span> <span class="fu">kde</span>(transport_seq, <span class="at">H =</span> H1_SEQ, <span class="at">xmin =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">5</span>, <span class="sc">-</span><span class="dv">5</span>), <span class="at">xmax =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">5</span>))</span>
<span id="cb69-19"><a href="#cb69-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-20"><a href="#cb69-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Plotting densities</span></span>
<span id="cb69-21"><a href="#cb69-21" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">2</span>,<span class="dv">0</span>,<span class="dv">0</span>))</span>
<span id="cb69-22"><a href="#cb69-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Group S=0</span></span>
<span id="cb69-23"><a href="#cb69-23" aria-hidden="true" tabindex="-1"></a><span class="fu">contour</span>(</span>
<span id="cb69-24"><a href="#cb69-24" aria-hidden="true" tabindex="-1"></a>  f0_2d<span class="sc">$</span>eval.point[[<span class="dv">1</span>]], f0_2d<span class="sc">$</span>eval.point[[<span class="dv">2</span>]], f0_2d<span class="sc">$</span>estimate, </span>
<span id="cb69-25"><a href="#cb69-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> colours[<span class="st">"A"</span>], <span class="at">axes =</span> <span class="cn">FALSE</span>, <span class="at">xlab =</span> <span class="st">""</span>, <span class="at">ylab =</span> <span class="st">""</span></span>
<span id="cb69-26"><a href="#cb69-26" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb69-27"><a href="#cb69-27" aria-hidden="true" tabindex="-1"></a><span class="fu">axis</span>(<span class="dv">1</span>)</span>
<span id="cb69-28"><a href="#cb69-28" aria-hidden="true" tabindex="-1"></a><span class="fu">axis</span>(<span class="dv">2</span>)</span>
<span id="cb69-29"><a href="#cb69-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Group S=1</span></span>
<span id="cb69-30"><a href="#cb69-30" aria-hidden="true" tabindex="-1"></a><span class="fu">contour</span>(</span>
<span id="cb69-31"><a href="#cb69-31" aria-hidden="true" tabindex="-1"></a>  f1_2d<span class="sc">$</span>eval.point[[<span class="dv">1</span>]], f1_2d<span class="sc">$</span>eval.point[[<span class="dv">2</span>]], f1_2d<span class="sc">$</span>estimate, </span>
<span id="cb69-32"><a href="#cb69-32" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> colours[<span class="st">"B"</span>], <span class="at">add =</span> <span class="cn">TRUE</span></span>
<span id="cb69-33"><a href="#cb69-33" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb69-34"><a href="#cb69-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-35"><a href="#cb69-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Group S=1, Optimal transport</span></span>
<span id="cb69-36"><a href="#cb69-36" aria-hidden="true" tabindex="-1"></a><span class="fu">contour</span>(</span>
<span id="cb69-37"><a href="#cb69-37" aria-hidden="true" tabindex="-1"></a>  f1_2d_OT<span class="sc">$</span>eval.point[[<span class="dv">1</span>]], f1_2d_OT<span class="sc">$</span>eval.point[[<span class="dv">2</span>]], f1_2d_OT<span class="sc">$</span>estimate, </span>
<span id="cb69-38"><a href="#cb69-38" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="st">"#C93312"</span>, <span class="at">add =</span> <span class="cn">TRUE</span></span>
<span id="cb69-39"><a href="#cb69-39" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb69-40"><a href="#cb69-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-41"><a href="#cb69-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Group S=1, Sequential transport</span></span>
<span id="cb69-42"><a href="#cb69-42" aria-hidden="true" tabindex="-1"></a><span class="fu">contour</span>(</span>
<span id="cb69-43"><a href="#cb69-43" aria-hidden="true" tabindex="-1"></a>  f1_2d_SEQ<span class="sc">$</span>eval.point[[<span class="dv">1</span>]], f1_2d_SEQ<span class="sc">$</span>eval.point[[<span class="dv">2</span>]], f1_2d_SEQ<span class="sc">$</span>estimate, </span>
<span id="cb69-44"><a href="#cb69-44" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="st">"black"</span>, <span class="at">add =</span> <span class="cn">TRUE</span></span>
<span id="cb69-45"><a href="#cb69-45" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb69-46"><a href="#cb69-46" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(</span>
<span id="cb69-47"><a href="#cb69-47" aria-hidden="true" tabindex="-1"></a>  <span class="st">"topleft"</span>, <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">"Obs S=0"</span>, <span class="st">"Obs S=1"</span>, <span class="st">"OT"</span>, <span class="st">"Seq. T."</span>),</span>
<span id="cb69-48"><a href="#cb69-48" aria-hidden="true" tabindex="-1"></a>  <span class="at">lty=</span><span class="dv">1</span>,</span>
<span id="cb69-49"><a href="#cb69-49" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="fu">c</span>(colours[<span class="st">"A"</span>], colours[<span class="st">"B"</span>], <span class="st">"#C93312"</span>, <span class="st">"black"</span>), <span class="at">bty=</span><span class="st">"n"</span></span>
<span id="cb69-50"><a href="#cb69-50" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-comparison-ot-seq-t-density" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-comparison-ot-seq-t-density-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.4: Estimated densities in both groups, and in the target group using counterfactuals obtained with either optimal transport or sequential transport (moving first <span class="math inline">\(x_1\)</span>, then <span class="math inline">\(x_2\)</span>).
</figcaption>
<div aria-describedby="fig-comparison-ot-seq-t-density-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="algorithm-5_files/figure-html/fig-comparison-ot-seq-t-density-1.png" class="img-fluid figure-img" width="384">
</div>
</figure>
</div>
</div>
</div>
</section>
<section id="transport-of-a-new-individual" class="level2" data-number="4.6">
<h2 data-number="4.6" class="anchored" data-anchor-id="transport-of-a-new-individual"><span class="header-section-number">4.6</span> Transport of a New Individual</h2>
<p>To transport a new individual, to avoid estimating again all the empirical cumulative distribution functions, we adopt a simple strategy. To move the <span class="math inline">\(j\)</span>-th coordinate of an individual from the source group to the target group, we use the estimated value of the ecdf of the individual in the initial dataset (only in the source group) which is the closest (with respect to the Euclidean distance). If the <span class="math inline">\(j\)</span>-th characteristic is categorical, we draw the class to create the “transported” value, as in the previous function.</p>
<p>We define a new function to do so.</p>
<div class="cell">
<details class="code-fold">
<summary>R code for the <code class="sourceCode r"><span class="fu">seq_trans_new</span>()</code> function.</summary>
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Sequential Transport of New Observations Using a Pre-Defined Causal Graph</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' This function transports new observations from the source group to the target</span></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' group, using the mappings previously learned when evaluating the</span></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' `seq_transport_binary()` function.</span></span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param x Object containing previously transported values, obtained with</span></span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a><span class="co">#'        `seq_transport_binary()`.</span></span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param newdata New data with observations from initial group to transport.</span></span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param data Data used during the construction of counterfactuals with</span></span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a><span class="co">#'        `seq_transport_binary()`.</span></span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a><span class="co">#' @export</span></span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a><span class="co">#' @returns A list with the transported values. Each element contains the</span></span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true" tabindex="-1"></a><span class="co">#'          transported values of a variable.</span></span>
<span id="cb70-15"><a href="#cb70-15" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb70-16"><a href="#cb70-16" aria-hidden="true" tabindex="-1"></a><span class="co">#' @importFrom stats predict quantile</span></span>
<span id="cb70-17"><a href="#cb70-17" aria-hidden="true" tabindex="-1"></a><span class="co">#' @importFrom dplyr across filter mutate pull select</span></span>
<span id="cb70-18"><a href="#cb70-18" aria-hidden="true" tabindex="-1"></a><span class="co">#' @importFrom purrr map_dbl</span></span>
<span id="cb70-19"><a href="#cb70-19" aria-hidden="true" tabindex="-1"></a><span class="co">#' @importFrom rlang sym !! :=</span></span>
<span id="cb70-20"><a href="#cb70-20" aria-hidden="true" tabindex="-1"></a><span class="co">#' @importFrom cluster daisy</span></span>
<span id="cb70-21"><a href="#cb70-21" aria-hidden="true" tabindex="-1"></a><span class="co">#' @importFrom Hmisc wtd.quantile</span></span>
<span id="cb70-22"><a href="#cb70-22" aria-hidden="true" tabindex="-1"></a><span class="co">#' @importFrom nnet multinom</span></span>
<span id="cb70-23"><a href="#cb70-23" aria-hidden="true" tabindex="-1"></a>seq_trans_new <span class="ot">&lt;-</span> <span class="cf">function</span>(x,</span>
<span id="cb70-24"><a href="#cb70-24" aria-hidden="true" tabindex="-1"></a>                          newdata,</span>
<span id="cb70-25"><a href="#cb70-25" aria-hidden="true" tabindex="-1"></a>                          data) {</span>
<span id="cb70-26"><a href="#cb70-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-27"><a href="#cb70-27" aria-hidden="true" tabindex="-1"></a>  top_order <span class="ot">&lt;-</span> x<span class="sc">$</span>params<span class="sc">$</span>top_order</span>
<span id="cb70-28"><a href="#cb70-28" aria-hidden="true" tabindex="-1"></a>  s <span class="ot">&lt;-</span> x<span class="sc">$</span>params<span class="sc">$</span>s</span>
<span id="cb70-29"><a href="#cb70-29" aria-hidden="true" tabindex="-1"></a>  S_0 <span class="ot">&lt;-</span> x<span class="sc">$</span>params<span class="sc">$</span>S_0</span>
<span id="cb70-30"><a href="#cb70-30" aria-hidden="true" tabindex="-1"></a>  y <span class="ot">&lt;-</span> x<span class="sc">$</span>params<span class="sc">$</span>y</span>
<span id="cb70-31"><a href="#cb70-31" aria-hidden="true" tabindex="-1"></a>  adj <span class="ot">&lt;-</span> x<span class="sc">$</span>params<span class="sc">$</span>adj</span>
<span id="cb70-32"><a href="#cb70-32" aria-hidden="true" tabindex="-1"></a>  num_neighbors <span class="ot">&lt;-</span> x<span class="sc">$</span>params<span class="sc">$</span>num_neighbors</span>
<span id="cb70-33"><a href="#cb70-33" aria-hidden="true" tabindex="-1"></a>  variables <span class="ot">&lt;-</span> top_order[<span class="sc">!</span>top_order <span class="sc">%in%</span> <span class="fu">c</span>(s, y)]</span>
<span id="cb70-34"><a href="#cb70-34" aria-hidden="true" tabindex="-1"></a>  newdata_0 <span class="ot">&lt;-</span> newdata <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="sc">!!</span><span class="fu">sym</span>(s) <span class="sc">==</span> <span class="sc">!!</span>S_0)</span>
<span id="cb70-35"><a href="#cb70-35" aria-hidden="true" tabindex="-1"></a>  data_0 <span class="ot">&lt;-</span> data <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="sc">!!</span><span class="fu">sym</span>(s) <span class="sc">==</span> <span class="sc">!!</span>S_0)</span>
<span id="cb70-36"><a href="#cb70-36" aria-hidden="true" tabindex="-1"></a>  data_1 <span class="ot">&lt;-</span> data <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="sc">!!</span><span class="fu">sym</span>(s) <span class="sc">!=</span> <span class="sc">!!</span>S_0)</span>
<span id="cb70-37"><a href="#cb70-37" aria-hidden="true" tabindex="-1"></a>  list_ecdf <span class="ot">&lt;-</span> x<span class="sc">$</span>ecdf</span>
<span id="cb70-38"><a href="#cb70-38" aria-hidden="true" tabindex="-1"></a>  list_ecdf_values <span class="ot">&lt;-</span> x<span class="sc">$</span>ecdf_values</span>
<span id="cb70-39"><a href="#cb70-39" aria-hidden="true" tabindex="-1"></a>  fit_for_categ <span class="ot">&lt;-</span> x<span class="sc">$</span>fit_for_categ</span>
<span id="cb70-40"><a href="#cb70-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-41"><a href="#cb70-41" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Lists where results will be stored</span></span>
<span id="cb70-42"><a href="#cb70-42" aria-hidden="true" tabindex="-1"></a>  list_transported <span class="ot">&lt;-</span> <span class="fu">list</span>()  <span class="co"># Transported values</span></span>
<span id="cb70-43"><a href="#cb70-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-44"><a href="#cb70-44" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (x_name <span class="cf">in</span> variables) {</span>
<span id="cb70-45"><a href="#cb70-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Names of the parent variables</span></span>
<span id="cb70-46"><a href="#cb70-46" aria-hidden="true" tabindex="-1"></a>    parents <span class="ot">&lt;-</span> <span class="fu">colnames</span>(adj)[adj[, x_name] <span class="sc">==</span> <span class="dv">1</span>]</span>
<span id="cb70-47"><a href="#cb70-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># values of current x in each group</span></span>
<span id="cb70-48"><a href="#cb70-48" aria-hidden="true" tabindex="-1"></a>    x_S0 <span class="ot">&lt;-</span> newdata <span class="sc">|&gt;</span> <span class="fu">pull</span>(<span class="sc">!!</span>x_name)</span>
<span id="cb70-49"><a href="#cb70-49" aria-hidden="true" tabindex="-1"></a>    x_S0_initial <span class="ot">&lt;-</span> data_0 <span class="sc">|&gt;</span> <span class="fu">pull</span>(<span class="sc">!!</span>x_name)</span>
<span id="cb70-50"><a href="#cb70-50" aria-hidden="true" tabindex="-1"></a>    x_S1 <span class="ot">&lt;-</span> data_1 <span class="sc">|&gt;</span> <span class="fu">pull</span>(<span class="sc">!!</span>x_name)</span>
<span id="cb70-51"><a href="#cb70-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check whether X is numeric</span></span>
<span id="cb70-52"><a href="#cb70-52" aria-hidden="true" tabindex="-1"></a>    is_x_num <span class="ot">&lt;-</span> <span class="fu">is.numeric</span>(x_S0)</span>
<span id="cb70-53"><a href="#cb70-53" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Characteristics of the parent variables (if any)</span></span>
<span id="cb70-54"><a href="#cb70-54" aria-hidden="true" tabindex="-1"></a>    parents_characteristics <span class="ot">&lt;-</span> newdata_0 <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">!!</span>parents, <span class="sc">-!!</span>s)</span>
<span id="cb70-55"><a href="#cb70-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-56"><a href="#cb70-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">length</span>(parents_characteristics) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb70-57"><a href="#cb70-57" aria-hidden="true" tabindex="-1"></a>      newdata_0_parents <span class="ot">&lt;-</span> newdata_0 <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">!!</span>parents) <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">-!!</span>s)</span>
<span id="cb70-58"><a href="#cb70-58" aria-hidden="true" tabindex="-1"></a>      data_0_parents <span class="ot">&lt;-</span> data_0 <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">!!</span>parents) <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">-!!</span>s)</span>
<span id="cb70-59"><a href="#cb70-59" aria-hidden="true" tabindex="-1"></a>      data_1_parents <span class="ot">&lt;-</span> data_1 <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">!!</span>parents) <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">-!!</span>s)</span>
<span id="cb70-60"><a href="#cb70-60" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Weights in S_0</span></span>
<span id="cb70-61"><a href="#cb70-61" aria-hidden="true" tabindex="-1"></a>      weights_S0 <span class="ot">&lt;-</span> x<span class="sc">$</span>weights[[x_name]]<span class="sc">$</span>w_S0<span class="sc">$</span>weights</span>
<span id="cb70-62"><a href="#cb70-62" aria-hidden="true" tabindex="-1"></a>      tot_weights_S0 <span class="ot">&lt;-</span> x<span class="sc">$</span>weights[[x_name]]<span class="sc">$</span>w_S0<span class="sc">$</span>tot_weights</span>
<span id="cb70-63"><a href="#cb70-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-64"><a href="#cb70-64" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Weights in S_1</span></span>
<span id="cb70-65"><a href="#cb70-65" aria-hidden="true" tabindex="-1"></a>      <span class="co"># First, we need to get the transported values for the parents, if necessary</span></span>
<span id="cb70-66"><a href="#cb70-66" aria-hidden="true" tabindex="-1"></a>      newdata_0_parents_t <span class="ot">&lt;-</span> newdata_0_parents <span class="co">#init</span></span>
<span id="cb70-67"><a href="#cb70-67" aria-hidden="true" tabindex="-1"></a>      data_0_parents_t <span class="ot">&lt;-</span> data_0_parents <span class="co">#init</span></span>
<span id="cb70-68"><a href="#cb70-68" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (parent <span class="cf">in</span> parents) {</span>
<span id="cb70-69"><a href="#cb70-69" aria-hidden="true" tabindex="-1"></a>        <span class="co"># does the parent depend on the sensitive variable</span></span>
<span id="cb70-70"><a href="#cb70-70" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (parent <span class="sc">%in%</span> <span class="fu">names</span>(list_transported)) {</span>
<span id="cb70-71"><a href="#cb70-71" aria-hidden="true" tabindex="-1"></a>          newdata_0_parents_t <span class="ot">&lt;-</span></span>
<span id="cb70-72"><a href="#cb70-72" aria-hidden="true" tabindex="-1"></a>            newdata_0_parents_t <span class="sc">|&gt;</span></span>
<span id="cb70-73"><a href="#cb70-73" aria-hidden="true" tabindex="-1"></a>            <span class="fu">mutate</span>(<span class="sc">!!</span><span class="fu">sym</span>(parent) <span class="sc">:</span><span class="er">=</span> list_transported[[parent]])</span>
<span id="cb70-74"><a href="#cb70-74" aria-hidden="true" tabindex="-1"></a>          data_0_parents_t <span class="ot">&lt;-</span></span>
<span id="cb70-75"><a href="#cb70-75" aria-hidden="true" tabindex="-1"></a>            data_0_parents_t <span class="sc">|&gt;</span></span>
<span id="cb70-76"><a href="#cb70-76" aria-hidden="true" tabindex="-1"></a>            <span class="fu">mutate</span>(<span class="sc">!!</span><span class="fu">sym</span>(parent) <span class="sc">:</span><span class="er">=</span> x<span class="sc">$</span>transported[[parent]])</span>
<span id="cb70-77"><a href="#cb70-77" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb70-78"><a href="#cb70-78" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb70-79"><a href="#cb70-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-80"><a href="#cb70-80" aria-hidden="true" tabindex="-1"></a>      combined <span class="ot">&lt;-</span> <span class="fu">rbind</span>(newdata_0_parents_t, data_1_parents)</span>
<span id="cb70-81"><a href="#cb70-81" aria-hidden="true" tabindex="-1"></a>      gower_dist <span class="ot">&lt;-</span> <span class="fu">daisy</span>(combined, <span class="at">metric =</span> <span class="st">"gower"</span>)</span>
<span id="cb70-82"><a href="#cb70-82" aria-hidden="true" tabindex="-1"></a>      gower_matrix <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(gower_dist)</span>
<span id="cb70-83"><a href="#cb70-83" aria-hidden="true" tabindex="-1"></a>      n_0 <span class="ot">&lt;-</span> <span class="fu">nrow</span>(newdata_0_parents_t)</span>
<span id="cb70-84"><a href="#cb70-84" aria-hidden="true" tabindex="-1"></a>      n_1 <span class="ot">&lt;-</span> <span class="fu">nrow</span>(data_1_parents)</span>
<span id="cb70-85"><a href="#cb70-85" aria-hidden="true" tabindex="-1"></a>      weights_S1 <span class="ot">&lt;-</span> gower_matrix[<span class="dv">1</span><span class="sc">:</span>n_0, (n_0 <span class="sc">+</span> <span class="dv">1</span>)<span class="sc">:</span>(n_0 <span class="sc">+</span> n_1), drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb70-86"><a href="#cb70-86" aria-hidden="true" tabindex="-1"></a>      weights_S1 <span class="ot">&lt;-</span> weights_S1 <span class="sc">+</span> <span class="fl">1e-8</span></span>
<span id="cb70-87"><a href="#cb70-87" aria-hidden="true" tabindex="-1"></a>      weights_S1 <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> (weights_S1)<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb70-88"><a href="#cb70-88" aria-hidden="true" tabindex="-1"></a>      tot_weights_S1 <span class="ot">&lt;-</span> <span class="fu">apply</span>(weights_S1, <span class="at">MARGIN =</span> <span class="dv">1</span>, sum)</span>
<span id="cb70-89"><a href="#cb70-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-90"><a href="#cb70-90" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (is_x_num <span class="sc">==</span> <span class="cn">TRUE</span>) {</span>
<span id="cb70-91"><a href="#cb70-91" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Find the closest point in S0 with respect to the current variable</span></span>
<span id="cb70-92"><a href="#cb70-92" aria-hidden="true" tabindex="-1"></a>        closest_indices <span class="ot">&lt;-</span> <span class="fu">map_dbl</span>(x_S0, <span class="sc">~</span><span class="fu">which.min</span>(<span class="fu">abs</span>(x_S0_initial <span class="sc">-</span> .x)))</span>
<span id="cb70-93"><a href="#cb70-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-94"><a href="#cb70-94" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Numerical variable to transport</span></span>
<span id="cb70-95"><a href="#cb70-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-96"><a href="#cb70-96" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Empirical distribution function</span></span>
<span id="cb70-97"><a href="#cb70-97" aria-hidden="true" tabindex="-1"></a>        f <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">length</span>(x_S0))</span>
<span id="cb70-98"><a href="#cb70-98" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(x_S0)) {</span>
<span id="cb70-99"><a href="#cb70-99" aria-hidden="true" tabindex="-1"></a>          ind_closest <span class="ot">&lt;-</span> closest_indices[i]</span>
<span id="cb70-100"><a href="#cb70-100" aria-hidden="true" tabindex="-1"></a>          f[i] <span class="ot">&lt;-</span> weights_S0[ind_closest, ] <span class="sc">%*%</span> (x_S0_initial <span class="sc">&lt;=</span> x_S0_initial[ind_closest]) <span class="sc">/</span> tot_weights_S0[ind_closest]</span>
<span id="cb70-101"><a href="#cb70-101" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb70-102"><a href="#cb70-102" aria-hidden="true" tabindex="-1"></a>        f[f<span class="sc">==</span><span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">-</span>(<span class="fl">1e-8</span>)</span>
<span id="cb70-103"><a href="#cb70-103" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Transported values</span></span>
<span id="cb70-104"><a href="#cb70-104" aria-hidden="true" tabindex="-1"></a>        transported <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, <span class="fu">length</span>(x_S0))</span>
<span id="cb70-105"><a href="#cb70-105" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(x_S0)) {</span>
<span id="cb70-106"><a href="#cb70-106" aria-hidden="true" tabindex="-1"></a>          wts <span class="ot">&lt;-</span> weights_S1[i, ]</span>
<span id="cb70-107"><a href="#cb70-107" aria-hidden="true" tabindex="-1"></a>          <span class="co"># Give weights to the 5 closests points only</span></span>
<span id="cb70-108"><a href="#cb70-108" aria-hidden="true" tabindex="-1"></a>          wts[<span class="sc">-</span><span class="fu">order</span>(wts, <span class="at">decreasing =</span> <span class="cn">TRUE</span>)[<span class="dv">1</span><span class="sc">:</span>num_neighbors]] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb70-109"><a href="#cb70-109" aria-hidden="true" tabindex="-1"></a>          transported[i] <span class="ot">&lt;-</span> Hmisc<span class="sc">::</span><span class="fu">wtd.quantile</span>(</span>
<span id="cb70-110"><a href="#cb70-110" aria-hidden="true" tabindex="-1"></a>            <span class="at">x =</span> x_S1, <span class="at">weights =</span> weights_S1[i, ], <span class="at">probs =</span> f[i]</span>
<span id="cb70-111"><a href="#cb70-111" aria-hidden="true" tabindex="-1"></a>          )</span>
<span id="cb70-112"><a href="#cb70-112" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb70-113"><a href="#cb70-113" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb70-114"><a href="#cb70-114" aria-hidden="true" tabindex="-1"></a>        <span class="co"># X is non numeric and has parents</span></span>
<span id="cb70-115"><a href="#cb70-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-116"><a href="#cb70-116" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Retrieve fitted model (categorical variable given the characteristics</span></span>
<span id="cb70-117"><a href="#cb70-117" aria-hidden="true" tabindex="-1"></a>        <span class="co"># of the parents in group to transport into)</span></span>
<span id="cb70-118"><a href="#cb70-118" aria-hidden="true" tabindex="-1"></a>        fit_indix_x <span class="ot">&lt;-</span> fit_for_categ[[x_name]]</span>
<span id="cb70-119"><a href="#cb70-119" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Predictions with that model for transported parents</span></span>
<span id="cb70-120"><a href="#cb70-120" aria-hidden="true" tabindex="-1"></a>        pred_probs <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit_indix_x, <span class="at">type =</span> <span class="st">"probs"</span>, <span class="at">newdata =</span> newdata_0_parents_t)</span>
<span id="cb70-121"><a href="#cb70-121" aria-hidden="true" tabindex="-1"></a>        <span class="co"># For each observation, random draw of the class, using the pred probs</span></span>
<span id="cb70-122"><a href="#cb70-122" aria-hidden="true" tabindex="-1"></a>        <span class="co"># as weights</span></span>
<span id="cb70-123"><a href="#cb70-123" aria-hidden="true" tabindex="-1"></a>        drawn_class <span class="ot">&lt;-</span> <span class="fu">apply</span>(</span>
<span id="cb70-124"><a href="#cb70-124" aria-hidden="true" tabindex="-1"></a>          pred_probs, <span class="dv">1</span>,</span>
<span id="cb70-125"><a href="#cb70-125" aria-hidden="true" tabindex="-1"></a>          <span class="cf">function</span>(x) <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">ncol</span>(pred_probs), <span class="at">prob =</span> x, <span class="at">size =</span> <span class="dv">1</span>)</span>
<span id="cb70-126"><a href="#cb70-126" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb70-127"><a href="#cb70-127" aria-hidden="true" tabindex="-1"></a>        transported <span class="ot">&lt;-</span> <span class="fu">colnames</span>(pred_probs)[drawn_class]</span>
<span id="cb70-128"><a href="#cb70-128" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">is.factor</span>(x_S1)) {</span>
<span id="cb70-129"><a href="#cb70-129" aria-hidden="true" tabindex="-1"></a>          transported <span class="ot">&lt;-</span> <span class="fu">factor</span>(transported, <span class="at">levels =</span> <span class="fu">levels</span>(x_S1))</span>
<span id="cb70-130"><a href="#cb70-130" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb70-131"><a href="#cb70-131" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb70-132"><a href="#cb70-132" aria-hidden="true" tabindex="-1"></a>      list_transported[[x_name]] <span class="ot">&lt;-</span> transported</span>
<span id="cb70-133"><a href="#cb70-133" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb70-134"><a href="#cb70-134" aria-hidden="true" tabindex="-1"></a>      <span class="co"># No parents</span></span>
<span id="cb70-135"><a href="#cb70-135" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (is_x_num <span class="sc">==</span> <span class="cn">TRUE</span>) {</span>
<span id="cb70-136"><a href="#cb70-136" aria-hidden="true" tabindex="-1"></a>        <span class="co"># X is numerical and has no parents</span></span>
<span id="cb70-137"><a href="#cb70-137" aria-hidden="true" tabindex="-1"></a>        F_X_S0 <span class="ot">&lt;-</span> list_ecdf[[x_name]]</span>
<span id="cb70-138"><a href="#cb70-138" aria-hidden="true" tabindex="-1"></a>        f <span class="ot">&lt;-</span> <span class="fu">F_X_S0</span>(x_S0)</span>
<span id="cb70-139"><a href="#cb70-139" aria-hidden="true" tabindex="-1"></a>        transported <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">quantile</span>(x_S1, <span class="at">probs =</span> f))</span>
<span id="cb70-140"><a href="#cb70-140" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb70-141"><a href="#cb70-141" aria-hidden="true" tabindex="-1"></a>        <span class="co"># X is not numerical and has no parents</span></span>
<span id="cb70-142"><a href="#cb70-142" aria-hidden="true" tabindex="-1"></a>        transported <span class="ot">&lt;-</span> <span class="fu">sample</span>(x_S1, <span class="at">size =</span> <span class="fu">length</span>(x_S0), <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb70-143"><a href="#cb70-143" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">is.factor</span>(x_S1)) {</span>
<span id="cb70-144"><a href="#cb70-144" aria-hidden="true" tabindex="-1"></a>          transported <span class="ot">&lt;-</span> <span class="fu">factor</span>(transported, <span class="at">levels =</span> <span class="fu">levels</span>(x_S1))</span>
<span id="cb70-145"><a href="#cb70-145" aria-hidden="true" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb70-146"><a href="#cb70-146" aria-hidden="true" tabindex="-1"></a>          transported <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(transported)</span>
<span id="cb70-147"><a href="#cb70-147" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb70-148"><a href="#cb70-148" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb70-149"><a href="#cb70-149" aria-hidden="true" tabindex="-1"></a>      list_transported[[x_name]] <span class="ot">&lt;-</span> transported</span>
<span id="cb70-150"><a href="#cb70-150" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb70-151"><a href="#cb70-151" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb70-152"><a href="#cb70-152" aria-hidden="true" tabindex="-1"></a>  list_transported</span>
<span id="cb70-153"><a href="#cb70-153" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We will transport the following individual.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>new_obs <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">X1 =</span> <span class="sc">-</span><span class="dv">2</span>, <span class="at">X2 =</span> <span class="sc">-</span><span class="dv">1</span>, <span class="at">S =</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="optimal-transport-1" class="level3" data-number="4.6.1">
<h3 data-number="4.6.1" class="anchored" data-anchor-id="optimal-transport-1"><span class="header-section-number">4.6.1</span> Optimal Transport</h3>
<p>Since we have previously defined the optimal transport function for our simulated data (drawn from a bivariate Gaussian distribution), we can apply the mapping to our new individual.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>new_obs_ot <span class="ot">&lt;-</span> <span class="fu">t</span>(<span class="fu">apply</span>(new_obs[, <span class="fu">c</span>(<span class="st">"X1"</span>, <span class="st">"X2"</span>)], <span class="dv">1</span>, OT))</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>new_obs_ot</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          [,1]     [,2]
[1,] 0.6353342 1.890324</code></pre>
</div>
</div>
</section>
<section id="sequential-transport" class="level3" data-number="4.6.2">
<h3 data-number="4.6.2" class="anchored" data-anchor-id="sequential-transport"><span class="header-section-number">4.6.2</span> Sequential Transport</h3>
<p>Now, let us consider two cases:</p>
<ol type="1">
<li>Transport first X1 then X2.</li>
<li>Transport first X2 then X1.</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>variables <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"S"</span>, <span class="st">"X1"</span>, <span class="st">"X2"</span>, <span class="st">"S"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="x1-then-x2" class="level4" data-number="4.6.2.1">
<h4 data-number="4.6.2.1" class="anchored" data-anchor-id="x1-then-x2"><span class="header-section-number">4.6.2.1</span> X1 then X2</h4>
<p>The adjacency matrix:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>adj_1 <span class="ot">&lt;-</span> <span class="fu">matrix</span>(</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># S  X1 X2 Y</span></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>,<span class="co"># S</span></span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>    <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>,<span class="co"># X1</span></span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>    <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>,<span class="co"># X2</span></span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>    <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>  <span class="co"># Y</span></span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">ncol =</span> <span class="fu">length</span>(variables),</span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">dimnames =</span> <span class="fu">rep</span>(<span class="fu">list</span>(variables), <span class="dv">2</span>),</span>
<span id="cb75-10"><a href="#cb75-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">byrow =</span> <span class="cn">TRUE</span></span>
<span id="cb75-11"><a href="#cb75-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The causal graph:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>causal_graph_1 <span class="ot">&lt;-</span> fairadapt<span class="sc">::</span><span class="fu">graphModel</span>(adj_1)</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(causal_graph_1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-causal-graph-1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-causal-graph-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.5: Assumed Causal Graph
</figcaption>
<div aria-describedby="fig-causal-graph-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="algorithm-5_files/figure-html/fig-causal-graph-1-1.png" class="img-fluid figure-img" width="672">
</div>
</figure>
</div>
</div>
</div>
<p>We can then use our <code class="sourceCode r"><span class="fu">seq_trans</span>()</code> to first learn the mapping.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>trans_x1_then_x2 <span class="ot">&lt;-</span> <span class="fu">seq_trans</span>(</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> D_SXY, <span class="at">adj =</span> adj_1, <span class="at">s =</span> <span class="st">"S"</span>, <span class="at">S_0 =</span> <span class="dv">0</span>, <span class="at">y =</span> <span class="st">"Y"</span></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Transporting  X1 
Transporting  X2 </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in Hmisc::wtd.quantile(x = x_S1, weights = weights_S1[i, ], probs =
f[i]): probable complete loss of accuracy in modulus</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in regularize.values(x, y, ties, missing(ties), na.rm = na.rm):
collapsing to unique 'x' values</code></pre>
</div>
</div>
<p>Using the learned mapping, we can transport our new individual, thanks to our <code class="sourceCode r"><span class="fu">seq_trans_new</span>()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>new_obs_x1_then_x2 <span class="ot">&lt;-</span> <span class="fu">seq_trans_new</span>(</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> trans_x1_then_x2, <span class="at">newdata =</span> new_obs, <span class="at">data =</span> D_SXY</span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>new_obs_x1_then_x2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$X1
[1] 0.607805

$X2
[1] 2.32019</code></pre>
</div>
</div>
</section>
<section id="x2-then-x1" class="level4" data-number="4.6.2.2">
<h4 data-number="4.6.2.2" class="anchored" data-anchor-id="x2-then-x1"><span class="header-section-number">4.6.2.2</span> X2 then X1</h4>
<p>Now let us turn to the alternative assumption, where we first transport X2, then X1.</p>
<p>The adjacency matrix:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>adj_2 <span class="ot">&lt;-</span> <span class="fu">matrix</span>(</span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># S  X1 X2 Y</span></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>,<span class="co"># S</span></span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>    <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>,<span class="co"># X1</span></span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a>    <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>,<span class="co"># X2</span></span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a>    <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>  <span class="co"># Y</span></span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">ncol =</span> <span class="fu">length</span>(variables),</span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">dimnames =</span> <span class="fu">rep</span>(<span class="fu">list</span>(variables), <span class="dv">2</span>),</span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">byrow =</span> <span class="cn">TRUE</span></span>
<span id="cb83-11"><a href="#cb83-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The causal graph:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>causal_graph_2 <span class="ot">&lt;-</span> fairadapt<span class="sc">::</span><span class="fu">graphModel</span>(adj_2)</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(causal_graph_2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-causal-graph-2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-causal-graph-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.6: Assumed Causal Graph
</figcaption>
<div aria-describedby="fig-causal-graph-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="algorithm-5_files/figure-html/fig-causal-graph-2-1.png" class="img-fluid figure-img" width="672">
</div>
</figure>
</div>
</div>
</div>
<p>We can then use our <code class="sourceCode r"><span class="fu">seq_trans</span>()</code> to first learn the mapping.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>trans_x2_then_x1 <span class="ot">&lt;-</span> <span class="fu">seq_trans</span>(</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> D_SXY, <span class="at">adj =</span> adj_2, <span class="at">s =</span> <span class="st">"S"</span>, <span class="at">S_0 =</span> <span class="dv">0</span>, <span class="at">y =</span> <span class="st">"Y"</span></span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Transporting  X2 
Transporting  X1 </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in Hmisc::wtd.quantile(x = x_S1, weights = weights_S1[i, ], probs =
f[i]): probable complete loss of accuracy in modulus</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in regularize.values(x, y, ties, missing(ties), na.rm = na.rm):
collapsing to unique 'x' values</code></pre>
</div>
</div>
<p>Using the learned mapping, we can transport our new individual, thanks to our <code class="sourceCode r"><span class="fu">seq_trans_new</span>()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>new_obs_x2_then_x1 <span class="ot">&lt;-</span> <span class="fu">seq_trans_new</span>(</span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> trans_x2_then_x1, <span class="at">newdata =</span> new_obs, <span class="at">data =</span> D_SXY</span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>new_obs_x2_then_x1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$X2
[1] 1.480031

$X1
[1] 1.029645</code></pre>
</div>
</div>
</section>
</section>
<section id="sec-regression-model" class="level3" data-number="4.6.3">
<h3 data-number="4.6.3" class="anchored" data-anchor-id="sec-regression-model"><span class="header-section-number">4.6.3</span> Hypothetical Model</h3>
<p>Assume the scores obtained from a logistic regression write: <span class="math display">\[
m(x_1,x_2,s)=\big(1+\exp\big[-\big((x_1+x_2)/2 + \boldsymbol{1}(s=1)\big)\big]\big)^{-1}.
\]</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Logistic regression</span></span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a><span class="co">#' </span></span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param x1 first numerical predictor</span></span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param x2 second numerical predictor</span></span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param s sensitive attribute (0/1)</span></span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a>logistique_reg <span class="ot">&lt;-</span> <span class="cf">function</span>(x1, x2, s) {</span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a>  eta <span class="ot">&lt;-</span> (x1 <span class="sc">+</span> x2) <span class="sc">/</span> <span class="dv">2</span> <span class="sc">-</span> s</span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">exp</span>(eta) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(eta))</span>
<span id="cb91-9"><a href="#cb91-9" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can use this hypothetical model to make predictions given the values of <span class="math inline">\(x_1\)</span> and <span class="math inline">\(x_2\)</span>. Let us make some on a grid.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>vx0 <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">5</span>, <span class="dv">5</span>, <span class="at">length =</span> <span class="dv">251</span>)</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>data_grid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">x =</span> vx0, <span class="at">y =</span> vx0)</span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>L0 <span class="ot">&lt;-</span> <span class="fu">logistique_reg</span>(<span class="at">x1 =</span> data_grid<span class="sc">$</span>x, <span class="at">x2 =</span> data_grid<span class="sc">$</span>y, <span class="at">s =</span> <span class="dv">0</span>)</span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>L1 <span class="ot">&lt;-</span> <span class="fu">logistique_reg</span>(<span class="at">x1 =</span> data_grid<span class="sc">$</span>x, <span class="at">x2 =</span> data_grid<span class="sc">$</span>y, <span class="at">s =</span> <span class="dv">1</span>)</span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a><span class="co"># as a grid:</span></span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a>dlogistique0 <span class="ot">&lt;-</span> <span class="fu">matrix</span>(L0, <span class="fu">length</span>(vx0), <span class="fu">length</span>(vx0))</span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a>dlogistique1 <span class="ot">&lt;-</span> <span class="fu">matrix</span>(L1, <span class="fu">length</span>(vx0), <span class="fu">length</span>(vx0))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="visualization" class="level3" data-number="4.6.4">
<h3 data-number="4.6.4" class="anchored" data-anchor-id="visualization"><span class="header-section-number">4.6.4</span> Visualization</h3>
<p>Let us estimate (again) the kernel densities in each group.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Computation of smoothing parameters (bandwidth) for kernel density estimation</span></span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>H0 <span class="ot">&lt;-</span> <span class="fu">Hpi</span>(D_SXY0[, <span class="fu">c</span>(<span class="st">"X1"</span>,<span class="st">"X2"</span>)])</span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>H1 <span class="ot">&lt;-</span> <span class="fu">Hpi</span>(D_SXY1[, <span class="fu">c</span>(<span class="st">"X1"</span>,<span class="st">"X2"</span>)])</span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculating multivariate densities in each group</span></span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a>f0_2d <span class="ot">&lt;-</span> <span class="fu">kde</span>(D_SXY0[, <span class="fu">c</span>(<span class="st">"X1"</span>,<span class="st">"X2"</span>)], <span class="at">H =</span> H0, <span class="at">xmin =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">5</span>, <span class="sc">-</span><span class="dv">5</span>), <span class="at">xmax =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">5</span>))</span>
<span id="cb93-7"><a href="#cb93-7" aria-hidden="true" tabindex="-1"></a>f1_2d <span class="ot">&lt;-</span> <span class="fu">kde</span>(D_SXY1[, <span class="fu">c</span>(<span class="st">"X1"</span>,<span class="st">"X2"</span>)], <span class="at">H =</span> H1, <span class="at">xmin =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">5</span>, <span class="sc">-</span><span class="dv">5</span>), <span class="at">xmax =</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let us create a table with the coordinates of different points: the new individual and its new coordinates depending on the transport method.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>coords <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 1. (x1, x2)</span></span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">start =</span> <span class="fu">c</span>(new_obs<span class="sc">$</span>X1, new_obs<span class="sc">$</span>X2),</span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 2. (T_1(x1 | x2), T_2(x2))</span></span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">x2_then_x1 =</span> <span class="fu">c</span>(new_obs_x2_then_x1<span class="sc">$</span>X1, new_obs_x2_then_x1<span class="sc">$</span>X2),</span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 3. (T_1(x1), T_2(x2 | x1))</span></span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1_then_x2 =</span> <span class="fu">c</span>(new_obs_x1_then_x2<span class="sc">$</span>X1, new_obs_x1_then_x2<span class="sc">$</span>X2),</span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 4. (T_1(x1), x2)</span></span>
<span id="cb94-9"><a href="#cb94-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1_intermediaire =</span> <span class="fu">c</span>(new_obs_x1_then_x2<span class="sc">$</span>X1, new_obs<span class="sc">$</span>X2),</span>
<span id="cb94-10"><a href="#cb94-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 5. (x1, T_2(x2))</span></span>
<span id="cb94-11"><a href="#cb94-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">x2_intermediaire =</span> <span class="fu">c</span>(new_obs<span class="sc">$</span>X1, new_obs_x2_then_x1<span class="sc">$</span>X2),</span>
<span id="cb94-12"><a href="#cb94-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 6. T*(x1,x2)</span></span>
<span id="cb94-13"><a href="#cb94-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">x_ot =</span> <span class="fu">c</span>(new_obs_ot[<span class="dv">1</span>], new_obs_ot[<span class="dv">2</span>])</span>
<span id="cb94-14"><a href="#cb94-14" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can use the hypothetical model to compute its prediction for all these points. We also add a prediction when we only change the sensitive variable <span class="math inline">\(S\)</span> from 0 to 1 and leave the coordinates <span class="math inline">\(x_1\)</span> and <span class="math inline">\(x_2\)</span> unchanged.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>v <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 1. Prediction at initial values (S=0, x1, x2)</span></span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">logistique_reg</span>(<span class="at">x1 =</span> coords<span class="sc">$</span>start[<span class="dv">1</span>], <span class="at">x2 =</span> coords<span class="sc">$</span>start[<span class="dv">2</span>], <span class="at">s =</span> <span class="dv">0</span>),</span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 2. Prediction if (S=1, x1, x2)</span></span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">logistique_reg</span>(coords<span class="sc">$</span>start[<span class="dv">1</span>], coords<span class="sc">$</span>start[<span class="dv">2</span>], <span class="dv">1</span>),</span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 3. Prediction if (S = 1, T_1(x1), T_2(x2 | x1))</span></span>
<span id="cb95-7"><a href="#cb95-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">logistique_reg</span>(coords<span class="sc">$</span>x1_then_x2[<span class="dv">1</span>], coords<span class="sc">$</span>x1_then_x2[<span class="dv">2</span>], <span class="dv">1</span>),</span>
<span id="cb95-8"><a href="#cb95-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 4. Prediction if (S = 1, T_1(x1 | x2), T_2(x2))</span></span>
<span id="cb95-9"><a href="#cb95-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">logistique_reg</span>(coords<span class="sc">$</span>x2_then_x1[<span class="dv">1</span>], coords<span class="sc">$</span>x2_then_x1[<span class="dv">2</span>], <span class="dv">1</span>),</span>
<span id="cb95-10"><a href="#cb95-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 5. Prediction if (S = 1, T_1(x1), x2)</span></span>
<span id="cb95-11"><a href="#cb95-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">logistique_reg</span>(coords<span class="sc">$</span>x1_intermediaire[<span class="dv">1</span>], coords<span class="sc">$</span>x1_intermediaire[<span class="dv">2</span>], <span class="dv">1</span>),</span>
<span id="cb95-12"><a href="#cb95-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 6. Prediction if (S = 1, x1, T_2(x2))</span></span>
<span id="cb95-13"><a href="#cb95-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">logistique_reg</span>(coords<span class="sc">$</span>x2_intermediaire[<span class="dv">1</span>], coords<span class="sc">$</span>x2_intermediaire[<span class="dv">2</span>], <span class="dv">1</span>),</span>
<span id="cb95-14"><a href="#cb95-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 7. Prediction if (S=1, T*(x1), T*(x2))</span></span>
<span id="cb95-15"><a href="#cb95-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">logistique_reg</span>(coords<span class="sc">$</span>x_ot[<span class="dv">1</span>], coords<span class="sc">$</span>x_ot[<span class="dv">2</span>], <span class="dv">1</span>)</span>
<span id="cb95-16"><a href="#cb95-16" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then, we can plot all this information on a graph. The arrows show the path from the new individual to its counterfactual assuming the two different causal relationships. The red square shows the value obtained with multivariate optimal transport.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">0</span>))</span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Group 0</span></span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a><span class="do">## Estimated density: level curves for (x1, x2) -&gt; m(0, x1, x2)</span></span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a>CeX <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a><span class="fu">contour</span>(</span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a>  f0_2d<span class="sc">$</span>eval.point[[<span class="dv">1</span>]],</span>
<span id="cb96-7"><a href="#cb96-7" aria-hidden="true" tabindex="-1"></a>  f0_2d<span class="sc">$</span>eval.point[[<span class="dv">2</span>]],</span>
<span id="cb96-8"><a href="#cb96-8" aria-hidden="true" tabindex="-1"></a>  f0_2d<span class="sc">$</span>estimate,</span>
<span id="cb96-9"><a href="#cb96-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> scales<span class="sc">::</span><span class="fu">alpha</span>(colours[<span class="st">"A"</span>], .<span class="dv">3</span>),</span>
<span id="cb96-10"><a href="#cb96-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">axes =</span> <span class="cn">FALSE</span>, <span class="at">xlab =</span> <span class="st">""</span>, <span class="at">ylab =</span> <span class="st">""</span></span>
<span id="cb96-11"><a href="#cb96-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb96-12"><a href="#cb96-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Group 1</span></span>
<span id="cb96-13"><a href="#cb96-13" aria-hidden="true" tabindex="-1"></a><span class="do">## Estimated density: level curves for (x1, x2) -&gt; m(1, x1, x2)</span></span>
<span id="cb96-14"><a href="#cb96-14" aria-hidden="true" tabindex="-1"></a><span class="fu">contour</span>(</span>
<span id="cb96-15"><a href="#cb96-15" aria-hidden="true" tabindex="-1"></a>  f1_2d<span class="sc">$</span>eval.point[[<span class="dv">1</span>]],</span>
<span id="cb96-16"><a href="#cb96-16" aria-hidden="true" tabindex="-1"></a>  f1_2d<span class="sc">$</span>eval.point[[<span class="dv">2</span>]],</span>
<span id="cb96-17"><a href="#cb96-17" aria-hidden="true" tabindex="-1"></a>  f1_2d<span class="sc">$</span>estimate,</span>
<span id="cb96-18"><a href="#cb96-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> scales<span class="sc">::</span><span class="fu">alpha</span>(colours[<span class="st">"B"</span>], .<span class="dv">3</span>), <span class="at">add =</span> <span class="cn">TRUE</span></span>
<span id="cb96-19"><a href="#cb96-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb96-20"><a href="#cb96-20" aria-hidden="true" tabindex="-1"></a><span class="fu">contour</span>(</span>
<span id="cb96-21"><a href="#cb96-21" aria-hidden="true" tabindex="-1"></a>  vx0, vx0, dlogistique0,</span>
<span id="cb96-22"><a href="#cb96-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">levels =</span> (<span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>)<span class="sc">/</span><span class="dv">10</span>,</span>
<span id="cb96-23"><a href="#cb96-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> scl,</span>
<span id="cb96-24"><a href="#cb96-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">add =</span> <span class="cn">TRUE</span>,<span class="at">lwd =</span> <span class="dv">2</span></span>
<span id="cb96-25"><a href="#cb96-25" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb96-26"><a href="#cb96-26" aria-hidden="true" tabindex="-1"></a><span class="fu">axis</span>(<span class="dv">1</span>)</span>
<span id="cb96-27"><a href="#cb96-27" aria-hidden="true" tabindex="-1"></a><span class="fu">axis</span>(<span class="dv">2</span>)</span>
<span id="cb96-28"><a href="#cb96-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-29"><a href="#cb96-29" aria-hidden="true" tabindex="-1"></a><span class="do">###</span></span>
<span id="cb96-30"><a href="#cb96-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Individual (S=0, x1=-2, x2=-1)</span></span>
<span id="cb96-31"><a href="#cb96-31" aria-hidden="true" tabindex="-1"></a><span class="do">###</span></span>
<span id="cb96-32"><a href="#cb96-32" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(coords<span class="sc">$</span>start[<span class="dv">1</span>], coords<span class="sc">$</span>start[<span class="dv">2</span>], <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">cex =</span> CeX)</span>
<span id="cb96-33"><a href="#cb96-33" aria-hidden="true" tabindex="-1"></a><span class="do">## Predicted value for the individual, based on factuals</span></span>
<span id="cb96-34"><a href="#cb96-34" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(</span>
<span id="cb96-35"><a href="#cb96-35" aria-hidden="true" tabindex="-1"></a>  coords<span class="sc">$</span>start[<span class="dv">1</span>], coords<span class="sc">$</span>start[<span class="dv">2</span>],</span>
<span id="cb96-36"><a href="#cb96-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste</span>(<span class="fu">round</span>(v[<span class="dv">1</span>] <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">1</span>), <span class="st">"%"</span>, <span class="at">sep =</span> <span class="st">""</span>), </span>
<span id="cb96-37"><a href="#cb96-37" aria-hidden="true" tabindex="-1"></a>  <span class="at">pos =</span> <span class="dv">1</span>, <span class="at">cex =</span> CeX, <span class="at">col =</span> <span class="st">"darkblue"</span></span>
<span id="cb96-38"><a href="#cb96-38" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-counterfactuals-new-individual-1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-counterfactuals-new-individual-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.7: In the background, level curves for <span class="math inline">\((x_1,x_2)\mapsto m(0,x_1,x_2)\)</span>. The blue point corresponds to the individual <span class="math inline">\((s,x_1,x_2)=(s=0,-2,-1)\)</span> (predicted 18.2% by model <span class="math inline">\(m\)</span>, and 7.6% if <span class="math inline">\(s\)</span> is set to 1 leaving <span class="math inline">\(x_1\)</span> and <span class="math inline">\(x_2\)</span> unchanged).
</figcaption>
<div aria-describedby="fig-counterfactuals-new-individual-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="algorithm-5_files/figure-html/fig-counterfactuals-new-individual-1-1.png" class="img-fluid figure-img" width="384">
</div>
</figure>
</div>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">0</span>))</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Group 0</span></span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a><span class="do">## Estimated density: level curves for (x1, x2) -&gt; m(0, x1, x2)</span></span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a><span class="fu">contour</span>(</span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a>  f0_2d<span class="sc">$</span>eval.point[[<span class="dv">1</span>]],</span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a>  f0_2d<span class="sc">$</span>eval.point[[<span class="dv">2</span>]],</span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a>  f0_2d<span class="sc">$</span>estimate,</span>
<span id="cb97-8"><a href="#cb97-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> scales<span class="sc">::</span><span class="fu">alpha</span>(colours[<span class="st">"A"</span>], .<span class="dv">3</span>),</span>
<span id="cb97-9"><a href="#cb97-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">axes =</span> <span class="cn">FALSE</span>, <span class="at">xlab =</span> <span class="st">""</span>, <span class="at">ylab =</span> <span class="st">""</span></span>
<span id="cb97-10"><a href="#cb97-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb97-11"><a href="#cb97-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Group 1</span></span>
<span id="cb97-12"><a href="#cb97-12" aria-hidden="true" tabindex="-1"></a><span class="do">## Estimated density: level curves for (x1, x2) -&gt; m(1, x1, x2)</span></span>
<span id="cb97-13"><a href="#cb97-13" aria-hidden="true" tabindex="-1"></a><span class="fu">contour</span>(</span>
<span id="cb97-14"><a href="#cb97-14" aria-hidden="true" tabindex="-1"></a>  f1_2d<span class="sc">$</span>eval.point[[<span class="dv">1</span>]],</span>
<span id="cb97-15"><a href="#cb97-15" aria-hidden="true" tabindex="-1"></a>  f1_2d<span class="sc">$</span>eval.point[[<span class="dv">2</span>]],</span>
<span id="cb97-16"><a href="#cb97-16" aria-hidden="true" tabindex="-1"></a>  f1_2d<span class="sc">$</span>estimate,</span>
<span id="cb97-17"><a href="#cb97-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> scales<span class="sc">::</span><span class="fu">alpha</span>(colours[<span class="st">"B"</span>], .<span class="dv">3</span>), <span class="at">add =</span> <span class="cn">TRUE</span></span>
<span id="cb97-18"><a href="#cb97-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb97-19"><a href="#cb97-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-20"><a href="#cb97-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Contour of estimates by the model for s=1</span></span>
<span id="cb97-21"><a href="#cb97-21" aria-hidden="true" tabindex="-1"></a><span class="fu">contour</span>(</span>
<span id="cb97-22"><a href="#cb97-22" aria-hidden="true" tabindex="-1"></a>  vx0, vx0, dlogistique1,</span>
<span id="cb97-23"><a href="#cb97-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">levels =</span> (<span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>) <span class="sc">/</span> <span class="dv">10</span>,</span>
<span id="cb97-24"><a href="#cb97-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> scl, <span class="at">lwd=</span><span class="dv">2</span>,</span>
<span id="cb97-25"><a href="#cb97-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">add =</span> <span class="cn">TRUE</span></span>
<span id="cb97-26"><a href="#cb97-26" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb97-27"><a href="#cb97-27" aria-hidden="true" tabindex="-1"></a><span class="fu">axis</span>(<span class="dv">1</span>)</span>
<span id="cb97-28"><a href="#cb97-28" aria-hidden="true" tabindex="-1"></a><span class="fu">axis</span>(<span class="dv">2</span>)</span>
<span id="cb97-29"><a href="#cb97-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-30"><a href="#cb97-30" aria-hidden="true" tabindex="-1"></a><span class="do">###</span></span>
<span id="cb97-31"><a href="#cb97-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Individual (s=0, x1=-2, x2=-1)</span></span>
<span id="cb97-32"><a href="#cb97-32" aria-hidden="true" tabindex="-1"></a><span class="do">###</span></span>
<span id="cb97-33"><a href="#cb97-33" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(coords<span class="sc">$</span>start[<span class="dv">1</span>], coords<span class="sc">$</span>start[<span class="dv">2</span>], <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">cex =</span> CeX)</span>
<span id="cb97-34"><a href="#cb97-34" aria-hidden="true" tabindex="-1"></a><span class="do">## Predicted value for the individual, based on factuals</span></span>
<span id="cb97-35"><a href="#cb97-35" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(</span>
<span id="cb97-36"><a href="#cb97-36" aria-hidden="true" tabindex="-1"></a>  coords<span class="sc">$</span>start[<span class="dv">1</span>] <span class="sc">-</span> .<span class="dv">3</span>, coords<span class="sc">$</span>start[<span class="dv">2</span>] <span class="sc">-</span> .<span class="dv">42</span> <span class="sc">-</span> .<span class="dv">3</span>,</span>
<span id="cb97-37"><a href="#cb97-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste</span>(<span class="fu">round</span>(v[<span class="dv">1</span>] <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">1</span>), <span class="st">"%"</span>, <span class="at">sep =</span> <span class="st">""</span>), </span>
<span id="cb97-38"><a href="#cb97-38" aria-hidden="true" tabindex="-1"></a>  <span class="at">pos =</span> <span class="dv">1</span>, <span class="at">cex =</span> CeX, <span class="at">col =</span> <span class="st">"darkblue"</span></span>
<span id="cb97-39"><a href="#cb97-39" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb97-40"><a href="#cb97-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-41"><a href="#cb97-41" aria-hidden="true" tabindex="-1"></a><span class="do">###</span></span>
<span id="cb97-42"><a href="#cb97-42" aria-hidden="true" tabindex="-1"></a><span class="co"># Transported individual when transporting x1 and then x2, i.e.,</span></span>
<span id="cb97-43"><a href="#cb97-43" aria-hidden="true" tabindex="-1"></a><span class="co"># (do(s=1), T_1^*(x1), T_2^*(x_2 | x_1))</span></span>
<span id="cb97-44"><a href="#cb97-44" aria-hidden="true" tabindex="-1"></a><span class="do">###</span></span>
<span id="cb97-45"><a href="#cb97-45" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(coords<span class="sc">$</span>x1_then_x2[<span class="dv">1</span>],coords<span class="sc">$</span>x1_then_x2[<span class="dv">2</span>], <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">cex =</span> CeX)</span>
<span id="cb97-46"><a href="#cb97-46" aria-hidden="true" tabindex="-1"></a><span class="fu">segments</span>(</span>
<span id="cb97-47"><a href="#cb97-47" aria-hidden="true" tabindex="-1"></a>  <span class="at">x0 =</span> coords<span class="sc">$</span>start[<span class="dv">1</span>], <span class="at">y0 =</span> coords<span class="sc">$</span>start[<span class="dv">2</span>], </span>
<span id="cb97-48"><a href="#cb97-48" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> coords<span class="sc">$</span>x1_then_x2[<span class="dv">1</span>], <span class="at">y1 =</span> coords<span class="sc">$</span>start[<span class="dv">2</span>], </span>
<span id="cb97-49"><a href="#cb97-49" aria-hidden="true" tabindex="-1"></a>  <span class="at">lwd =</span> .<span class="dv">8</span></span>
<span id="cb97-50"><a href="#cb97-50" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb97-51"><a href="#cb97-51" aria-hidden="true" tabindex="-1"></a><span class="fu">segments</span>(</span>
<span id="cb97-52"><a href="#cb97-52" aria-hidden="true" tabindex="-1"></a>  <span class="at">x0 =</span> coords<span class="sc">$</span>x1_then_x2[<span class="dv">1</span>], <span class="at">y0 =</span> coords<span class="sc">$</span>x1_then_x2[<span class="dv">2</span>],</span>
<span id="cb97-53"><a href="#cb97-53" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> coords<span class="sc">$</span>x1_then_x2[<span class="dv">1</span>], <span class="at">y1 =</span> coords<span class="sc">$</span>start[<span class="dv">2</span>], </span>
<span id="cb97-54"><a href="#cb97-54" aria-hidden="true" tabindex="-1"></a>  <span class="at">lwd =</span> .<span class="dv">8</span></span>
<span id="cb97-55"><a href="#cb97-55" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb97-56"><a href="#cb97-56" aria-hidden="true" tabindex="-1"></a><span class="do">## Intermediate point</span></span>
<span id="cb97-57"><a href="#cb97-57" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(coords<span class="sc">$</span>x1_then_x2[<span class="dv">1</span>], coords<span class="sc">$</span>start[<span class="dv">2</span>], <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">col =</span> <span class="st">"white"</span>, <span class="at">cex =</span> CeX)</span>
<span id="cb97-58"><a href="#cb97-58" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(coords<span class="sc">$</span>x1_then_x2[<span class="dv">1</span>], coords<span class="sc">$</span>start[<span class="dv">2</span>], <span class="at">pch =</span> <span class="dv">1</span>, <span class="at">cex =</span> CeX)</span>
<span id="cb97-59"><a href="#cb97-59" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(</span>
<span id="cb97-60"><a href="#cb97-60" aria-hidden="true" tabindex="-1"></a>  coords<span class="sc">$</span>x1_then_x2[<span class="dv">1</span>], coords<span class="sc">$</span>start[<span class="dv">2</span>] <span class="sc">-</span> .<span class="dv">42</span>,</span>
<span id="cb97-61"><a href="#cb97-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste</span>(<span class="fu">round</span>(v[<span class="dv">5</span>] <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">1</span>), <span class="st">"%"</span>, <span class="at">sep =</span> <span class="st">""</span>), <span class="at">pos =</span> <span class="dv">4</span>, <span class="at">cex =</span> CeX</span>
<span id="cb97-62"><a href="#cb97-62" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb97-63"><a href="#cb97-63" aria-hidden="true" tabindex="-1"></a><span class="co"># New predicted value for # (do(s=1), T_1^*(x1), T_2^*(x_2 | x_1))</span></span>
<span id="cb97-64"><a href="#cb97-64" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(</span>
<span id="cb97-65"><a href="#cb97-65" aria-hidden="true" tabindex="-1"></a>  coords<span class="sc">$</span>x1_then_x2[<span class="dv">1</span>], coords<span class="sc">$</span>x1_then_x2[<span class="dv">2</span>],</span>
<span id="cb97-66"><a href="#cb97-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste</span>(<span class="fu">round</span>(v[<span class="dv">3</span>]<span class="sc">*</span><span class="dv">100</span>,<span class="dv">1</span>),<span class="st">"%"</span>,<span class="at">sep=</span><span class="st">""</span>), <span class="at">pos =</span> <span class="dv">3</span>, <span class="at">cex =</span> CeX</span>
<span id="cb97-67"><a href="#cb97-67" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb97-68"><a href="#cb97-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-69"><a href="#cb97-69" aria-hidden="true" tabindex="-1"></a><span class="do">###</span></span>
<span id="cb97-70"><a href="#cb97-70" aria-hidden="true" tabindex="-1"></a><span class="co"># Transported individual when transporting x2 and then x1, i.e.,</span></span>
<span id="cb97-71"><a href="#cb97-71" aria-hidden="true" tabindex="-1"></a><span class="co"># (do(s=1), T_1^*(x1 | x2), T_2^*(x_2))</span></span>
<span id="cb97-72"><a href="#cb97-72" aria-hidden="true" tabindex="-1"></a><span class="do">###</span></span>
<span id="cb97-73"><a href="#cb97-73" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(coords<span class="sc">$</span>x2_then_x1[<span class="dv">1</span>],coords<span class="sc">$</span>x2_then_x1[<span class="dv">2</span>],<span class="at">pch=</span><span class="dv">19</span>,<span class="at">cex=</span>CeX)</span>
<span id="cb97-74"><a href="#cb97-74" aria-hidden="true" tabindex="-1"></a><span class="fu">segments</span>(</span>
<span id="cb97-75"><a href="#cb97-75" aria-hidden="true" tabindex="-1"></a>  <span class="at">x0 =</span> coords<span class="sc">$</span>start[<span class="dv">1</span>], <span class="at">y0 =</span> coords<span class="sc">$</span>start[<span class="dv">2</span>],</span>
<span id="cb97-76"><a href="#cb97-76" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> coords<span class="sc">$</span>start[<span class="dv">1</span>], <span class="at">y1 =</span> coords<span class="sc">$</span>x2_then_x1[<span class="dv">2</span>],</span>
<span id="cb97-77"><a href="#cb97-77" aria-hidden="true" tabindex="-1"></a>  <span class="at">lwd =</span> .<span class="dv">8</span></span>
<span id="cb97-78"><a href="#cb97-78" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb97-79"><a href="#cb97-79" aria-hidden="true" tabindex="-1"></a><span class="fu">segments</span>(</span>
<span id="cb97-80"><a href="#cb97-80" aria-hidden="true" tabindex="-1"></a>  <span class="at">x0 =</span> coords<span class="sc">$</span>x2_then_x1[<span class="dv">1</span>], <span class="at">y0 =</span> coords<span class="sc">$</span>x2_then_x1[<span class="dv">2</span>],</span>
<span id="cb97-81"><a href="#cb97-81" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> coords<span class="sc">$</span>start[<span class="dv">1</span>], <span class="at">y1 =</span> coords<span class="sc">$</span>x2_then_x1[<span class="dv">2</span>],</span>
<span id="cb97-82"><a href="#cb97-82" aria-hidden="true" tabindex="-1"></a>  <span class="at">lwd =</span> .<span class="dv">8</span></span>
<span id="cb97-83"><a href="#cb97-83" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb97-84"><a href="#cb97-84" aria-hidden="true" tabindex="-1"></a><span class="do">## Intermediate point</span></span>
<span id="cb97-85"><a href="#cb97-85" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(coords<span class="sc">$</span>start[<span class="dv">1</span>], coords<span class="sc">$</span>x2_then_x1[<span class="dv">2</span>], <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">col =</span> <span class="st">"white"</span>, <span class="at">cex =</span> CeX)</span>
<span id="cb97-86"><a href="#cb97-86" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(coords<span class="sc">$</span>start[<span class="dv">1</span>], coords<span class="sc">$</span>x2_then_x1[<span class="dv">2</span>], <span class="at">pch =</span> <span class="dv">1</span>, <span class="at">cex =</span> CeX)</span>
<span id="cb97-87"><a href="#cb97-87" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(</span>
<span id="cb97-88"><a href="#cb97-88" aria-hidden="true" tabindex="-1"></a>  coords<span class="sc">$</span>start[<span class="dv">1</span>], coords<span class="sc">$</span>x2_then_x1[<span class="dv">2</span>],</span>
<span id="cb97-89"><a href="#cb97-89" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste</span>(<span class="fu">round</span>(v[<span class="dv">6</span>] <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">1</span>), <span class="st">"%"</span>, <span class="at">sep =</span> <span class="st">""</span>), <span class="at">pos =</span> <span class="dv">2</span>, <span class="at">cex =</span> CeX</span>
<span id="cb97-90"><a href="#cb97-90" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb97-91"><a href="#cb97-91" aria-hidden="true" tabindex="-1"></a><span class="do">## New predicted value for (do(s=1), T_1^*(x1 | x2), T_2^*(x_2))</span></span>
<span id="cb97-92"><a href="#cb97-92" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(</span>
<span id="cb97-93"><a href="#cb97-93" aria-hidden="true" tabindex="-1"></a>  coords<span class="sc">$</span>x2_then_x1[<span class="dv">1</span>], coords<span class="sc">$</span>x2_then_x1[<span class="dv">2</span>],</span>
<span id="cb97-94"><a href="#cb97-94" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste</span>(<span class="fu">round</span>(v[<span class="dv">4</span>] <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">1</span>), <span class="st">"%"</span>, <span class="at">sep =</span> <span class="st">""</span>), <span class="at">pos =</span> <span class="dv">4</span>, <span class="at">cex =</span> CeX</span>
<span id="cb97-95"><a href="#cb97-95" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb97-96"><a href="#cb97-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-97"><a href="#cb97-97" aria-hidden="true" tabindex="-1"></a><span class="do">###</span></span>
<span id="cb97-98"><a href="#cb97-98" aria-hidden="true" tabindex="-1"></a><span class="co"># New predicted value for (do(s=1), x1, x2), no transport</span></span>
<span id="cb97-99"><a href="#cb97-99" aria-hidden="true" tabindex="-1"></a><span class="do">###</span></span>
<span id="cb97-100"><a href="#cb97-100" aria-hidden="true" tabindex="-1"></a>ry <span class="ot">&lt;-</span> .<span class="dv">2</span></span>
<span id="cb97-101"><a href="#cb97-101" aria-hidden="true" tabindex="-1"></a>plotrix<span class="sc">::</span><span class="fu">draw.circle</span>(</span>
<span id="cb97-102"><a href="#cb97-102" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> coords<span class="sc">$</span>start[<span class="dv">1</span>] <span class="sc">-</span> ry, <span class="at">y =</span> coords<span class="sc">$</span>start[<span class="dv">2</span>] <span class="sc">-</span> ry, </span>
<span id="cb97-103"><a href="#cb97-103" aria-hidden="true" tabindex="-1"></a>  <span class="at">radius =</span> ry <span class="sc">*</span> <span class="fu">sqrt</span>(<span class="dv">2</span>)</span>
<span id="cb97-104"><a href="#cb97-104" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb97-105"><a href="#cb97-105" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(</span>
<span id="cb97-106"><a href="#cb97-106" aria-hidden="true" tabindex="-1"></a>  coords<span class="sc">$</span>start[<span class="dv">1</span>], coords<span class="sc">$</span>start[<span class="dv">2</span>] <span class="sc">+</span> .<span class="dv">42</span>,</span>
<span id="cb97-107"><a href="#cb97-107" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste</span>(<span class="fu">round</span>(v[<span class="dv">2</span>] <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">1</span>), <span class="st">"%"</span>, <span class="at">sep =</span> <span class="st">""</span>), <span class="at">pos =</span> <span class="dv">4</span>, <span class="at">cex =</span> CeX</span>
<span id="cb97-108"><a href="#cb97-108" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb97-109"><a href="#cb97-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-110"><a href="#cb97-110" aria-hidden="true" tabindex="-1"></a><span class="do">###</span></span>
<span id="cb97-111"><a href="#cb97-111" aria-hidden="true" tabindex="-1"></a><span class="co"># Transported individual with optimal multivariate transport</span></span>
<span id="cb97-112"><a href="#cb97-112" aria-hidden="true" tabindex="-1"></a><span class="do">###</span></span>
<span id="cb97-113"><a href="#cb97-113" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(coords<span class="sc">$</span>x_ot[<span class="dv">1</span>],coords<span class="sc">$</span>x_ot[<span class="dv">2</span>], <span class="at">pch =</span> <span class="dv">15</span>, <span class="at">cex =</span> CeX, <span class="at">col =</span> <span class="st">"#C93312"</span>)</span>
<span id="cb97-114"><a href="#cb97-114" aria-hidden="true" tabindex="-1"></a><span class="fu">segments</span>(</span>
<span id="cb97-115"><a href="#cb97-115" aria-hidden="true" tabindex="-1"></a>  <span class="at">x0 =</span> coords<span class="sc">$</span>start[<span class="dv">1</span>], <span class="at">y0 =</span> coords<span class="sc">$</span>start[<span class="dv">2</span>], </span>
<span id="cb97-116"><a href="#cb97-116" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> coords<span class="sc">$</span>x_ot[<span class="dv">1</span>], <span class="at">y1 =</span> coords<span class="sc">$</span>x_ot[<span class="dv">2</span>], </span>
<span id="cb97-117"><a href="#cb97-117" aria-hidden="true" tabindex="-1"></a>  <span class="at">lwd =</span> .<span class="dv">8</span>,</span>
<span id="cb97-118"><a href="#cb97-118" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="st">"#C93312"</span>, <span class="at">lty =</span> <span class="dv">2</span></span>
<span id="cb97-119"><a href="#cb97-119" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb97-120"><a href="#cb97-120" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(</span>
<span id="cb97-121"><a href="#cb97-121" aria-hidden="true" tabindex="-1"></a>  coords<span class="sc">$</span>x_ot[<span class="dv">1</span>], coords<span class="sc">$</span>x_ot[<span class="dv">2</span>] <span class="sc">+</span> .<span class="dv">22</span>,</span>
<span id="cb97-122"><a href="#cb97-122" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste</span>(<span class="fu">round</span>(v[<span class="dv">7</span>] <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">1</span>), <span class="st">"%"</span>, <span class="at">sep =</span> <span class="st">""</span>), <span class="at">pos =</span> <span class="dv">4</span>, <span class="at">cex =</span> CeX,</span>
<span id="cb97-123"><a href="#cb97-123" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> <span class="st">"#C93312"</span>,</span>
<span id="cb97-124"><a href="#cb97-124" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-counterfactuals-new-individual-2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-counterfactuals-new-individual-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.8: In the background, level curves for<span class="math inline">\(m(1,x_1,x_2)\)</span>. Two counterfactuals are depicted by the black dots <span class="math inline">\((s=1,x_1^\star,x_2^\star)\)</span> according to a causal graph where <span class="math inline">\(x_2\)</span> depends on <span class="math inline">\(x_1\)</span> (bottom left path, predicted 61.4%) and a causal graph where <span class="math inline">\(x_1\)</span> depends on <span class="math inline">\(x_2\)</span> (top left path, predicted 56.5%). The red square shows the counterfactual obtained with optimal transport (with a predicted value by model <span class="math inline">\(m\)</span> at 56.5%).
</figcaption>
<div aria-describedby="fig-counterfactuals-new-individual-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="algorithm-5_files/figure-html/fig-counterfactuals-new-individual-2-1.png" class="img-fluid figure-img" width="384">
</div>
</figure>
</div>
</div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./transport-fast-grid.html" class="pagination-link" aria-label="Fast Transport on a Grid with Numerical Covariates">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Fast Transport on a Grid with Numerical Covariates</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./gaussian-dep.html" class="pagination-link" aria-label="Wrong Causal Assumptions">
        <span class="nav-page-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Wrong Causal Assumptions</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
    <script type="text/javascript">
    (function(d) {
      d.querySelectorAll(".pseudocode-container").forEach(function(el) {
        let pseudocodeOptions = {
          indentSize: el.dataset.indentSize || "1.2em",
          commentDelimiter: el.dataset.commentDelimiter || "//",
          lineNumber: el.dataset.lineNumber === "true" ? true : false,
          lineNumberPunc: el.dataset.lineNumberPunc || ":",
          noEnd: el.dataset.noEnd === "true" ? true : false,
          titlePrefix: el.dataset.captionPrefix || "Algorithm"
        };
        pseudocode.renderElement(el.querySelector(".pseudocode"), pseudocodeOptions);
      });
    })(document);
    (function(d) {
      d.querySelectorAll(".pseudocode-container").forEach(function(el) {
        let captionSpan = el.querySelector(".ps-root > .ps-algorithm > .ps-line > .ps-keyword")
        if (captionSpan !== null) {
          let captionPrefix = el.dataset.captionPrefix + " ";
          let captionNumber = "";
          if (el.dataset.pseudocodeNumber) {
            captionNumber = el.dataset.pseudocodeNumber + " ";
            if (el.dataset.chapterLevel) {
              captionNumber = el.dataset.chapterLevel + "." + captionNumber;
            }
          }
          captionSpan.innerHTML = captionPrefix + captionNumber;
        }
      });
    })(document);
    </script>
  




</body></html>