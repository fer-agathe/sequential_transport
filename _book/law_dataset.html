<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.553">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Sequential Conditional (Marginally Optimal) Transport on Probabilistic Graphs for Interpretable Counterfactual Fairness - 1&nbsp; Law Dataset</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./references.html" rel="next">
<link href="./index.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({ TeX: { extensions: ["color.js"] }});
</script>
<script type="text/x-mathjax-config">
	MathJax.Hub.Register.StartupHook("TeX color Ready", function() {
	     MathJax.Extension["TeX/color"].colors["wongBlack"] = '#000000';
		 MathJax.Extension["TeX/color"].colors["wongGold"] = '#E69F00';
		 MathJax.Extension["TeX/color"].colors["wongLightBlue"] = '#56B4E9';
		 MathJax.Extension["TeX/color"].colors["wongGreen"] = '#009E73';
		 MathJax.Extension["TeX/color"].colors["wongYellow"] = '#F0E442';
		 MathJax.Extension["TeX/color"].colors["wongBlue"] = '#0072B2';
		 MathJax.Extension["TeX/color"].colors["wongOrange"] = '#D55E00';
		 MathJax.Extension["TeX/color"].colors["wongPurple"] = '#CC79A7';
		 
		 
		 MathJax.Extension["TeX/color"].colors["IBMBlue"] = '#648FFF';
		 MathJax.Extension["TeX/color"].colors["IBMPurple"] = '#785EF0';
		 MathJax.Extension["TeX/color"].colors["IBMMagenta"] = '#DC267F';
		 MathJax.Extension["TeX/color"].colors["IBMOrange"] = '#FE6100';
		 MathJax.Extension["TeX/color"].colors["IBMYellow"] = '#FFB000';
	});
</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./law_dataset.html"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Law Dataset</span></a></li></ol></nav>
        <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Sequential Conditional (Marginally Optimal) Transport on Probabilistic Graphs for Interpretable Counterfactual Fairness</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./law_dataset.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Law Dataset</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#data-pre-processing" id="toc-data-pre-processing" class="nav-link active" data-scroll-target="#data-pre-processing"><span class="header-section-number">1.1</span> Data Pre-Processing</a></li>
  <li><a href="#causal-graph" id="toc-causal-graph" class="nav-link" data-scroll-target="#causal-graph"><span class="header-section-number">1.2</span> Causal graph</a></li>
  <li><a href="#classification" id="toc-classification" class="nav-link" data-scroll-target="#classification"><span class="header-section-number">1.3</span> Classification</a></li>
  <li><a href="#counterfactual-inference" id="toc-counterfactual-inference" class="nav-link" data-scroll-target="#counterfactual-inference"><span class="header-section-number">1.4</span> Counterfactual inference</a>
  <ul class="collapse">
  <li><a href="#fairadapt" id="toc-fairadapt" class="nav-link" data-scroll-target="#fairadapt"><span class="header-section-number">1.4.1</span> Fairadapt</a></li>
  <li><a href="#multivariate-optimal-transport" id="toc-multivariate-optimal-transport" class="nav-link" data-scroll-target="#multivariate-optimal-transport"><span class="header-section-number">1.4.2</span> Multivariate Optimal Transport</a></li>
  <li><a href="#sequential-transport" id="toc-sequential-transport" class="nav-link" data-scroll-target="#sequential-transport"><span class="header-section-number">1.4.3</span> Sequential transport</a></li>
  <li><a href="#comparison" id="toc-comparison" class="nav-link" data-scroll-target="#comparison"><span class="header-section-number">1.4.4</span> Comparison</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Law Dataset</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Objective
</div>
</div>
<div class="callout-body-container callout-body">
<p>In this notebook, …</p>
</div>
</div>
<p>This law school dataset contains information collected through a survey conducted from 1991 through 1997 by the Law School Admission Council across 163 law schools in the United States of America (<span class="citation" data-cites="Wightman1998LSACNL">Wightman (<a href="references.html#ref-Wightman1998LSACNL" role="doc-biblioref">1998</a>)</span>). In total, 21,790 law students were tracked through law school, graduation, and sittings for bar exams.</p>
<p>We use the formatted data from <span class="citation" data-cites="de2024transport">De Lara et al. (<a href="references.html#ref-de2024transport" role="doc-biblioref">2024</a>)</span>, also used by <span class="citation" data-cites="delara2021transportbased">Lara et al. (<a href="references.html#ref-delara2021transportbased" role="doc-biblioref">2021</a>)</span> (see the github associated to the paper: <a href="https://github.com/lucasdelara/PI-Fair.git" class="uri">https://github.com/lucasdelara/PI-Fair.git</a>).</p>
<p>Each row from the raw data gives information for a student. The following characteristics are available:</p>
<ul>
<li><code>race</code>: Race of the student (character: Amerindian, Asian, Black, Hispanic, Mexican, Other, Puertorican, White).</li>
<li><code>sex</code>: Sex of the student (numeric: 1 female, 2 male).</li>
<li><code>LSAT</code>: LSAT score received by the student (numeric).</li>
<li><code>UGPA</code>: Undergraduate GPA of the student (numeric).</li>
<li><code>region_first</code>: region in which the student took their first bar examination (Far West, Great Lakes, Midsouth, Midwest, Mountain West, Northeast, New England, Northwest, South Central, South East) (character)</li>
<li><code>ZFYA</code>: standardized first-year law school grades (first year average grade, FYA) (numeric).</li>
<li><code>sander_index</code>: Sander index of the student: weighted average of normalized UGPA and LSAT scores (however, no details are given for this specific dataset, see <span class="citation" data-cites="sander2004systemic">Sander (<a href="references.html#ref-sander2004systemic" role="doc-biblioref">2004</a>)</span>, p.&nbsp;393) (numeric)</li>
<li><code>first_pf</code>: Probably a binary variable that indicates whether the student passed on their first trial ? No information is given about this variable… (numeric 0/1).</li>
</ul>
<div class="cell">
<details class="code-fold">
<summary>Display the setting codes</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Required packages----</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(wesanderson)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(fairadapt)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(quantreg)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(latex2exp)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(T4transport)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Graphs----</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>font_main <span class="ot">=</span> font_title <span class="ot">=</span> <span class="st">'Times New Roman'</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>extrafont<span class="sc">::</span><span class="fu">loadfonts</span>(<span class="at">quiet =</span> T)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>face_text<span class="ot">=</span><span class="st">'plain'</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>face_title<span class="ot">=</span><span class="st">'plain'</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>size_title <span class="ot">=</span> <span class="dv">14</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>size_text <span class="ot">=</span> <span class="dv">11</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>legend_size <span class="ot">=</span> <span class="dv">11</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>global_theme <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>() <span class="sc">%+replace%</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>      <span class="at">text =</span> <span class="fu">element_text</span>(<span class="at">family =</span> font_main, <span class="at">size =</span> size_text, <span class="at">face =</span> face_text),</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">family =</span> font_main, <span class="at">size =</span> legend_size),</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> size_text, <span class="at">face =</span> face_text), </span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.title =</span> <span class="fu">element_text</span>(</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>        <span class="at">family =</span> font_title, </span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>        <span class="at">size =</span> size_title, </span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>        <span class="at">hjust =</span> <span class="fl">0.5</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.subtitle =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>)</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Colours</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>colors_ <span class="ot">&lt;-</span> <span class="fu">wes_palette</span>(<span class="st">'Rushmore1'</span>)</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Seed</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2025</span>)</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Use defined functions</span></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"functions/utils.R"</span>)</span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a><span class="co">#source("functions/quantile_reg.R")</span></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"functions/graphs.R"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="data-pre-processing" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="data-pre-processing"><span class="header-section-number">1.1</span> Data Pre-Processing</h2>
<p>We load the data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">'data/law_data.csv'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then, we focus on a subset of variables of interest:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span> </span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    race,</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    sex, <span class="co"># we can take S = gender</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    LSAT, <span class="co"># or S = race (white/black)</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    UGPA,</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    ZFYA <span class="co"># Y</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We create a dataset where the only protected class is the race:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Table for S = race</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>df_race <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span> </span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    race,</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    UGPA,</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    LSAT,</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    ZFYA</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    race <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"White"</span>, <span class="st">"Black"</span>)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">S =</span> race,</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">X1 =</span> UGPA,</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">X2 =</span> LSAT,</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">Y =</span> ZFYA</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span>  <span class="co"># no NA values</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">S =</span> <span class="fu">as.factor</span>(S)</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And another dataset in which the only protected class is the sex:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Table for S = gender</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>df_gender <span class="ot">&lt;-</span> df <span class="sc">|&gt;</span> </span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    sex,</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    UGPA,</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    LSAT,</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    ZFYA</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">S =</span> sex,</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">X1 =</span> UGPA,</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">X2 =</span> LSAT,</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">Y =</span> ZFYA</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span>  <span class="co"># no NA values</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">S =</span> <span class="fu">as.factor</span>(S)</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="{panel-tabset}">
<section id="s-race" class="level3" data-number="1.1.1">
<h3 data-number="1.1.1" class="anchored" data-anchor-id="s-race"><span class="header-section-number">1.1.1</span> S = Race</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> df_race, </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> Y, <span class="at">fill =</span> S)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">y =</span> ..density..), </span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">position =</span> <span class="st">"identity"</span>, <span class="at">binwidth =</span> <span class="fl">0.5</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Race"</span>,</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Y"</span>,</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Density"</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">global_theme</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-density-zfya-race" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-density-zfya-race-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1.1: Distribution of the standardized first-year law school grades among the two groups, when <span class="math inline">\(S\)</span> is the race
</figcaption>
<div aria-describedby="fig-density-zfya-race-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="law_dataset_files/figure-html/fig-density-zfya-race-1.png" class="img-fluid figure-img" width="672">
</div>
</figure>
</div>
</div>
</div>
</section>
<section id="s-gender" class="level3" data-number="1.1.2">
<h3 data-number="1.1.2" class="anchored" data-anchor-id="s-gender"><span class="header-section-number">1.1.2</span> S = Gender</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> df_gender, </span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> Y, <span class="at">fill =</span> S)) <span class="sc">+</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">y =</span> ..density..), </span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">position =</span> <span class="st">"identity"</span>, <span class="at">binwidth =</span> <span class="fl">0.5</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Gender"</span>,</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Y"</span>,</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Density"</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">global_theme</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-density-zfya-gender" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-density-zfya-gender-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1.2: Distribution of the standardized first-year law school grades among the two groups, when <span class="math inline">\(S\)</span> is the gender
</figcaption>
<div aria-describedby="fig-density-zfya-gender-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="law_dataset_files/figure-html/fig-density-zfya-gender-1.png" class="img-fluid figure-img" width="672">
</div>
</figure>
</div>
</div>
</div>
</section>
</div>
</section>
<section id="causal-graph" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="causal-graph"><span class="header-section-number">1.2</span> Causal graph</h2>
<p>The assumed causal graph we use here is different from that of the different papers <span class="citation" data-cites="de2024transport">De Lara et al. (<a href="references.html#ref-de2024transport" role="doc-biblioref">2024</a>)</span>, <span class="citation" data-cites="Kusner17">Kusner et al. (<a href="references.html#ref-Kusner17" role="doc-biblioref">2017</a>)</span>, <span class="citation" data-cites="black2020fliptest">Black, Yeom, and Fredrikson (<a href="references.html#ref-black2020fliptest" role="doc-biblioref">2020</a>)</span> using the same dataset.</p>
<p>We make the following assumptions:</p>
<ul>
<li>The sensitive attribute, (S) (race), has no parents.</li>
<li>The two other explanatory variables, (X_1) (UGPA) and (X_2) (LSAT), both directly depend on the sensitive attribute.</li>
<li>The second variable, (X_2) (LSAT), also depends on the first variable, (X_1) (UGPA). This is done for illustrative purposes, assuming that the score obtained on the LSAT is influenced by the UGPA.</li>
<li>The two variables, (X_1) (UGPA) and (X_2) (LSAT), cause the target variable (Y), i.e., whether the student obtained a high standardized first-year average (ZFYA).</li>
</ul>
<p>The corresponding Structural Equation Model writes:</p>
<p><span class="math display">\[
\begin{cases}
S: \text{ sensitive attribute (race)} \\
X_1 = h_1(S, U_1): \text{ UGPA, dependent on } S \\
X_2 = h_2(S, X_1, U_2): \text{ LSAT, dependent on } S \text{ and } X_1 \\
Y = h_3(X_1, X_2, U_Y): \text{ ZFYA, dependent on } X_1 \text{ and } X_2 \\
\end{cases}
\]</span></p>
<p>where (U_1), (U_2), and (U_Y) are independent error terms.</p>
<p>In R, we construct the upper triangular adjacency matrix to reflect our assumed causal structure:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>variables <span class="ot">&lt;-</span> <span class="fu">colnames</span>(df_race)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Adjacency matrix: upper triangular</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>adj <span class="ot">&lt;-</span> <span class="fu">matrix</span>(</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">1</span>,</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">1</span>,</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>,</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>),</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">ncol =</span> <span class="fu">length</span>(variables), </span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">dimnames =</span> <span class="fu">rep</span>(<span class="fu">list</span>(variables), <span class="dv">2</span>),</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">byrow =</span> <span class="cn">TRUE</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Which can be visualized as follows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>causal_graph <span class="ot">&lt;-</span> fairadapt<span class="sc">::</span><span class="fu">graphModel</span>(adj)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(causal_graph)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-causal-graph-race" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-causal-graph-race-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1.3: Causal Graph
</figcaption>
<div aria-describedby="fig-causal-graph-race-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="law_dataset_files/figure-html/fig-causal-graph-race-1.png" class="img-fluid figure-img" width="672">
</div>
</figure>
</div>
</div>
</div>
<p>The topological order:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>top_order <span class="ot">&lt;-</span> variables</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>top_order</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "S"  "X1" "X2" "Y" </code></pre>
</div>
</div>
</section>
<section id="classification" class="level2" data-number="1.3">
<h2 data-number="1.3" class="anchored" data-anchor-id="classification"><span class="header-section-number">1.3</span> Classification</h2>
<p>Following <span class="citation" data-cites="Kusner17">Kusner et al. (<a href="references.html#ref-Kusner17" role="doc-biblioref">2017</a>)</span>, a logistic regression model is trained. To convert (Y) into a categorical variable, the median is used as a threshold, in line with <span class="citation" data-cites="black2020fliptest">Black, Yeom, and Fredrikson (<a href="references.html#ref-black2020fliptest" role="doc-biblioref">2020</a>)</span>. The race, denoted as the sensitive attribute (S), has two categories: White and Black. The dataset is divided into training and testing sets. The classifier is first trained and used to compute the necessary quantities for counterfactual inference on the training set. Subsequently, the trained classifier is applied to the test set to make predictions and perform counterfactual analyses. The results of the counterfactuals will also be evaluated on the training set due to the limitation that Optimal Transport in the multivariate case cannot be computed for new samples, unlike the methodologies used in FairAdapt (<span class="citation" data-cites="plevcko2021fairadapt">Plečko, Bennett, and Meinshausen (<a href="references.html#ref-plevcko2021fairadapt" role="doc-biblioref">2021</a>)</span>) and the approach developed in this paper.</p>
<p>First, we transform <span class="math inline">\(Y\)</span> into a binary variable:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>med <span class="ot">&lt;-</span> <span class="fu">median</span>(df_race<span class="sc">$</span>Y)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>df_race_c <span class="ot">&lt;-</span> df_race <span class="sc">|&gt;</span> </span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">Y_c =</span> <span class="fu">ifelse</span>(Y <span class="sc">&gt;</span> med, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(S, X1, X2, <span class="at">Y =</span> Y_c)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We turn the response variable to a factor:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>df_race_c<span class="sc">$</span>Y <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(df_race_c<span class="sc">$</span>Y)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">levels</span>(df_race_c<span class="sc">$</span>Y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "0" "1"</code></pre>
</div>
</div>
<p>Let us split the dataset into train/test sets (we use the <code class="sourceCode r"><span class="fu">split_dataset</span>()</code> function defined in <code>functions/utils.R</code>):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>seed <span class="ot">&lt;-</span> <span class="dv">2025</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>sets <span class="ot">&lt;-</span> <span class="fu">split_dataset</span>(df_race_c, seed)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>data_train <span class="ot">&lt;-</span> sets<span class="sc">$</span>data_train</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>data_test <span class="ot">&lt;-</span> sets<span class="sc">$</span>data_test</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then, we train two models:</p>
<ol type="1">
<li><strong>unaware logistic regression classifier</strong>: model without including the sensitive attribute.</li>
<li><strong>aware logistic regression classifier</strong>: model with the sensitive attribute included in the set of features.</li>
</ol>
<p>The model is trained using the <code class="sourceCode r"><span class="fu">log_reg_train</span>()</code> function defined in <code>functions/utils.R</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>log_reg_train</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>function (train_data, test_data, type = c("aware", "unaware")) 
{
    if (type == "unaware") {
        train_data_ &lt;- train_data %&gt;% select(-S)
        test_data_ &lt;- test_data %&gt;% select(-S)
    }
    else {
        train_data_ &lt;- train_data
        test_data_ &lt;- test_data
    }
    model &lt;- glm(Y ~ ., data = train_data_, family = binomial)
    pred_train &lt;- predict(model, newdata = train_data_, type = "response")
    pred_test &lt;- predict(model, newdata = test_data_, type = "response")
    list(model = model, pred_train = pred_train, pred_test = pred_test)
}</code></pre>
</div>
</div>
<p>Let us train the two models. Then, we extract the predicted values on both the train set and the test set.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Unaware logistic regression classifier (model without S)</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>pred_unaware <span class="ot">&lt;-</span> <span class="fu">log_reg_train</span>(data_train, data_test, <span class="at">type =</span> <span class="st">"unaware"</span>)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>pred_unaware_train <span class="ot">&lt;-</span> pred_unaware<span class="sc">$</span>pred_train</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>pred_unaware_test <span class="ot">&lt;-</span> pred_unaware<span class="sc">$</span>pred_test</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Aware logistic regression classifier (model with S)</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>pred_aware <span class="ot">&lt;-</span> <span class="fu">log_reg_train</span>(data_train, data_test, <span class="at">type =</span> <span class="st">"aware"</span>)</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>pred_aware_train <span class="ot">&lt;-</span> pred_aware<span class="sc">$</span>pred_train</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>pred_aware_test <span class="ot">&lt;-</span> pred_aware<span class="sc">$</span>pred_test</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We create a table for each model, with the sensitive attribute and the predicted value by the model (()), only for observations from the test set.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>df_test_unaware <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">S =</span> data_test<span class="sc">$</span>S, </span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">pred =</span> pred_unaware_test</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>df_test_aware <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">S =</span> data_test<span class="sc">$</span>S, </span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">pred =</span> pred_aware_test</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="{panel-tabset}">
<section id="unaware" class="level3" data-number="1.3.1">
<h3 data-number="1.3.1" class="anchored" data-anchor-id="unaware"><span class="header-section-number">1.3.1</span> Unaware</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> df_test_unaware, </span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> pred, <span class="at">fill =</span> S)) <span class="sc">+</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">y =</span> ..density..), </span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">position =</span> <span class="st">"identity"</span>, <span class="at">binwidth =</span> <span class="fl">0.05</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Unaware Model, with S being Race"</span>,</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Predictions for Y"</span>,</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Density"</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">global_theme</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-density-pred-unaware" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-density-pred-unaware-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1.4: Density of predictions on the test set, for the unaware model, when the sensitive attribute is the race
</figcaption>
<div aria-describedby="fig-density-pred-unaware-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="law_dataset_files/figure-html/fig-density-pred-unaware-1.png" class="img-fluid figure-img" width="672">
</div>
</figure>
</div>
</div>
</div>
</section>
<section id="aware" class="level3" data-number="1.3.2">
<h3 data-number="1.3.2" class="anchored" data-anchor-id="aware"><span class="header-section-number">1.3.2</span> Aware</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> df_test_aware,</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> pred, <span class="at">fill =</span> S)) <span class="sc">+</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">y =</span> ..density..), </span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">position =</span> <span class="st">"identity"</span>, <span class="at">binwidth =</span> <span class="fl">0.05</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Aware Model, with S being Race"</span>,</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Predictions for Y"</span>,</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Density"</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">global_theme</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-density-pred-aware" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-density-pred-aware-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1.5: Density of predictions on the test set, for the aware model, when the sensitive attribute is the race
</figcaption>
<div aria-describedby="fig-density-pred-aware-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="law_dataset_files/figure-html/fig-density-pred-aware-1.png" class="img-fluid figure-img" width="672">
</div>
</figure>
</div>
</div>
</div>
</section>
</div>
</section>
<section id="counterfactual-inference" class="level2" data-number="1.4">
<h2 data-number="1.4" class="anchored" data-anchor-id="counterfactual-inference"><span class="header-section-number">1.4</span> Counterfactual inference</h2>
<p>Let us now turn to counterfactual inference. We will use three methods:</p>
<ol type="1">
<li>Fairadapt</li>
<li>Multivariate optimal transport</li>
<li>Sequential transport (the methodology we develop in the paper).</li>
</ol>
<section id="fairadapt" class="level3" data-number="1.4.1">
<h3 data-number="1.4.1" class="anchored" data-anchor-id="fairadapt"><span class="header-section-number">1.4.1</span> Fairadapt</h3>
<p>We adapt the code from <span class="citation" data-cites="plevcko2021fairadapt">Plečko, Bennett, and Meinshausen (<a href="references.html#ref-plevcko2021fairadapt" role="doc-biblioref">2021</a>)</span> to handle the test set. This avoids estimating cumulative distribution and quantile functions on the test set, which would otherwise necessitate recalculating quantile regression functions for each new sample.</p>
<p>We do not need to adapt Y here, so we need to remove it from the adjacency matrix:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>adj_wo_Y <span class="ot">&lt;-</span> adj[<span class="sc">-</span><span class="dv">4</span>,<span class="sc">-</span><span class="dv">4</span>]</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>adj_wo_Y</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   S X1 X2
S  0  1  1
X1 0  0  1
X2 0  0  0</code></pre>
</div>
</div>
<p>We create a dataset with the sensitive attribute and the two other predictors:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>df_race_fpt <span class="ot">&lt;-</span> df_race_c <span class="sc">|&gt;</span> <span class="fu">select</span>(S, X1, X2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let us have a look at the levels of our sensitive variable:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">levels</span>(df_race_fpt<span class="sc">$</span>S)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Black" "White"</code></pre>
</div>
</div>
<p>The reference class here consists of Black individuals.</p>
<p>Two configurations will be considered in turn:</p>
<ol type="1">
<li>The reference class consists of Black individuals, and FairAdapt will be used to obtain the counterfactual UGPA and LSAT scores for White individuals as if they had been Black.</li>
<li>The reference class consists of White individuals, and FairAdapt will be used to obtain the counterfactual UGPA and LSAT scores for Black individuals as if they had been White.</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># White (factuals) --&gt; Black (counterfactuals)</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>fpt_model_white <span class="ot">&lt;-</span> <span class="fu">fairadapt</span>(</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  X2 <span class="sc">~</span> ., </span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">train.data =</span> df_race_fpt,</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">prot.attr =</span> <span class="st">"S"</span>, <span class="at">adj.mat =</span> adj_wo_Y,</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">quant.method =</span> linearQuants</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>adapt_df_white <span class="ot">&lt;-</span> <span class="fu">adaptedData</span>(fpt_model_white)</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Black (factuals) --&gt; White (counterfactuals)</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>df_race_fpt<span class="sc">$</span>S <span class="ot">&lt;-</span> <span class="fu">factor</span>(df_race_fpt<span class="sc">$</span>S, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"White"</span>, <span class="st">"Black"</span>))</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>fpt_model_black <span class="ot">&lt;-</span> <span class="fu">fairadapt</span>(</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>  X2 <span class="sc">~</span> ., </span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">train.data =</span> df_race_fpt,</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">prot.attr =</span> <span class="st">"S"</span>, <span class="at">adj.mat =</span> adj_wo_Y,</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">quant.method =</span> linearQuants</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>adapt_df_black <span class="ot">&lt;-</span> <span class="fu">adaptedData</span>(fpt_model_black)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let us wrap up:</p>
<ul>
<li><p>we have two predictive models for the FYA (above median = 1, or below median = 0):</p>
<ul>
<li>unaware (without S)</li>
<li>aware (with S)</li>
</ul></li>
<li><p>we have the counterfactual characteristics obtained with fairadapt in two situations depending on the reference class:</p>
<ul>
<li>Black individuals as reference</li>
<li>White individuals as reference.</li>
</ul></li>
</ul>
<p>The predictive models will be used to compare predictions made using:</p>
<ul>
<li>Raw characteristics (initial characteristics).</li>
<li>Characteristics possibly altered through FairAdapt for individuals who were not in the reference group (i.e., using counterfactuals).</li>
</ul>
<section id="unaware-model" class="level4" data-number="1.4.1.1">
<h4 data-number="1.4.1.1" class="anchored" data-anchor-id="unaware-model"><span class="header-section-number">1.4.1.1</span> Unaware Model</h4>
<p>The predicted values using the initial characteristics, for the unaware model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>model_unaware <span class="ot">&lt;-</span> pred_unaware<span class="sc">$</span>model</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>pred_unaware_all <span class="ot">&lt;-</span> <span class="fu">predict</span>(</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  model_unaware, <span class="at">newdata =</span> df_race_fpt, <span class="at">type =</span> <span class="st">"response"</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We put in a table the initial characteristics (factuals) and the prediction made by the unaware model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>factuals_unaware <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">S =</span> df_race<span class="sc">$</span>S,</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">X1 =</span> df_race<span class="sc">$</span>X1,</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">X2 =</span> df_race<span class="sc">$</span>X2,</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">pred =</span> pred_unaware_all</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let us save this dataset in a csv file (this file will be used to perform multivariate transport in python).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  factuals_unaware, </span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="st">"data/factuals_unaware.csv"</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let us build a dataset containing only counterfactual characteristics (obtained with fairadapt): values for <span class="math inline">\(X_1\)</span> and <span class="math inline">\(X_2\)</span> of White individuals as if they had been Black, and values for <span class="math inline">\(X_1\)</span> and <span class="math inline">\(X_2\)</span> of Black individuals as if they had been White.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>ind_white <span class="ot">&lt;-</span> <span class="fu">which</span>(df_race_fpt<span class="sc">$</span>S <span class="sc">==</span> <span class="st">"White"</span>)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>ind_black <span class="ot">&lt;-</span> <span class="fu">which</span>(df_race_fpt<span class="sc">$</span>S <span class="sc">==</span> <span class="st">"Black"</span>)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>df_counterfactuals_fpt <span class="ot">&lt;-</span> factuals_unaware <span class="sc">|&gt;</span>  <span class="fu">select</span>(<span class="sc">-</span>pred)</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>df_counterfactuals_fpt[ind_white, ] <span class="ot">&lt;-</span> </span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>  adapt_df_white[ind_white, ] <span class="sc">|&gt;</span> <span class="fu">select</span>(S, X1, X2)</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>df_counterfactuals_fpt[ind_black, ] <span class="ot">&lt;-</span> </span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>  adapt_df_black[ind_black,] <span class="sc">|&gt;</span> <span class="fu">select</span>(S, X1, X2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let us get the predicted values for the counterfactuals, using the unaware model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>pred_unaware_fpt <span class="ot">&lt;-</span> <span class="fu">predict</span>(</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  model_unaware, <span class="at">newdata =</span> df_counterfactuals_fpt, <span class="at">type =</span> <span class="st">"response"</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We create a table with the counterfactual characteristics and the prediction by the unaware model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>counterfactuals_unaware_fpt <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">S =</span> df_counterfactuals_fpt<span class="sc">$</span>S,</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">X1 =</span> df_counterfactuals_fpt<span class="sc">$</span>X1,</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">X2 =</span> df_counterfactuals_fpt<span class="sc">$</span>X2,</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">pred =</span> pred_unaware_fpt</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We merge the two datasets, <code>factuals_unaware</code> and <code>counterfactuals_unaware_fpt</code> in a single one. We add a column, <code>type</code>, to state whether the row gives the initial observations and predictions or the counterfactuals and correspoonding predictions.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># dataset with factuals, for unaware model</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>factuals_unaware <span class="ot">&lt;-</span> factuals_unaware <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">type =</span> <span class="st">"factual"</span>)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="co"># dataset with counterfactuals, for unaware model</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>counterfactuals_unaware_fpt <span class="ot">&lt;-</span> counterfactuals_unaware_fpt <span class="sc">|&gt;</span> </span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">type =</span> <span class="st">"counterfactual"</span>)</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Bind the two:</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>unaware_fpt <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(factuals_unaware, counterfactuals_unaware_fpt)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, we can visualize the distribution of the values predicted by the unaware model within each group defined by the sensitive attribute.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>unaware_fpt_white <span class="ot">&lt;-</span> unaware_fpt <span class="sc">|&gt;</span> <span class="fu">filter</span>(S <span class="sc">==</span> <span class="st">"White"</span>) </span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>unaware_fpt_black <span class="ot">&lt;-</span> unaware_fpt <span class="sc">|&gt;</span> <span class="fu">filter</span>(S <span class="sc">==</span> <span class="st">"Black"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="{panel-tabset}">
<section id="ref-black" class="level5" data-number="1.4.1.1.1">
<h5 data-number="1.4.1.1.1" class="anchored" data-anchor-id="ref-black"><span class="header-section-number">1.4.1.1.1</span> Ref: Black</h5>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(unaware_fpt_black, <span class="fu">aes</span>(<span class="at">x =</span> pred, <span class="at">fill =</span> type)) <span class="sc">+</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">y =</span> ..density..), <span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">position =</span> <span class="st">"identity"</span>, <span class="at">binwidth =</span> <span class="fl">0.05</span>) <span class="sc">+</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Unaware model, Sensitive: Race, Reference: Black individuals"</span>,</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Predictions for Y"</span>,</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Density"</span>) <span class="sc">+</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">global_theme</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-fpt-unaware-race-ref-black" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-fpt-unaware-race-ref-black-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1.6: Unaware model, Sensitive: Race, Reference: Black individuals
</figcaption>
<div aria-describedby="fig-fpt-unaware-race-ref-black-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="law_dataset_files/figure-html/fig-fpt-unaware-race-ref-black-1.png" class="img-fluid figure-img" width="672">
</div>
</figure>
</div>
</div>
</div>
</section>
<section id="ref-white" class="level5" data-number="1.4.1.1.2">
<h5 data-number="1.4.1.1.2" class="anchored" data-anchor-id="ref-white"><span class="header-section-number">1.4.1.1.2</span> Ref: White</h5>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> unaware_fpt_white,</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> pred, <span class="at">fill =</span> type)</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">y =</span> ..density..), </span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">position =</span> <span class="st">"identity"</span>, <span class="at">binwidth =</span> <span class="fl">0.05</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Unaware model, Sensitive: Race, Reference: White individuals"</span>,</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Predictions for Y"</span>,</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Density"</span></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">global_theme</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-fpt-unaware-race-ref-white" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-fpt-unaware-race-ref-white-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1.7: Unaware model, Sensitive: Race, Reference: White individuals
</figcaption>
<div aria-describedby="fig-fpt-unaware-race-ref-white-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="law_dataset_files/figure-html/fig-fpt-unaware-race-ref-white-1.png" class="img-fluid figure-img" width="672">
</div>
</figure>
</div>
</div>
</div>
</section>
</div>
</section>
<section id="aware-model" class="level4" data-number="1.4.1.2">
<h4 data-number="1.4.1.2" class="anchored" data-anchor-id="aware-model"><span class="header-section-number">1.4.1.2</span> Aware Model</h4>
<p>Now, we turn to the model that includes the sensitive attribute, i.e., the aware model.</p>
<p>The predicted values by the model, on the initial characteristics (on the factuals):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>model_aware <span class="ot">&lt;-</span> pred_aware<span class="sc">$</span>model</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>pred_aware_all <span class="ot">&lt;-</span> <span class="fu">predict</span>(model_aware, <span class="at">newdata =</span> df_race_fpt, <span class="at">type =</span> <span class="st">"response"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We create a tibble with the factuals and the predictions by the aware model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>factuals_aware <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">S =</span> df_race<span class="sc">$</span>S,</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">X1 =</span> df_race<span class="sc">$</span>X1,</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">X2 =</span> df_race<span class="sc">$</span>X2,</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">pred =</span> pred_aware_all</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let us save this table in a CSV file (this file will be used to perform multivariate transport in python):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">write.csv</span>(factuals_aware, <span class="at">file =</span> <span class="st">"data/factuals_aware.csv"</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Recall we created an object called <code>df_counterfactuals_fpt</code> which contains the counterfactual characteristics of all students, obtained with fairadapt:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>df_counterfactuals_fpt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 19,567 × 3
   S        X1    X2
   &lt;fct&gt; &lt;dbl&gt; &lt;dbl&gt;
 1 Black  2.7   31.3
 2 Black  2.6   28  
 3 Black  2.7   21  
 4 Black  3.1   28.1
 5 Black  3.3   21.0
 6 Black  3.3   26.9
 7 Black  2.4   29.6
 8 Black  2.3   29.8
 9 Black  3.3   21  
10 Black  2.85  33.5
# ℹ 19,557 more rows</code></pre>
</div>
</div>
<p>We make predictions with the aware model on these counterfactuals:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>pred_aware_fpt <span class="ot">&lt;-</span> <span class="fu">predict</span>(</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>  model_aware, <span class="at">newdata =</span> df_counterfactuals_fpt, <span class="at">type =</span> <span class="st">"response"</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then, we create a table with the counterfactuals and the predicted value by the aware model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>counterfactuals_aware_fpt <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">S =</span> df_counterfactuals_fpt<span class="sc">$</span>S,</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">X1 =</span> df_counterfactuals_fpt<span class="sc">$</span>X1,</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">X2 =</span> df_counterfactuals_fpt<span class="sc">$</span>X2,</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">pred =</span> pred_aware_fpt</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We bind together the table with the factuals and the counterfactuals (as well as their predicted values by the aware model):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>factuals_aware <span class="ot">&lt;-</span> factuals_aware <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">type =</span> <span class="st">"factual"</span>)</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>counterfactuals_aware_fpt <span class="ot">&lt;-</span> counterfactuals_aware_fpt <span class="sc">|&gt;</span> </span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">type =</span> <span class="st">"counterfactual"</span>)</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>aware_fpt <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(factuals_aware, counterfactuals_aware_fpt)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Lastly, we can visualize the distribution of predicted values by the aware model once the characteristics of the individuals who are not on the reference group have been modified using fairadapt.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>aware_fpt_white <span class="ot">&lt;-</span> aware_fpt <span class="sc">%&gt;%</span> <span class="fu">filter</span>(S <span class="sc">==</span> <span class="st">"White"</span>) </span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>aware_fpt_black <span class="ot">&lt;-</span> aware_fpt <span class="sc">%&gt;%</span> <span class="fu">filter</span>(S <span class="sc">==</span> <span class="st">"Black"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="{panel-tabset}">
<section id="ref-black-1" class="level5" data-number="1.4.1.2.1">
<h5 data-number="1.4.1.2.1" class="anchored" data-anchor-id="ref-black-1"><span class="header-section-number">1.4.1.2.1</span> Ref: Black</h5>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> aware_fpt_black, </span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> pred, <span class="at">fill =</span> type)) <span class="sc">+</span></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">y =</span> ..density..), </span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">position =</span> <span class="st">"identity"</span>, <span class="at">binwidth =</span> <span class="fl">0.05</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Aware model, Sensitive: Race, Reference: Black individuals"</span>,</span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Predictions for Y"</span>,</span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Density"</span></span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">global_theme</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-fpt-aware-race-ref-black" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-fpt-aware-race-ref-black-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1.8: Aware model, Sensitive: Race, Reference: Black individuals
</figcaption>
<div aria-describedby="fig-fpt-aware-race-ref-black-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="law_dataset_files/figure-html/fig-fpt-aware-race-ref-black-1.png" class="img-fluid figure-img" width="672">
</div>
</figure>
</div>
</div>
</div>
</section>
<section id="ref-white-1" class="level5" data-number="1.4.1.2.2">
<h5 data-number="1.4.1.2.2" class="anchored" data-anchor-id="ref-white-1"><span class="header-section-number">1.4.1.2.2</span> Ref: White</h5>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> aware_fpt_white, </span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> pred, <span class="at">fill =</span> type)) <span class="sc">+</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">y =</span> ..density..), </span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">position =</span> <span class="st">"identity"</span>, <span class="at">binwidth =</span> <span class="fl">0.05</span>) <span class="sc">+</span></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Aware model, Sensitive: Race, Reference: White individuals"</span>,</span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Predictions for Y"</span>,</span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Density"</span></span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">global_theme</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-fpt-aware-race-ref-white" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-fpt-aware-race-ref-white-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1.9: Aware model, Sensitive: Race, Reference: White individuals
</figcaption>
<div aria-describedby="fig-fpt-aware-race-ref-white-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="law_dataset_files/figure-html/fig-fpt-aware-race-ref-white-1.png" class="img-fluid figure-img" width="672">
</div>
</figure>
</div>
</div>
</div>
</section>
</div>
</section>
<section id="comparison-for-two-individuals" class="level4" data-number="1.4.1.3">
<h4 data-number="1.4.1.3" class="anchored" data-anchor-id="comparison-for-two-individuals"><span class="header-section-number">1.4.1.3</span> Comparison for two individuals</h4>
<p>Let us focus on two individuals: the 24th (Black) and the 25th (White) of the dataset.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>(indiv_factuals_unaware <span class="ot">&lt;-</span> factuals_unaware[<span class="dv">24</span><span class="sc">:</span><span class="dv">25</span>, ])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 5
  S        X1    X2  pred type   
  &lt;fct&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;  
1 Black   2.8    29 0.300 factual
2 White   2.8    34 0.382 factual</code></pre>
</div>
</div>
<p>The characteristics of these two individuals would be, according to what was estimated using fairadapt, if the reference group was the one in which they do not belong:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>(indiv_counterfactuals_unaware_fpt <span class="ot">&lt;-</span> counterfactuals_unaware_fpt[<span class="dv">24</span><span class="sc">:</span><span class="dv">25</span>, ])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 5
  S        X1    X2  pred type          
  &lt;fct&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;         
1 White  3.25  37.6 0.509 counterfactual
2 Black  2.5   26   0.225 counterfactual</code></pre>
</div>
</div>
<p>We put the factuals and counterfactuals in a single table:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>indiv_unaware_fpt <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>  indiv_factuals_unaware <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">id =</span> <span class="fu">c</span>(<span class="dv">24</span>, <span class="dv">25</span>)), </span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>  indiv_counterfactuals_unaware_fpt <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">id =</span> <span class="fu">c</span>(<span class="dv">24</span>, <span class="dv">25</span>))</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>indiv_unaware_fpt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 6
  S        X1    X2  pred type              id
  &lt;fct&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;          &lt;dbl&gt;
1 Black  2.8   29   0.300 factual           24
2 White  2.8   34   0.382 factual           25
3 White  3.25  37.6 0.509 counterfactual    24
4 Black  2.5   26   0.225 counterfactual    25</code></pre>
</div>
</div>
<p>The difference between the counterfactual and the factual for these two individuals:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>indiv_unaware_fpt <span class="sc">|&gt;</span> <span class="fu">select</span>(id , type, pred) <span class="sc">|&gt;</span> </span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> type, <span class="at">values_from =</span> pred) <span class="sc">|&gt;</span> </span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">diff_fpt =</span> counterfactual <span class="sc">-</span> factual)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 4
     id factual counterfactual diff_fpt
  &lt;dbl&gt;   &lt;dbl&gt;          &lt;dbl&gt;    &lt;dbl&gt;
1    24   0.300          0.509    0.209
2    25   0.382          0.225   -0.157</code></pre>
</div>
</div>
<p>We apply the same procedure with the aware model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>indiv_aware_fpt <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>  factuals_aware[<span class="fu">c</span>(<span class="dv">24</span>, <span class="dv">25</span>),] <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">id =</span> <span class="fu">c</span>(<span class="dv">24</span>, <span class="dv">25</span>)),</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>  counterfactuals_aware_fpt[<span class="fu">c</span>(<span class="dv">24</span>, <span class="dv">25</span>),] <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">id =</span> <span class="fu">c</span>(<span class="dv">24</span>, <span class="dv">25</span>))</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>indiv_aware_fpt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 6
  S        X1    X2   pred type              id
  &lt;fct&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;          &lt;dbl&gt;
1 Black  2.8   29   0.133  factual           24
2 White  2.8   34   0.413  factual           25
3 White  3.25  37.6 0.522  counterfactual    24
4 Black  2.5   26   0.0991 counterfactual    25</code></pre>
</div>
</div>
<p>The difference between the counterfactual and the factual for these two individuals, when using the aware model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>indiv_aware_fpt <span class="sc">|&gt;</span> <span class="fu">select</span>(id , type, pred) <span class="sc">|&gt;</span> </span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> type, <span class="at">values_from =</span> pred) <span class="sc">|&gt;</span> </span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">diff =</span> counterfactual <span class="sc">-</span> factual)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 4
     id factual counterfactual   diff
  &lt;dbl&gt;   &lt;dbl&gt;          &lt;dbl&gt;  &lt;dbl&gt;
1    24   0.133         0.522   0.389
2    25   0.413         0.0991 -0.314</code></pre>
</div>
</div>
</section>
<section id="demographic-parity" class="level4" data-number="1.4.1.4">
<h4 data-number="1.4.1.4" class="anchored" data-anchor-id="demographic-parity"><span class="header-section-number">1.4.1.4</span> Demographic Parity</h4>
<p>Let us assume here that the reference group is “White individuals” (i.e., the group with the most individuals in the dataset). We focus on the minority, i.e., Black individuals. We consider here that the model is fair towards the minority class if: <span class="math display">\[
P(\hat{Y}_{S \leftarrow \text{White}} = 1 | S = \text{Black}, X_1, X_2) = P(\hat{Y} = 1 | S = \text{White}, X_1, X_2)
\]</span> If the model is fair with respect to this criterion, the proportion of Black individuals predicted to have grades above the median should be the same as if they had been white.</p>
<p>For predictions made with the unaware model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>dp_unaware_fpt <span class="ot">&lt;-</span> <span class="fu">mean</span>(</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>  counterfactuals_unaware_fpt <span class="sc">|&gt;</span> <span class="fu">filter</span>(S <span class="sc">==</span> <span class="st">"White"</span>) <span class="sc">|&gt;</span> <span class="fu">pull</span>(<span class="st">"pred"</span>) <span class="sc">-</span> </span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>    factuals_unaware <span class="sc">|&gt;</span> <span class="fu">filter</span>(S <span class="sc">==</span> <span class="st">"Black"</span>) <span class="sc">|&gt;</span> <span class="fu">pull</span>(<span class="st">"pred"</span>)</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>dp_unaware_fpt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.19177</code></pre>
</div>
</div>
<p>We do the same with the aware model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>dp_aware_fpt <span class="ot">&lt;-</span> <span class="fu">mean</span>(</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>  counterfactuals_aware_fpt <span class="sc">|&gt;</span> <span class="fu">filter</span>(S <span class="sc">==</span> <span class="st">"White"</span>) <span class="sc">|&gt;</span> <span class="fu">pull</span>(<span class="st">"pred"</span>) <span class="sc">-</span> </span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>    factuals_aware <span class="sc">|&gt;</span> <span class="fu">filter</span>(S <span class="sc">==</span> <span class="st">"Black"</span>) <span class="sc">|&gt;</span> <span class="fu">pull</span>(<span class="st">"pred"</span>)</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>dp_aware_fpt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.3809912</code></pre>
</div>
</div>
</section>
</section>
<section id="multivariate-optimal-transport" class="level3" data-number="1.4.2">
<h3 data-number="1.4.2" class="anchored" data-anchor-id="multivariate-optimal-transport"><span class="header-section-number">1.4.2</span> Multivariate Optimal Transport</h3>
<p>We apply multivariate optimal transport (OT), following the methodology developed in <span class="citation" data-cites="de2024transport">De Lara et al. (<a href="references.html#ref-de2024transport" role="doc-biblioref">2024</a>)</span>. Note that with OT, it is not possible to handle new cases. Counterfactuals will only be calculated on the train set.</p>
<p>The codes are run in python. We use the {reticulate} R package to call python in this notebook.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(reticulate)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Some libraries need to be loaded (including POT called ot)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> ot</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> pl</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> ot.plot</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The data with the factuals need to be loaded:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>df_aware <span class="op">=</span> pd.read_csv(<span class="st">'data/factuals_aware.csv'</span>)</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>df_unaware <span class="op">=</span> pd.read_csv(<span class="st">'data/factuals_unaware.csv'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>x_S <span class="op">=</span> df_aware.drop(columns<span class="op">=</span>[<span class="st">'pred'</span>])</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>x_S.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       S   X1    X2
0  White  3.1  39.0
1  White  3.0  36.0
2  White  3.1  30.0
3  White  3.4  37.0
4  White  3.6  30.5</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>x_white <span class="op">=</span> x_S[x_S[<span class="st">'S'</span>] <span class="op">==</span> <span class="st">'White'</span>]</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>x_white <span class="op">=</span> x_white.drop(columns<span class="op">=</span>[<span class="st">'S'</span>])</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>x_black <span class="op">=</span> x_S[x_S[<span class="st">'S'</span>] <span class="op">==</span> <span class="st">'Black'</span>]</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>x_black <span class="op">=</span> x_black.drop(columns<span class="op">=</span>[<span class="st">'S'</span>])</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>n_white <span class="op">=</span> <span class="bu">len</span>(x_white)</span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>n_black <span class="op">=</span> <span class="bu">len</span>(x_black)</span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Uniform weights</span></span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a>w_white <span class="op">=</span> (<span class="dv">1</span><span class="op">/</span>n_white)<span class="op">*</span>np.ones(n_white)</span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a>w_black <span class="op">=</span> (<span class="dv">1</span><span class="op">/</span>n_black)<span class="op">*</span>np.ones(n_black)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Cost matrix between both distributions:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>x_white <span class="op">=</span> x_white.to_numpy()</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>x_black <span class="op">=</span> x_black.to_numpy()</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>C <span class="op">=</span> ot.dist(x_white, x_black)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>pl.figure(<span class="dv">1</span>)</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>pl.plot(x_white[:, <span class="dv">0</span>], x_white[:, <span class="dv">1</span>], <span class="st">'+b'</span>, label<span class="op">=</span><span class="st">'Source samples'</span>)</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>pl.plot(x_black[:, <span class="dv">0</span>], x_black[:, <span class="dv">1</span>], <span class="st">'xr'</span>, label<span class="op">=</span><span class="st">'Target samples'</span>)</span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>pl.legend(loc<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>pl.title(<span class="st">'Source and target distributions'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-ot-source-target-distrib" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-ot-source-target-distrib-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1.10: Source and target distributions
</figcaption>
<div aria-describedby="fig-ot-source-target-distrib-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="law_dataset_files/figure-html/fig-ot-source-target-distrib-1.png" class="img-fluid figure-img" width="672">
</div>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>pl.figure(<span class="dv">2</span>)</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>pl.imshow(C, interpolation<span class="op">=</span><span class="st">'nearest'</span>)</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>pl.title(<span class="st">'Cost matrix C'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-ot-cost-matrix" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-ot-cost-matrix-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1.11: Cost matric C
</figcaption>
<div aria-describedby="fig-ot-cost-matrix-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="law_dataset_files/figure-html/fig-ot-cost-matrix-3.png" class="img-fluid figure-img" width="672">
</div>
</figure>
</div>
</div>
</div>
<p>The transport plan: white –&gt; black</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>pi_white_black <span class="op">=</span> ot.emd(w_white, w_black, C, numItermax<span class="op">=</span><span class="fl">1e8</span>)</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>pi_black_white <span class="op">=</span> pi_white_black.T</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>pi_white_black.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(18285, 1282)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>sum_of_rows <span class="op">=</span> np.<span class="bu">sum</span>(pi_white_black, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>sum_of_rows<span class="op">*</span>n_white</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>array([1., 1., 1., ..., 1., 1., 1.])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>pi_black_white.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(1282, 18285)</code></pre>
</div>
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>sum_of_rows <span class="op">=</span> np.<span class="bu">sum</span>(pi_black_white, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>sum_of_rows<span class="op">*</span>n_black</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>array([1., 1., 1., ..., 1., 1., 1.])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>pl.figure(<span class="dv">3</span>)</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>pl.imshow(pi_white_black, interpolation<span class="op">=</span><span class="st">'nearest'</span>)</span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>pl.title(<span class="st">'OT matrix pi_white_black'</span>)</span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>pl.figure(<span class="dv">4</span>)</span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a>ot.plot.plot2D_samples_mat(x_white, x_black, pi_white_black, c<span class="op">=</span>[<span class="fl">.5</span>, <span class="fl">.5</span>, <span class="dv">1</span>])</span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a>pl.plot(x_white[:, <span class="dv">0</span>], x_white[:, <span class="dv">1</span>], <span class="st">'+b'</span>, label<span class="op">=</span><span class="st">'Source samples'</span>)</span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a>pl.plot(x_black[:, <span class="dv">0</span>], x_black[:, <span class="dv">1</span>], <span class="st">'xr'</span>, label<span class="op">=</span><span class="st">'Target samples'</span>)</span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a>pl.legend(loc<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true" tabindex="-1"></a>pl.title(<span class="st">'OT matrix with samples'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-ot-matrix-pi-white-black" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-ot-matrix-pi-white-black-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1.12: OT matrix pi_white_black
</figcaption>
<div aria-describedby="fig-ot-matrix-pi-white-black-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="law_dataset_files/figure-html/fig-ot-matrix-pi-white-black-5.png" class="img-fluid figure-img" width="672">
</div>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>transformed_x_white <span class="op">=</span> n_white<span class="op">*</span>pi_white_black<span class="op">@</span>x_black</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="law_dataset_files/figure-html/define-transformed_x_white-7.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>transformed_x_white.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(18285, 2)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>transformed_x_white</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>array([[ 2.7, 31. ],
       [ 2.7, 28. ],
       [ 2.6, 21. ],
       ...,
       [ 3.9, 28. ],
       [ 2.5, 22. ],
       [ 3. , 19. ]])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>transformed_x_black <span class="op">=</span> n_black<span class="op">*</span>pi_black_white<span class="op">@</span>x_white</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>transformed_x_black.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(1282, 2)</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>transformed_x_black</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>array([[ 3.2       , 37.58851518],
       [ 3.28565491, 28.02103363],
       [ 2.95793273, 32.14022423],
       ...,
       [ 3.28597758, 33.        ],
       [ 2.65092152, 41.43910309],
       [ 2.75152858, 36.        ]])</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>counterfactual_x <span class="op">=</span> x_S.drop(columns<span class="op">=</span>[<span class="st">'S'</span>])</span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>counterfactual_x[x_S[<span class="st">'S'</span>] <span class="op">==</span> <span class="st">'White'</span>] <span class="op">=</span> transformed_x_white</span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>counterfactual_x[x_S[<span class="st">'S'</span>] <span class="op">==</span> <span class="st">'Black'</span>] <span class="op">=</span> transformed_x_black</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>counterfactual_x.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    X1    X2
0  2.7  31.0
1  2.7  28.0
2  2.6  21.0
3  3.1  28.0
4  3.2  21.0</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>counterfactual_x.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(19567, 2)</code></pre>
</div>
</div>
<p>Lastly, we export the results in a CSV file:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>csv_file_path <span class="op">=</span> <span class="st">'data/counterfactuals_ot.csv'</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>counterfactual_x.to_csv(csv_file_path, index<span class="op">=</span><span class="va">False</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let us get back to R, and load the results.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>counterfactuals_ot <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">'data/counterfactuals_ot.csv'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We add the sensitive attribute to the dataset (Black individuals become White, and conversely):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>counterfactuals_ot <span class="ot">&lt;-</span> counterfactuals_ot <span class="sc">|&gt;</span> </span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">S =</span> counterfactuals_unaware_fpt<span class="sc">$</span>S)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="unaware-model-1" class="level4" data-number="1.4.2.1">
<h4 data-number="1.4.2.1" class="anchored" data-anchor-id="unaware-model-1"><span class="header-section-number">1.4.2.1</span> Unaware Model</h4>
<p>Let us make prediction with the unaware model on the counterfactuals obtained with OT:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>pred_unaware_ot <span class="ot">&lt;-</span> <span class="fu">predict</span>(</span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a>  model_unaware, <span class="at">newdata =</span> counterfactuals_ot, <span class="at">type =</span> <span class="st">"response"</span></span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a>counterfactuals_unaware_ot <span class="ot">&lt;-</span> counterfactuals_ot <span class="sc">|&gt;</span> </span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">pred =</span> pred_unaware_ot, <span class="at">type =</span> <span class="st">"counterfactual"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We bind the factuals and counterfactuals with their respective predicted values in a single dataset:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>unaware_ot <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># predicted values on factuals</span></span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a>  factuals_unaware, </span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># predicted values on counterfactuals obtained with OT</span></span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a>  counterfactuals_unaware_ot</span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then, we can visualize the distribution of the values predicted by the unaware model within each group defined by the sensitive attribute.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>unaware_ot_white <span class="ot">&lt;-</span> unaware_ot <span class="sc">%&gt;%</span> <span class="fu">filter</span>(S <span class="sc">==</span> <span class="st">"White"</span>) </span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>unaware_ot_black <span class="ot">&lt;-</span> unaware_ot <span class="sc">%&gt;%</span> <span class="fu">filter</span>(S <span class="sc">==</span> <span class="st">"Black"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>:::{panel-tabset}</p>
<section id="ref-black-2" class="level5" data-number="1.4.2.1.1">
<h5 data-number="1.4.2.1.1" class="anchored" data-anchor-id="ref-black-2"><span class="header-section-number">1.4.2.1.1</span> Ref: Black</h5>
<div class="cell">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(</span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> unaware_ot_black, </span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> pred, <span class="at">fill =</span> type)</span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span></span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(</span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">y =</span> ..density..), </span>
<span id="cb104-7"><a href="#cb104-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">position =</span> <span class="st">"identity"</span>, <span class="at">binwidth =</span> <span class="fl">0.05</span></span>
<span id="cb104-8"><a href="#cb104-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb104-9"><a href="#cb104-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb104-10"><a href="#cb104-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb104-11"><a href="#cb104-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Unaware model, Sensitive: Race, Reference: Black individual"</span>,</span>
<span id="cb104-12"><a href="#cb104-12" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Predictions for Y"</span>,</span>
<span id="cb104-13"><a href="#cb104-13" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Density"</span></span>
<span id="cb104-14"><a href="#cb104-14" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb104-15"><a href="#cb104-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">global_theme</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-ot-unaware-race-ref-black" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-ot-unaware-race-ref-black-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1.13: Unaware model, Sensitive: Race, Reference: Black individuals
</figcaption>
<div aria-describedby="fig-ot-unaware-race-ref-black-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="law_dataset_files/figure-html/fig-ot-unaware-race-ref-black-1.png" class="img-fluid figure-img" width="672">
</div>
</figure>
</div>
</div>
</div>
</section>
<section id="ref-white-2" class="level5" data-number="1.4.2.1.2">
<h5 data-number="1.4.2.1.2" class="anchored" data-anchor-id="ref-white-2"><span class="header-section-number">1.4.2.1.2</span> Ref: White</h5>
<div class="cell">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(</span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> unaware_ot_white, </span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> pred, <span class="at">fill =</span> type)) <span class="sc">+</span></span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(</span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">y =</span> ..density..), </span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">position =</span> <span class="st">"identity"</span>, <span class="at">binwidth =</span> <span class="fl">0.05</span></span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb105-8"><a href="#cb105-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb105-9"><a href="#cb105-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb105-10"><a href="#cb105-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Unaware model, Sensitive: Race, Reference: White"</span>,</span>
<span id="cb105-11"><a href="#cb105-11" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Predictions for Y"</span>,</span>
<span id="cb105-12"><a href="#cb105-12" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Density"</span>) <span class="sc">+</span></span>
<span id="cb105-13"><a href="#cb105-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">global_theme</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-ot-unaware-race-ref-white" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-ot-unaware-race-ref-white-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1.14: Unaware model, Sensitive: Race, Reference: White individuals
</figcaption>
<div aria-describedby="fig-ot-unaware-race-ref-white-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="law_dataset_files/figure-html/fig-ot-unaware-race-ref-white-1.png" class="img-fluid figure-img" width="672">
</div>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="aware-model-1" class="level4" data-number="1.4.2.2">
<h4 data-number="1.4.2.2" class="anchored" data-anchor-id="aware-model-1"><span class="header-section-number">1.4.2.2</span> Aware Model</h4>
<p>Let us make prediction with the aware model on the counterfactuals obtained with OT:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>pred_aware_ot <span class="ot">&lt;-</span> <span class="fu">predict</span>(</span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>  model_aware, <span class="at">newdata =</span> counterfactuals_ot, <span class="at">type =</span> <span class="st">"response"</span></span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a>counterfactuals_aware_ot <span class="ot">&lt;-</span> counterfactuals_ot <span class="sc">|&gt;</span>  </span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">pred =</span> pred_aware_ot, <span class="at">type =</span> <span class="st">"counterfactual"</span>)</span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a>counterfactuals_aware_ot</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 19,567 × 5
      X1    X2 S       pred type          
   &lt;dbl&gt; &lt;dbl&gt; &lt;fct&gt;  &lt;dbl&gt; &lt;chr&gt;         
 1   2.7  31   Black 0.141  counterfactual
 2   2.7  28   Black 0.120  counterfactual
 3   2.6  21   Black 0.0791 counterfactual
 4   3.1  28   Black 0.143  counterfactual
 5   3.2  21   Black 0.104  counterfactual
 6   3.3  27.5 Black 0.152  counterfactual
 7   2.4  29   Black 0.111  counterfactual
 8   2.3  29   Black 0.106  counterfactual
 9   3.3  22   Black 0.115  counterfactual
10   2.8  34   Black 0.171  counterfactual
# ℹ 19,557 more rows</code></pre>
</div>
</div>
<p>We bind the factuals and counterfactuals with their respective predicted values in a single dataset:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a>aware_ot <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a>  factuals_aware, </span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a>  counterfactuals_aware_ot</span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then, we can visualize the distribution of the values predicted by the unaware model within each group defined by the sensitive attribute.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>aware_ot_white <span class="ot">&lt;-</span> aware_ot <span class="sc">|&gt;</span> <span class="fu">filter</span>(S <span class="sc">==</span> <span class="st">"White"</span>) </span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>aware_ot_black <span class="ot">&lt;-</span> aware_ot <span class="sc">|&gt;</span>  <span class="fu">filter</span>(S <span class="sc">==</span> <span class="st">"Black"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="{panel-tabset}">
<section id="ref-black-3" class="level5" data-number="1.4.2.2.1">
<h5 data-number="1.4.2.2.1" class="anchored" data-anchor-id="ref-black-3"><span class="header-section-number">1.4.2.2.1</span> Ref: Black</h5>
<div class="cell">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(</span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> aware_ot_black, </span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> pred, <span class="at">fill =</span> type)</span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span></span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(</span>
<span id="cb110-6"><a href="#cb110-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">y =</span> ..density..), </span>
<span id="cb110-7"><a href="#cb110-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">position =</span> <span class="st">"identity"</span>, <span class="at">binwidth =</span> <span class="fl">0.05</span></span>
<span id="cb110-8"><a href="#cb110-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb110-9"><a href="#cb110-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb110-10"><a href="#cb110-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb110-11"><a href="#cb110-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Aware model, Sensitive: Race, Reference: Black individual"</span>,</span>
<span id="cb110-12"><a href="#cb110-12" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Predictions for Y"</span>,</span>
<span id="cb110-13"><a href="#cb110-13" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Density"</span></span>
<span id="cb110-14"><a href="#cb110-14" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb110-15"><a href="#cb110-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">global_theme</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-ot-aware-race-ref-black" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-ot-aware-race-ref-black-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1.15: Aware model, Sensitive: Race, Reference: Black individuals
</figcaption>
<div aria-describedby="fig-ot-aware-race-ref-black-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="law_dataset_files/figure-html/fig-ot-aware-race-ref-black-1.png" class="img-fluid figure-img" width="672">
</div>
</figure>
</div>
</div>
</div>
</section>
<section id="ref-white-3" class="level5" data-number="1.4.2.2.2">
<h5 data-number="1.4.2.2.2" class="anchored" data-anchor-id="ref-white-3"><span class="header-section-number">1.4.2.2.2</span> Ref: White</h5>
<div class="cell">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(</span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> aware_ot_white, </span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> pred, <span class="at">fill =</span> type)) <span class="sc">+</span></span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(</span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">y =</span> ..density..), </span>
<span id="cb111-6"><a href="#cb111-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">position =</span> <span class="st">"identity"</span>, <span class="at">binwidth =</span> <span class="fl">0.05</span></span>
<span id="cb111-7"><a href="#cb111-7" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb111-8"><a href="#cb111-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb111-9"><a href="#cb111-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb111-10"><a href="#cb111-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Aware model, Sensitive: Race, Reference: White"</span>,</span>
<span id="cb111-11"><a href="#cb111-11" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Predictions for Y"</span>,</span>
<span id="cb111-12"><a href="#cb111-12" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Density"</span>) <span class="sc">+</span></span>
<span id="cb111-13"><a href="#cb111-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">global_theme</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-ot-aware-race-ref-white" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-ot-aware-race-ref-white-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1.16: Aware model, Sensitive: Race, Reference: White individuals
</figcaption>
<div aria-describedby="fig-ot-aware-race-ref-white-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="law_dataset_files/figure-html/fig-ot-aware-race-ref-white-1.png" class="img-fluid figure-img" width="672">
</div>
</figure>
</div>
</div>
</div>
</section>
</div>
</section>
<section id="comparison-for-two-individuals-1" class="level4" data-number="1.4.2.3">
<h4 data-number="1.4.2.3" class="anchored" data-anchor-id="comparison-for-two-individuals-1"><span class="header-section-number">1.4.2.3</span> Comparison for two individuals</h4>
<p>Let us, again, focus on two individuals: 24 (Black) and 25 (White):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a>indiv_factuals_unaware</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 5
  S        X1    X2  pred type   
  &lt;fct&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;  
1 Black   2.8    29 0.300 factual
2 White   2.8    34 0.382 factual</code></pre>
</div>
</div>
<p>The counterfactuals for those individuals, using the unaware model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a>(indiv_counterfactuals_unaware_ot <span class="ot">&lt;-</span> counterfactuals_unaware_ot[<span class="dv">24</span><span class="sc">:</span><span class="dv">25</span>, ])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 5
     X1    X2 S      pred type          
  &lt;dbl&gt; &lt;dbl&gt; &lt;fct&gt; &lt;dbl&gt; &lt;chr&gt;         
1  3.20  37.6 White 0.502 counterfactual
2  2.4   25   Black 0.203 counterfactual</code></pre>
</div>
</div>
<p>Let us put the factuals and counterfactuals in a single table:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>indiv_unaware_ot <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a>  indiv_factuals_unaware <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">id =</span> <span class="fu">c</span>(<span class="dv">24</span>, <span class="dv">25</span>)),</span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a>  indiv_counterfactuals_unaware_ot <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">id =</span> <span class="fu">c</span>(<span class="dv">24</span>, <span class="dv">25</span>))</span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true" tabindex="-1"></a>indiv_unaware_ot</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 6
  S        X1    X2  pred type              id
  &lt;fct&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;          &lt;dbl&gt;
1 Black  2.8   29   0.300 factual           24
2 White  2.8   34   0.382 factual           25
3 White  3.20  37.6 0.502 counterfactual    24
4 Black  2.4   25   0.203 counterfactual    25</code></pre>
</div>
</div>
<p>We compute the difference between the predicted value by the unaware model using the counterfactuals and the predicted value by the unaware model using the factuals:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a>indiv_unaware_ot <span class="sc">|&gt;</span> <span class="fu">select</span>(id , type, pred) <span class="sc">|&gt;</span> </span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> type, <span class="at">values_from =</span> pred) <span class="sc">|&gt;</span> </span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">diff =</span> counterfactual <span class="sc">-</span> factual)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 4
     id factual counterfactual   diff
  &lt;dbl&gt;   &lt;dbl&gt;          &lt;dbl&gt;  &lt;dbl&gt;
1    24   0.300          0.502  0.202
2    25   0.382          0.203 -0.179</code></pre>
</div>
</div>
<p>We do the same for the aware model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a>indiv_aware_ot <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>  factuals_aware[<span class="fu">c</span>(<span class="dv">24</span>, <span class="dv">25</span>),] <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">id =</span> <span class="fu">c</span>(<span class="dv">24</span>, <span class="dv">25</span>)),</span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a>  counterfactuals_aware_ot[<span class="fu">c</span>(<span class="dv">24</span>, <span class="dv">25</span>),] <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">id =</span> <span class="fu">c</span>(<span class="dv">24</span>, <span class="dv">25</span>))</span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a>indiv_aware_ot</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 6
  S        X1    X2   pred type              id
  &lt;fct&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;          &lt;dbl&gt;
1 Black  2.8   29   0.133  factual           24
2 White  2.8   34   0.413  factual           25
3 White  3.20  37.6 0.515  counterfactual    24
4 Black  2.4   25   0.0898 counterfactual    25</code></pre>
</div>
</div>
<p>The difference between the counterfactual and the factual for these two individuals, when using the aware model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a>indiv_aware_ot <span class="sc">|&gt;</span> <span class="fu">select</span>(id , type, pred) <span class="sc">|&gt;</span> </span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> type, <span class="at">values_from =</span> pred) <span class="sc">|&gt;</span> </span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">diff =</span> counterfactual <span class="sc">-</span> factual)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 4
     id factual counterfactual   diff
  &lt;dbl&gt;   &lt;dbl&gt;          &lt;dbl&gt;  &lt;dbl&gt;
1    24   0.133         0.515   0.383
2    25   0.413         0.0898 -0.323</code></pre>
</div>
</div>
</section>
<section id="demographic-parity-1" class="level4" data-number="1.4.2.4">
<h4 data-number="1.4.2.4" class="anchored" data-anchor-id="demographic-parity-1"><span class="header-section-number">1.4.2.4</span> Demographic Parity</h4>
<p>As for the counterfactuals obtained with fairadapt, we assume here that the reference group is “White individuals” (i.e., the group with the most individuals in the dataset). We focus on the minority, i.e., Black individuals. We consider here that the model is fair towards the minority class if: <span class="math display">\[
P(\hat{Y}_{S \leftarrow \text{White}} = 1 | S = \text{Black}, X_1, X_2) = P(\hat{Y} = 1 | S = \text{White}, X_1, X_2)
\]</span> If the model is fair with respect to this criterion, the proportion of Black individuals predicted to have grades above the median should be the same as if they had been white.</p>
<p>For predictions made with the unaware model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a>dp_unaware_pt <span class="ot">&lt;-</span> <span class="fu">mean</span>(</span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a>  counterfactuals_unaware_ot <span class="sc">|&gt;</span> <span class="fu">filter</span>(S <span class="sc">==</span> <span class="st">"White"</span>) <span class="sc">|&gt;</span> <span class="fu">pull</span>(<span class="st">"pred"</span>) <span class="sc">-</span> </span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a>    factuals_unaware <span class="sc">|&gt;</span> <span class="fu">filter</span>(S <span class="sc">==</span> <span class="st">"Black"</span>) <span class="sc">|&gt;</span> <span class="fu">pull</span>(<span class="st">"pred"</span>)</span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb124-5"><a href="#cb124-5" aria-hidden="true" tabindex="-1"></a>dp_unaware_pt</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.1821212</code></pre>
</div>
</div>
<p>We do the same with the aware model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a>dp_aware_ot <span class="ot">&lt;-</span> <span class="fu">mean</span>(</span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a>  counterfactuals_aware_ot <span class="sc">|&gt;</span> <span class="fu">filter</span>(S <span class="sc">==</span> <span class="st">"White"</span>) <span class="sc">|&gt;</span> <span class="fu">pull</span>(<span class="st">"pred"</span>) <span class="sc">-</span> </span>
<span id="cb126-3"><a href="#cb126-3" aria-hidden="true" tabindex="-1"></a>    factuals_aware <span class="sc">|&gt;</span> <span class="fu">filter</span>(S <span class="sc">==</span> <span class="st">"Black"</span>) <span class="sc">|&gt;</span> <span class="fu">pull</span>(<span class="st">"pred"</span>)</span>
<span id="cb126-4"><a href="#cb126-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb126-5"><a href="#cb126-5" aria-hidden="true" tabindex="-1"></a>dp_aware_ot</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.3726591</code></pre>
</div>
</div>
</section>
</section>
<section id="sequential-transport" class="level3" data-number="1.4.3">
<h3 data-number="1.4.3" class="anchored" data-anchor-id="sequential-transport"><span class="header-section-number">1.4.3</span> Sequential transport</h3>
<p>Lastly, we turn to sequential transport (the methodology developed in our paper). We define a function, <code class="sourceCode r"><span class="fu">fonction_transport</span>()</code> (see in <code>functions/utils.R</code>) to perform a fast sequential transport on causal graph.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="co">#' Sequential transport</span></span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a><span class="co">#'</span></span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param data dataset with three columns:</span></span>
<span id="cb128-4"><a href="#cb128-4" aria-hidden="true" tabindex="-1"></a><span class="co">#'  - S: sensitive attribute, factor White/Black</span></span>
<span id="cb128-5"><a href="#cb128-5" aria-hidden="true" tabindex="-1"></a><span class="co">#'  - X1: first predictor, assumed to be causally linked to S</span></span>
<span id="cb128-6"><a href="#cb128-6" aria-hidden="true" tabindex="-1"></a><span class="co">#'  - X2: second predictor, assumed to be causally linked to S and X1</span></span>
<span id="cb128-7"><a href="#cb128-7" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param number of cells in each dimension (default to 15)</span></span>
<span id="cb128-8"><a href="#cb128-8" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param h small value added to extend the area covered by the grid (default</span></span>
<span id="cb128-9"><a href="#cb128-9" aria-hidden="true" tabindex="-1"></a><span class="co">#'  to .2)</span></span>
<span id="cb128-10"><a href="#cb128-10" aria-hidden="true" tabindex="-1"></a><span class="co">#' @param d neighborhood weight when conditioning by x1 (default to .5)</span></span>
<span id="cb128-11"><a href="#cb128-11" aria-hidden="true" tabindex="-1"></a>fonction_transport <span class="ot">&lt;-</span> <span class="cf">function</span>(data,</span>
<span id="cb128-12"><a href="#cb128-12" aria-hidden="true" tabindex="-1"></a>                              <span class="at">n_grid =</span> <span class="dv">15</span>,</span>
<span id="cb128-13"><a href="#cb128-13" aria-hidden="true" tabindex="-1"></a>                              <span class="at">h =</span> .<span class="dv">2</span>,</span>
<span id="cb128-14"><a href="#cb128-14" aria-hidden="true" tabindex="-1"></a>                              <span class="at">d =</span> .<span class="dv">5</span>) {</span>
<span id="cb128-15"><a href="#cb128-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-16"><a href="#cb128-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Subset of the data: 0 for Black, 1 for White</span></span>
<span id="cb128-17"><a href="#cb128-17" aria-hidden="true" tabindex="-1"></a>  D_SXY_0 <span class="ot">&lt;-</span> data[data<span class="sc">$</span>S <span class="sc">==</span><span class="st">"Black"</span>, ]</span>
<span id="cb128-18"><a href="#cb128-18" aria-hidden="true" tabindex="-1"></a>  D_SXY_1 <span class="ot">&lt;-</span> data[data<span class="sc">$</span>S <span class="sc">==</span><span class="st">"White"</span>, ]</span>
<span id="cb128-19"><a href="#cb128-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-20"><a href="#cb128-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Coordinates of the cells of the grid on subset of 0 (Black)</span></span>
<span id="cb128-21"><a href="#cb128-21" aria-hidden="true" tabindex="-1"></a>  vx1_0 <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fu">min</span>(D_SXY_0<span class="sc">$</span>X1) <span class="sc">-</span> h, <span class="fu">max</span>(D_SXY_0<span class="sc">$</span>X1) <span class="sc">+</span> h, <span class="at">length =</span> n_grid <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb128-22"><a href="#cb128-22" aria-hidden="true" tabindex="-1"></a>  vx2_0 <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fu">min</span>(D_SXY_0<span class="sc">$</span>X2) <span class="sc">-</span> h, <span class="fu">max</span>(D_SXY_0<span class="sc">$</span>X2) <span class="sc">+</span> h, <span class="at">length =</span> n_grid <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb128-23"><a href="#cb128-23" aria-hidden="true" tabindex="-1"></a>  <span class="co"># and middle point of the cells</span></span>
<span id="cb128-24"><a href="#cb128-24" aria-hidden="true" tabindex="-1"></a>  vx1_0_mid <span class="ot">&lt;-</span> (vx1_0[<span class="dv">2</span><span class="sc">:</span>(<span class="dv">1</span><span class="sc">+</span>n_grid)]<span class="sc">+</span>vx1_0[<span class="dv">1</span><span class="sc">:</span>(n_grid)]) <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb128-25"><a href="#cb128-25" aria-hidden="true" tabindex="-1"></a>  vx2_0_mid <span class="ot">&lt;-</span> (vx2_0[<span class="dv">2</span><span class="sc">:</span>(<span class="dv">1</span><span class="sc">+</span>n_grid)]<span class="sc">+</span>vx2_0[<span class="dv">1</span><span class="sc">:</span>(n_grid)]) <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb128-26"><a href="#cb128-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-27"><a href="#cb128-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Coordinates of the cells of the grid on subset of 1 (White)</span></span>
<span id="cb128-28"><a href="#cb128-28" aria-hidden="true" tabindex="-1"></a>  vx1_1 <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fu">min</span>(D_SXY_1<span class="sc">$</span>X1) <span class="sc">-</span>h, <span class="fu">max</span>(D_SXY_1<span class="sc">$</span>X1) <span class="sc">+</span> h, <span class="at">length =</span> n_grid <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb128-29"><a href="#cb128-29" aria-hidden="true" tabindex="-1"></a>  vx1_1_mid <span class="ot">&lt;-</span> (vx1_1[<span class="dv">2</span><span class="sc">:</span>(<span class="dv">1</span> <span class="sc">+</span> n_grid)] <span class="sc">+</span> vx1_1[<span class="dv">1</span><span class="sc">:</span>(n_grid)]) <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb128-30"><a href="#cb128-30" aria-hidden="true" tabindex="-1"></a>  <span class="co"># and middle point of the cells</span></span>
<span id="cb128-31"><a href="#cb128-31" aria-hidden="true" tabindex="-1"></a>  vx2_1 <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fu">min</span>(D_SXY_1<span class="sc">$</span>X2) <span class="sc">-</span> h, <span class="fu">max</span>(D_SXY_1<span class="sc">$</span>X2) <span class="sc">+</span> h, <span class="at">length =</span> n_grid <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb128-32"><a href="#cb128-32" aria-hidden="true" tabindex="-1"></a>  vx2_1_mid <span class="ot">&lt;-</span> (vx2_1[<span class="dv">2</span><span class="sc">:</span>(<span class="dv">1</span> <span class="sc">+</span> n_grid)] <span class="sc">+</span> vx2_1[<span class="dv">1</span><span class="sc">:</span>(n_grid)]) <span class="sc">/</span> <span class="dv">2</span></span>
<span id="cb128-33"><a href="#cb128-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-34"><a href="#cb128-34" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Creation of the grids for the CDF and Quantile function</span></span>
<span id="cb128-35"><a href="#cb128-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># init with NA values</span></span>
<span id="cb128-36"><a href="#cb128-36" aria-hidden="true" tabindex="-1"></a>  <span class="co"># One grid for X1 and X2, on both subsets of the data (Black/White)</span></span>
<span id="cb128-37"><a href="#cb128-37" aria-hidden="true" tabindex="-1"></a>  F1_0 <span class="ot">&lt;-</span> F2_0 <span class="ot">&lt;-</span> F1_1 <span class="ot">&lt;-</span> F2_1 <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, n_grid, n_grid)</span>
<span id="cb128-38"><a href="#cb128-38" aria-hidden="true" tabindex="-1"></a>  Q1_0 <span class="ot">&lt;-</span> Q2_0 <span class="ot">&lt;-</span> Q1_1 <span class="ot">&lt;-</span> Q2_1 <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, n_grid, n_grid)</span>
<span id="cb128-39"><a href="#cb128-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-40"><a href="#cb128-40" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Empirical CDF for X1 on subset of Black</span></span>
<span id="cb128-41"><a href="#cb128-41" aria-hidden="true" tabindex="-1"></a>  FdR1_0 <span class="ot">&lt;-</span> <span class="fu">Vectorize</span>(<span class="cf">function</span>(x) <span class="fu">mean</span>(D_SXY_0<span class="sc">$</span>X1 <span class="sc">&lt;=</span> x))</span>
<span id="cb128-42"><a href="#cb128-42" aria-hidden="true" tabindex="-1"></a>  f1_0 <span class="ot">&lt;-</span> <span class="fu">FdR1_0</span>(vx1_0_mid)</span>
<span id="cb128-43"><a href="#cb128-43" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Empirical CDF for X2 on subset of Black</span></span>
<span id="cb128-44"><a href="#cb128-44" aria-hidden="true" tabindex="-1"></a>  FdR2_0 <span class="ot">&lt;-</span> <span class="fu">Vectorize</span>(<span class="cf">function</span>(x) <span class="fu">mean</span>(D_SXY_0<span class="sc">$</span>X2 <span class="sc">&lt;=</span> x))</span>
<span id="cb128-45"><a href="#cb128-45" aria-hidden="true" tabindex="-1"></a>  f2_0 <span class="ot">&lt;-</span> <span class="fu">FdR2_0</span>(vx2_0_mid)</span>
<span id="cb128-46"><a href="#cb128-46" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Empirical CDF for X1 on subset of White</span></span>
<span id="cb128-47"><a href="#cb128-47" aria-hidden="true" tabindex="-1"></a>  FdR1_1 <span class="ot">&lt;-</span> <span class="fu">Vectorize</span>(<span class="cf">function</span>(x) <span class="fu">mean</span>(D_SXY_1<span class="sc">$</span>X1 <span class="sc">&lt;=</span> x))</span>
<span id="cb128-48"><a href="#cb128-48" aria-hidden="true" tabindex="-1"></a>  f1_1 <span class="ot">&lt;-</span> <span class="fu">FdR1_1</span>(vx1_1_mid)</span>
<span id="cb128-49"><a href="#cb128-49" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Empirical CDF for X2 on subset of White</span></span>
<span id="cb128-50"><a href="#cb128-50" aria-hidden="true" tabindex="-1"></a>  FdR2_1 <span class="ot">&lt;-</span> <span class="fu">Vectorize</span>(<span class="cf">function</span>(x) <span class="fu">mean</span>(D_SXY_1<span class="sc">$</span>X2 <span class="sc">&lt;=</span> x))</span>
<span id="cb128-51"><a href="#cb128-51" aria-hidden="true" tabindex="-1"></a>  f2_1 <span class="ot">&lt;-</span> <span class="fu">FdR2_1</span>(vx2_1_mid)</span>
<span id="cb128-52"><a href="#cb128-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-53"><a href="#cb128-53" aria-hidden="true" tabindex="-1"></a>  u <span class="ot">&lt;-</span> (<span class="dv">1</span><span class="sc">:</span>n_grid) <span class="sc">/</span> (n_grid <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb128-54"><a href="#cb128-54" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Empirical quantiles for X1 on subset of Black</span></span>
<span id="cb128-55"><a href="#cb128-55" aria-hidden="true" tabindex="-1"></a>  Qtl1_0 <span class="ot">&lt;-</span> <span class="fu">Vectorize</span>(<span class="cf">function</span>(x) <span class="fu">quantile</span>(D_SXY_0<span class="sc">$</span>X1, x))</span>
<span id="cb128-56"><a href="#cb128-56" aria-hidden="true" tabindex="-1"></a>  q1_0 <span class="ot">&lt;-</span> <span class="fu">Qtl1_0</span>(u)</span>
<span id="cb128-57"><a href="#cb128-57" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Empirical quantiles for X2 on subset of Black</span></span>
<span id="cb128-58"><a href="#cb128-58" aria-hidden="true" tabindex="-1"></a>  Qtl2_0 <span class="ot">&lt;-</span> <span class="fu">Vectorize</span>(<span class="cf">function</span>(x) <span class="fu">quantile</span>(D_SXY_0<span class="sc">$</span>X2, x))</span>
<span id="cb128-59"><a href="#cb128-59" aria-hidden="true" tabindex="-1"></a>  q2_0 <span class="ot">&lt;-</span> <span class="fu">Qtl2_0</span>(u)</span>
<span id="cb128-60"><a href="#cb128-60" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Empirical quantiles for X1 on subset of White</span></span>
<span id="cb128-61"><a href="#cb128-61" aria-hidden="true" tabindex="-1"></a>  Qtl1_1 <span class="ot">&lt;-</span> <span class="fu">Vectorize</span>(<span class="cf">function</span>(x) <span class="fu">quantile</span>(D_SXY_1<span class="sc">$</span>X1, x))</span>
<span id="cb128-62"><a href="#cb128-62" aria-hidden="true" tabindex="-1"></a>  q1_1 <span class="ot">&lt;-</span> <span class="fu">Qtl1_1</span>(u)</span>
<span id="cb128-63"><a href="#cb128-63" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Empirical quantiles for X2 on subset of White</span></span>
<span id="cb128-64"><a href="#cb128-64" aria-hidden="true" tabindex="-1"></a>  Qtl2_1 <span class="ot">&lt;-</span> <span class="fu">Vectorize</span>(<span class="cf">function</span>(x) <span class="fu">quantile</span>(D_SXY_1<span class="sc">$</span>X2, x))</span>
<span id="cb128-65"><a href="#cb128-65" aria-hidden="true" tabindex="-1"></a>  q2_1 <span class="ot">&lt;-</span> <span class="fu">Qtl2_1</span>(u)</span>
<span id="cb128-66"><a href="#cb128-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-67"><a href="#cb128-67" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n_grid) {</span>
<span id="cb128-68"><a href="#cb128-68" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Subset of Black</span></span>
<span id="cb128-69"><a href="#cb128-69" aria-hidden="true" tabindex="-1"></a>    idx1_0 <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">abs</span>(D_SXY_0<span class="sc">$</span>X1 <span class="sc">-</span> vx1_0_mid[i]) <span class="sc">&lt;</span> d)</span>
<span id="cb128-70"><a href="#cb128-70" aria-hidden="true" tabindex="-1"></a>    FdR2_0 <span class="ot">&lt;-</span> <span class="fu">Vectorize</span>(<span class="cf">function</span>(x) <span class="fu">mean</span>(D_SXY_0<span class="sc">$</span>X2[idx1_0] <span class="sc">&lt;=</span> x))</span>
<span id="cb128-71"><a href="#cb128-71" aria-hidden="true" tabindex="-1"></a>    F2_0[, i] <span class="ot">&lt;-</span> <span class="fu">FdR2_0</span>(vx2_0_mid)</span>
<span id="cb128-72"><a href="#cb128-72" aria-hidden="true" tabindex="-1"></a>    Qtl2_0 <span class="ot">&lt;-</span> <span class="fu">Vectorize</span>(<span class="cf">function</span>(x) <span class="fu">quantile</span>(D_SXY_0<span class="sc">$</span>X2[idx1_0], x))</span>
<span id="cb128-73"><a href="#cb128-73" aria-hidden="true" tabindex="-1"></a>    Q2_0[, i] <span class="ot">&lt;-</span> <span class="fu">Qtl2_0</span>(u)</span>
<span id="cb128-74"><a href="#cb128-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-75"><a href="#cb128-75" aria-hidden="true" tabindex="-1"></a>    idx2_0 <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">abs</span>(D_SXY_0<span class="sc">$</span>X2 <span class="sc">-</span> vx2_0_mid[i]) <span class="sc">&lt;</span> d)</span>
<span id="cb128-76"><a href="#cb128-76" aria-hidden="true" tabindex="-1"></a>    FdR1_0 <span class="ot">&lt;-</span> <span class="fu">Vectorize</span>(<span class="cf">function</span>(x) <span class="fu">mean</span>(D_SXY_0<span class="sc">$</span>X1[idx2_0] <span class="sc">&lt;=</span> x))</span>
<span id="cb128-77"><a href="#cb128-77" aria-hidden="true" tabindex="-1"></a>    F1_0[, i] <span class="ot">&lt;-</span> <span class="fu">FdR1_0</span>(vx1_0_mid)</span>
<span id="cb128-78"><a href="#cb128-78" aria-hidden="true" tabindex="-1"></a>    Qtl1_0 <span class="ot">&lt;-</span> <span class="fu">Vectorize</span>(<span class="cf">function</span>(x) <span class="fu">quantile</span>(D_SXY_0<span class="sc">$</span>X1[idx2_0], x))</span>
<span id="cb128-79"><a href="#cb128-79" aria-hidden="true" tabindex="-1"></a>    Q1_0[, i] <span class="ot">&lt;-</span> <span class="fu">Qtl1_0</span>(u)</span>
<span id="cb128-80"><a href="#cb128-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-81"><a href="#cb128-81" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Subset of White</span></span>
<span id="cb128-82"><a href="#cb128-82" aria-hidden="true" tabindex="-1"></a>    idx1_1 <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">abs</span>(D_SXY_1<span class="sc">$</span>X1 <span class="sc">-</span> vx1_1_mid[i]) <span class="sc">&lt;</span> d)</span>
<span id="cb128-83"><a href="#cb128-83" aria-hidden="true" tabindex="-1"></a>    FdR2_1 <span class="ot">&lt;-</span> <span class="fu">Vectorize</span>(<span class="cf">function</span>(x) <span class="fu">mean</span>(D_SXY_1<span class="sc">$</span>X2[idx1_1] <span class="sc">&lt;=</span> x))</span>
<span id="cb128-84"><a href="#cb128-84" aria-hidden="true" tabindex="-1"></a>    F2_1[, i] <span class="ot">&lt;-</span> <span class="fu">FdR2_1</span>(vx2_1_mid)</span>
<span id="cb128-85"><a href="#cb128-85" aria-hidden="true" tabindex="-1"></a>    Qtl2_1 <span class="ot">&lt;-</span> <span class="fu">Vectorize</span>(<span class="cf">function</span>(x) <span class="fu">quantile</span>(D_SXY_1<span class="sc">$</span>X2[idx1_1], x))</span>
<span id="cb128-86"><a href="#cb128-86" aria-hidden="true" tabindex="-1"></a>    Q2_1[, i] <span class="ot">&lt;-</span> <span class="fu">Qtl2_1</span>(u)</span>
<span id="cb128-87"><a href="#cb128-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-88"><a href="#cb128-88" aria-hidden="true" tabindex="-1"></a>    idx2_1 <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">abs</span>(D_SXY_1<span class="sc">$</span>X2<span class="sc">-</span>vx2_1_mid[i])<span class="sc">&lt;</span>d)</span>
<span id="cb128-89"><a href="#cb128-89" aria-hidden="true" tabindex="-1"></a>    FdR1_1 <span class="ot">&lt;-</span> <span class="fu">Vectorize</span>(<span class="cf">function</span>(x) <span class="fu">mean</span>(D_SXY_1<span class="sc">$</span>X1[idx2_1] <span class="sc">&lt;=</span> x))</span>
<span id="cb128-90"><a href="#cb128-90" aria-hidden="true" tabindex="-1"></a>    F1_1[, i] <span class="ot">&lt;-</span> <span class="fu">FdR1_1</span>(vx1_1_mid)</span>
<span id="cb128-91"><a href="#cb128-91" aria-hidden="true" tabindex="-1"></a>    Qtl1_1 <span class="ot">&lt;-</span> <span class="fu">Vectorize</span>(<span class="cf">function</span>(x) <span class="fu">quantile</span>(D_SXY_1<span class="sc">$</span>X1[idx2_1], x))</span>
<span id="cb128-92"><a href="#cb128-92" aria-hidden="true" tabindex="-1"></a>    Q1_1[, i] <span class="ot">&lt;-</span> <span class="fu">Qtl1_1</span>(u)</span>
<span id="cb128-93"><a href="#cb128-93" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb128-94"><a href="#cb128-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-95"><a href="#cb128-95" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Transport for X2</span></span>
<span id="cb128-96"><a href="#cb128-96" aria-hidden="true" tabindex="-1"></a>  T2 <span class="ot">&lt;-</span> <span class="cf">function</span>(x2) {</span>
<span id="cb128-97"><a href="#cb128-97" aria-hidden="true" tabindex="-1"></a>    i <span class="ot">&lt;-</span> <span class="fu">which.min</span>(<span class="fu">abs</span>(vx2_0_mid <span class="sc">-</span> x2))</span>
<span id="cb128-98"><a href="#cb128-98" aria-hidden="true" tabindex="-1"></a>    p <span class="ot">&lt;-</span> f2_0[i]</span>
<span id="cb128-99"><a href="#cb128-99" aria-hidden="true" tabindex="-1"></a>    i <span class="ot">&lt;-</span> <span class="fu">which.min</span>(<span class="fu">abs</span>(u <span class="sc">-</span> p))</span>
<span id="cb128-100"><a href="#cb128-100" aria-hidden="true" tabindex="-1"></a>    x2star <span class="ot">&lt;-</span> q2_1[i]</span>
<span id="cb128-101"><a href="#cb128-101" aria-hidden="true" tabindex="-1"></a>    x2star</span>
<span id="cb128-102"><a href="#cb128-102" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb128-103"><a href="#cb128-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-104"><a href="#cb128-104" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Transport for X1</span></span>
<span id="cb128-105"><a href="#cb128-105" aria-hidden="true" tabindex="-1"></a>  T1 <span class="ot">&lt;-</span> <span class="cf">function</span>(x1) {</span>
<span id="cb128-106"><a href="#cb128-106" aria-hidden="true" tabindex="-1"></a>    i <span class="ot">&lt;-</span> <span class="fu">which.min</span>(<span class="fu">abs</span>(vx1_0_mid <span class="sc">-</span> x1))</span>
<span id="cb128-107"><a href="#cb128-107" aria-hidden="true" tabindex="-1"></a>    p <span class="ot">&lt;-</span> f1_0[i]</span>
<span id="cb128-108"><a href="#cb128-108" aria-hidden="true" tabindex="-1"></a>    i <span class="ot">&lt;-</span> <span class="fu">which.min</span>(<span class="fu">abs</span>(u <span class="sc">-</span> p))</span>
<span id="cb128-109"><a href="#cb128-109" aria-hidden="true" tabindex="-1"></a>    x1star <span class="ot">&lt;-</span> q1_1[i]</span>
<span id="cb128-110"><a href="#cb128-110" aria-hidden="true" tabindex="-1"></a>    x1star</span>
<span id="cb128-111"><a href="#cb128-111" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb128-112"><a href="#cb128-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-113"><a href="#cb128-113" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Transport for X2 conditional on X1</span></span>
<span id="cb128-114"><a href="#cb128-114" aria-hidden="true" tabindex="-1"></a>  T2_cond_x1 <span class="ot">&lt;-</span> <span class="cf">function</span>(x2, x1) {</span>
<span id="cb128-115"><a href="#cb128-115" aria-hidden="true" tabindex="-1"></a>    k0 <span class="ot">&lt;-</span> <span class="fu">which.min</span>(<span class="fu">abs</span>(vx1_0_mid <span class="sc">-</span> x1))</span>
<span id="cb128-116"><a href="#cb128-116" aria-hidden="true" tabindex="-1"></a>    k1 <span class="ot">&lt;-</span> <span class="fu">which.min</span>(<span class="fu">abs</span>(vx1_1_mid <span class="sc">-</span> <span class="fu">T1</span>(x1)))</span>
<span id="cb128-117"><a href="#cb128-117" aria-hidden="true" tabindex="-1"></a>    i <span class="ot">&lt;-</span> <span class="fu">which.min</span>(<span class="fu">abs</span>(vx2_0_mid <span class="sc">-</span> x2))</span>
<span id="cb128-118"><a href="#cb128-118" aria-hidden="true" tabindex="-1"></a>    p <span class="ot">&lt;-</span> F2_0[i, k0]</span>
<span id="cb128-119"><a href="#cb128-119" aria-hidden="true" tabindex="-1"></a>    i <span class="ot">&lt;-</span> <span class="fu">which.min</span>(<span class="fu">abs</span>(u <span class="sc">-</span> p))</span>
<span id="cb128-120"><a href="#cb128-120" aria-hidden="true" tabindex="-1"></a>    x2star <span class="ot">&lt;-</span> Q2_1[i, k1]</span>
<span id="cb128-121"><a href="#cb128-121" aria-hidden="true" tabindex="-1"></a>    x2star</span>
<span id="cb128-122"><a href="#cb128-122" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb128-123"><a href="#cb128-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-124"><a href="#cb128-124" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Transport for X1 conditional on X2</span></span>
<span id="cb128-125"><a href="#cb128-125" aria-hidden="true" tabindex="-1"></a>  T1_cond_x2 <span class="ot">&lt;-</span> <span class="cf">function</span>(x1, x2) {</span>
<span id="cb128-126"><a href="#cb128-126" aria-hidden="true" tabindex="-1"></a>    k0 <span class="ot">&lt;-</span> <span class="fu">which.min</span>(<span class="fu">abs</span>(vx2_0_mid <span class="sc">-</span> x2))</span>
<span id="cb128-127"><a href="#cb128-127" aria-hidden="true" tabindex="-1"></a>    k1 <span class="ot">&lt;-</span> <span class="fu">which.min</span>(<span class="fu">abs</span>(vx2_1_mid <span class="sc">-</span> x2))</span>
<span id="cb128-128"><a href="#cb128-128" aria-hidden="true" tabindex="-1"></a>    i <span class="ot">&lt;-</span> <span class="fu">which.min</span>(<span class="fu">abs</span>(vx1_0_mid <span class="sc">-</span> x1))</span>
<span id="cb128-129"><a href="#cb128-129" aria-hidden="true" tabindex="-1"></a>    p <span class="ot">&lt;-</span> F1_0[i, k0]</span>
<span id="cb128-130"><a href="#cb128-130" aria-hidden="true" tabindex="-1"></a>    i <span class="ot">&lt;-</span> <span class="fu">which.min</span>(<span class="fu">abs</span>(u <span class="sc">-</span> p))</span>
<span id="cb128-131"><a href="#cb128-131" aria-hidden="true" tabindex="-1"></a>    x1star <span class="ot">&lt;-</span> Q1_1[i, k1]</span>
<span id="cb128-132"><a href="#cb128-132" aria-hidden="true" tabindex="-1"></a>    x1star</span>
<span id="cb128-133"><a href="#cb128-133" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb128-134"><a href="#cb128-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-135"><a href="#cb128-135" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb128-136"><a href="#cb128-136" aria-hidden="true" tabindex="-1"></a>    <span class="at">Transport_x1 =</span> T1,</span>
<span id="cb128-137"><a href="#cb128-137" aria-hidden="true" tabindex="-1"></a>    <span class="at">Transport_x2 =</span> T2,</span>
<span id="cb128-138"><a href="#cb128-138" aria-hidden="true" tabindex="-1"></a>    <span class="at">Transport_x1_cond_x2 =</span> T1_cond_x2,</span>
<span id="cb128-139"><a href="#cb128-139" aria-hidden="true" tabindex="-1"></a>    <span class="at">Transport_x2_cond_x1 =</span> T2_cond_x1</span>
<span id="cb128-140"><a href="#cb128-140" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb128-141"><a href="#cb128-141" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The <code class="sourceCode r"><span class="fu">fonction_transport</span>()</code> function returns not only the functions <code class="sourceCode r"><span class="fu">Transport_x1</span>()</code>, <code class="sourceCode r"><span class="fu">Transport_x2</span>()</code>, <code class="sourceCode r"><span class="fu">Transport_x1_cond_x2</span>()</code>, <code class="sourceCode r"><span class="fu">Transport_x2_cond_x1</span>()</code>, but also the useful values of the grid (e.g., <code>vx1_0_mid</code> defined in the environment of the function and used in the functions). Note that defining a global object named <code>vx1_0_mid</code> will not alter the object of the same name defined in the environment of <code class="sourceCode r"><span class="fu">fonction_transport</span>()</code>: R will call the <code>vx1_0_mid</code> from that environment and not the one that may be defined in the global environment.</p>
</div>
</div>
<p>Let us apply this function. Note that we use a grid of length 500 to fasten the computation of sequential transport (the estimation takes about 45 seconds on a standard computer).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a>seq_functions <span class="ot">&lt;-</span> <span class="fu">fonction_transport</span>(<span class="at">data =</span> df_race_fpt, <span class="at">n_grid =</span> <span class="dv">500</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let us extract the transport functions to transport <span class="math inline">\(X_1\)</span> and <span class="math inline">\(X_2\)</span>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a>T_X1 <span class="ot">&lt;-</span> seq_functions<span class="sc">$</span>Transport_x1</span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a>T_X2 <span class="ot">&lt;-</span> seq_functions<span class="sc">$</span>Transport_x2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We also do the same with the transport of <span class="math inline">\(X_2\)</span> conditional on <span class="math inline">\(X_1\)</span>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a>T_X2_c_X1 <span class="ot">&lt;-</span> seq_functions<span class="sc">$</span>Transport_x2_cond_x1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, we can apply these functions to the subset of Black individuals to sequentially transport <span class="math inline">\(X_1\)</span> (UGPA) and then <span class="math inline">\(X_2\)</span> (LSAT) conditional on the transported value of <span class="math inline">\(X_1\)</span>:</p>
<p>The values of <span class="math inline">\(X_1\)</span> and <span class="math inline">\(X_2\)</span> for Black individuals:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a>a10 <span class="ot">&lt;-</span> df_race_fpt<span class="sc">$</span>X1[ind_black]</span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a>a20 <span class="ot">&lt;-</span> df_race_fpt<span class="sc">$</span>X2[ind_black]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The transported values:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb133"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a>x1_star <span class="ot">&lt;-</span> <span class="fu">map_dbl</span>(a10, T_X1) <span class="co"># Transport X1 to group S=White</span></span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a>x2_star <span class="ot">&lt;-</span> <span class="fu">map2_dbl</span>(a20, a10, T_X2_c_X1) <span class="co"># Transport X2|X1 to group S=White</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We build a dataset with the sensitive attribute of Black individuals changed to white, and their characteristics changed to their transported characteristics:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb134"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a>df_counterfactuals_seq_black <span class="ot">&lt;-</span> </span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a>  df_race_fpt <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">id =</span> <span class="fu">row_number</span>()) <span class="sc">|&gt;</span> </span>
<span id="cb134-3"><a href="#cb134-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(S <span class="sc">==</span> <span class="st">"Black"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb134-4"><a href="#cb134-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb134-5"><a href="#cb134-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">S =</span> <span class="st">"White"</span>,</span>
<span id="cb134-6"><a href="#cb134-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">X1 =</span> x1_star,</span>
<span id="cb134-7"><a href="#cb134-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">X2 =</span> x2_star</span>
<span id="cb134-8"><a href="#cb134-8" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We make predictions based on those counterfactuals obrained with sequential transport, on both models (the unaware model, and the aware model):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb135"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a>pred_seq_unaware <span class="ot">&lt;-</span> <span class="fu">predict</span>(</span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a>  model_unaware, <span class="at">newdata =</span> df_counterfactuals_seq_black,<span class="at">type =</span> <span class="st">"response"</span></span>
<span id="cb135-3"><a href="#cb135-3" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb135-4"><a href="#cb135-4" aria-hidden="true" tabindex="-1"></a>pred_seq_aware <span class="ot">&lt;-</span> <span class="fu">predict</span>(</span>
<span id="cb135-5"><a href="#cb135-5" aria-hidden="true" tabindex="-1"></a>  model_aware, <span class="at">newdata =</span> df_counterfactuals_seq_black,<span class="at">type =</span> <span class="st">"response"</span></span>
<span id="cb135-6"><a href="#cb135-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb136"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a>counterfactuals_seq_unaware_black <span class="ot">&lt;-</span> </span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a>  df_counterfactuals_seq_black <span class="sc">|&gt;</span> </span>
<span id="cb136-3"><a href="#cb136-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">pred =</span> pred_seq_unaware, <span class="at">type =</span> <span class="st">"counterfactual"</span>)</span>
<span id="cb136-4"><a href="#cb136-4" aria-hidden="true" tabindex="-1"></a>counterfactuals_seq_aware_black <span class="ot">&lt;-</span> </span>
<span id="cb136-5"><a href="#cb136-5" aria-hidden="true" tabindex="-1"></a>  df_counterfactuals_seq_black <span class="sc">|&gt;</span> </span>
<span id="cb136-6"><a href="#cb136-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">pred =</span> pred_seq_aware, <span class="at">type =</span> <span class="st">"counterfactual"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb137"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a>aware_seq_black <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb137-2"><a href="#cb137-2" aria-hidden="true" tabindex="-1"></a>  factuals_aware <span class="sc">|&gt;</span> <span class="fu">filter</span>(S <span class="sc">==</span> <span class="st">"Black"</span>), </span>
<span id="cb137-3"><a href="#cb137-3" aria-hidden="true" tabindex="-1"></a>  counterfactuals_seq_aware_black</span>
<span id="cb137-4"><a href="#cb137-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb137-5"><a href="#cb137-5" aria-hidden="true" tabindex="-1"></a>unaware_seq_black <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb137-6"><a href="#cb137-6" aria-hidden="true" tabindex="-1"></a>  factuals_unaware <span class="sc">|&gt;</span> <span class="fu">filter</span>(S <span class="sc">==</span> <span class="st">"Black"</span>), </span>
<span id="cb137-7"><a href="#cb137-7" aria-hidden="true" tabindex="-1"></a>  counterfactuals_seq_aware_black)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true">Unaware</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false">Aware</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb138"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(</span>
<span id="cb138-2"><a href="#cb138-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> unaware_seq_black, </span>
<span id="cb138-3"><a href="#cb138-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> pred, <span class="at">fill =</span> type)</span>
<span id="cb138-4"><a href="#cb138-4" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span></span>
<span id="cb138-5"><a href="#cb138-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(</span>
<span id="cb138-6"><a href="#cb138-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">y =</span> ..density..), </span>
<span id="cb138-7"><a href="#cb138-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">position =</span> <span class="st">"identity"</span>, <span class="at">binwidth =</span> <span class="fl">0.05</span></span>
<span id="cb138-8"><a href="#cb138-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb138-9"><a href="#cb138-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb138-10"><a href="#cb138-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb138-11"><a href="#cb138-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Unware model, S: Race - Black --&gt; White"</span>,</span>
<span id="cb138-12"><a href="#cb138-12" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Predictions for Y"</span>,</span>
<span id="cb138-13"><a href="#cb138-13" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Density"</span>) <span class="sc">+</span></span>
<span id="cb138-14"><a href="#cb138-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">global_theme</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-seq-unaware-race-ref-white" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-seq-unaware-race-ref-white-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1.17: Unaware model, Sensitive: Race, Reference: White individuals
</figcaption>
<div aria-describedby="fig-seq-unaware-race-ref-white-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="law_dataset_files/figure-html/fig-seq-unaware-race-ref-white-1.png" class="img-fluid figure-img" width="672">
</div>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb139"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(</span>
<span id="cb139-2"><a href="#cb139-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> aware_seq_black, </span>
<span id="cb139-3"><a href="#cb139-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> pred, <span class="at">fill =</span> type)</span>
<span id="cb139-4"><a href="#cb139-4" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span></span>
<span id="cb139-5"><a href="#cb139-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>(</span>
<span id="cb139-6"><a href="#cb139-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">y =</span> ..density..), </span>
<span id="cb139-7"><a href="#cb139-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">position =</span> <span class="st">"identity"</span>, <span class="at">binwidth =</span> <span class="fl">0.05</span></span>
<span id="cb139-8"><a href="#cb139-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb139-9"><a href="#cb139-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb139-10"><a href="#cb139-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb139-11"><a href="#cb139-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Aware model, S: Race - Black --&gt; White"</span>,</span>
<span id="cb139-12"><a href="#cb139-12" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Predictions for Y"</span>,</span>
<span id="cb139-13"><a href="#cb139-13" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">"Density"</span>) <span class="sc">+</span></span>
<span id="cb139-14"><a href="#cb139-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">global_theme</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div id="fig-seq-aware-race-ref-white" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-seq-aware-race-ref-white-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1.18: Aware model, Sensitive: Race, Reference: White individuals
</figcaption>
<div aria-describedby="fig-seq-aware-race-ref-white-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="law_dataset_files/figure-html/fig-seq-aware-race-ref-white-1.png" class="img-fluid figure-img" width="672">
</div>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>
<section id="comparison-for-two-individuals-2" class="level4" data-number="1.4.3.1">
<h4 data-number="1.4.3.1" class="anchored" data-anchor-id="comparison-for-two-individuals-2"><span class="header-section-number">1.4.3.1</span> Comparison for two individuals</h4>
<p>Let us focus on the first three Black individuals of the dataset.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb140"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a>factuals_unaware <span class="sc">|&gt;</span> </span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(S <span class="sc">==</span> <span class="st">"Black"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb140-3"><a href="#cb140-3" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 5
  S        X1    X2  pred type   
  &lt;fct&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;  
1 Black   2.8    29 0.300 factual
2 Black   3.2    19 0.206 factual
3 Black   2.6    23 0.198 factual</code></pre>
</div>
</div>
<p>Their characteristics after sequential transport (and the predicted value with the unaware model):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb142"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a>indiv_counterfactuals_seq_unaware <span class="ot">&lt;-</span> counterfactuals_seq_unaware_black[<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>), ]</span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a>indiv_counterfactuals_seq_unaware</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 6
  S        X1    X2    id  pred type          
  &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;         
1 White   3.2  37      24 0.491 counterfactual
2 White   3.5  28.5    40 0.381 counterfactual
3 White   3.1  31.5    51 0.379 counterfactual</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb144"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a>indiv_unaware_seq <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a>  factuals_unaware <span class="sc">|&gt;</span> </span>
<span id="cb144-3"><a href="#cb144-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(S <span class="sc">==</span> <span class="st">"Black"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb144-4"><a href="#cb144-4" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>) <span class="sc">|&gt;</span> </span>
<span id="cb144-5"><a href="#cb144-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">id_indiv_black =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>)), </span>
<span id="cb144-6"><a href="#cb144-6" aria-hidden="true" tabindex="-1"></a>  indiv_counterfactuals_seq_unaware <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">id_indiv_black =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>))</span>
<span id="cb144-7"><a href="#cb144-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb144-8"><a href="#cb144-8" aria-hidden="true" tabindex="-1"></a>indiv_unaware_seq</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 7
  S        X1    X2  pred type           id_indiv_black    id
  &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;                   &lt;int&gt; &lt;int&gt;
1 Black   2.8  29   0.300 factual                     1    NA
2 Black   3.2  19   0.206 factual                     2    NA
3 Black   2.6  23   0.198 factual                     3    NA
4 White   3.2  37   0.491 counterfactual              1    24
5 White   3.5  28.5 0.381 counterfactual              2    40
6 White   3.1  31.5 0.379 counterfactual              3    51</code></pre>
</div>
</div>
<p>And with the aware model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb146"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a>indiv_counterfactuals_seq_aware <span class="ot">&lt;-</span> counterfactuals_seq_aware_black[<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>), ]</span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a>indiv_counterfactuals_seq_aware</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 6
  S        X1    X2    id  pred type          
  &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;         
1 White   3.2  37      24 0.507 counterfactual
2 White   3.5  28.5    40 0.418 counterfactual
3 White   3.1  31.5    51 0.413 counterfactual</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb148"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a>indiv_aware_seq <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(</span>
<span id="cb148-2"><a href="#cb148-2" aria-hidden="true" tabindex="-1"></a>  factuals_aware <span class="sc">|&gt;</span> </span>
<span id="cb148-3"><a href="#cb148-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(S <span class="sc">==</span> <span class="st">"Black"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb148-4"><a href="#cb148-4" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">slice</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>) <span class="sc">|&gt;</span> </span>
<span id="cb148-5"><a href="#cb148-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">id_indiv_black =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>)), </span>
<span id="cb148-6"><a href="#cb148-6" aria-hidden="true" tabindex="-1"></a>  indiv_counterfactuals_seq_aware <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">id_indiv_black =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>))</span>
<span id="cb148-7"><a href="#cb148-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb148-8"><a href="#cb148-8" aria-hidden="true" tabindex="-1"></a>indiv_aware_seq</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 7
  S        X1    X2   pred type           id_indiv_black    id
  &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;                   &lt;int&gt; &lt;int&gt;
1 Black   2.8  29   0.133  factual                     1    NA
2 Black   3.2  19   0.0933 factual                     2    NA
3 Black   2.6  23   0.0882 factual                     3    NA
4 White   3.2  37   0.507  counterfactual              1    24
5 White   3.5  28.5 0.418  counterfactual              2    40
6 White   3.1  31.5 0.413  counterfactual              3    51</code></pre>
</div>
</div>
</section>
<section id="demographic-parity-2" class="level4" data-number="1.4.3.2">
<h4 data-number="1.4.3.2" class="anchored" data-anchor-id="demographic-parity-2"><span class="header-section-number">1.4.3.2</span> Demographic Parity</h4>
<p>For the unaware model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb150"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(</span>
<span id="cb150-2"><a href="#cb150-2" aria-hidden="true" tabindex="-1"></a>  counterfactuals_seq_unaware_black<span class="sc">$</span>pred <span class="sc">-</span></span>
<span id="cb150-3"><a href="#cb150-3" aria-hidden="true" tabindex="-1"></a>    factuals_unaware <span class="sc">|&gt;</span> <span class="fu">filter</span>(S <span class="sc">==</span> <span class="st">"Black"</span>) <span class="sc">|&gt;</span> <span class="fu">pull</span>(<span class="st">"pred"</span>)</span>
<span id="cb150-4"><a href="#cb150-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.1816625</code></pre>
</div>
</div>
<p>For the aware model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb152"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(</span>
<span id="cb152-2"><a href="#cb152-2" aria-hidden="true" tabindex="-1"></a>  counterfactuals_seq_aware_black<span class="sc">$</span>pred <span class="sc">-</span> </span>
<span id="cb152-3"><a href="#cb152-3" aria-hidden="true" tabindex="-1"></a>    factuals_aware <span class="sc">|&gt;</span> <span class="fu">filter</span>(S <span class="sc">==</span> <span class="st">"Black"</span>) <span class="sc">|&gt;</span> <span class="fu">pull</span>(<span class="st">"pred"</span>)</span>
<span id="cb152-4"><a href="#cb152-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.3722886</code></pre>
</div>
</div>
</section>
</section>
<section id="comparison" class="level3" data-number="1.4.4">
<h3 data-number="1.4.4" class="anchored" data-anchor-id="comparison"><span class="header-section-number">1.4.4</span> Comparison</h3>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-2-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-1" role="tab" aria-controls="tabset-2-1" aria-selected="true">Unaware Model</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-2" role="tab" aria-controls="tabset-2-2" aria-selected="false">Aware Model</a></li></ul>
<div class="tab-content">
<div id="tabset-2-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-2-1-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb154"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a>tb_indiv_unaware <span class="ot">&lt;-</span> </span>
<span id="cb154-2"><a href="#cb154-2" aria-hidden="true" tabindex="-1"></a>  factuals_unaware <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">id =</span> <span class="fu">row_number</span>(), <span class="at">counterfactual =</span> <span class="st">"none"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb154-3"><a href="#cb154-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fairadapt</span></span>
<span id="cb154-4"><a href="#cb154-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(</span>
<span id="cb154-5"><a href="#cb154-5" aria-hidden="true" tabindex="-1"></a>    counterfactuals_unaware_fpt <span class="sc">|&gt;</span> </span>
<span id="cb154-6"><a href="#cb154-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">id =</span> <span class="fu">row_number</span>(), <span class="at">counterfactual =</span> <span class="st">"fpt"</span>)</span>
<span id="cb154-7"><a href="#cb154-7" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb154-8"><a href="#cb154-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Multivariate optimal transport</span></span>
<span id="cb154-9"><a href="#cb154-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(</span>
<span id="cb154-10"><a href="#cb154-10" aria-hidden="true" tabindex="-1"></a>    counterfactuals_unaware_ot <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">id =</span> <span class="fu">row_number</span>(), <span class="at">counterfactual =</span> <span class="st">"ot"</span>)</span>
<span id="cb154-11"><a href="#cb154-11" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb154-12"><a href="#cb154-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Sequential transport</span></span>
<span id="cb154-13"><a href="#cb154-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(</span>
<span id="cb154-14"><a href="#cb154-14" aria-hidden="true" tabindex="-1"></a>    counterfactuals_seq_unaware_black <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">counterfactual =</span> <span class="st">"seq"</span>)</span>
<span id="cb154-15"><a href="#cb154-15" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb154-16"><a href="#cb154-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(id <span class="sc">%in%</span> counterfactuals_seq_unaware_black<span class="sc">$</span>id[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>])</span>
<span id="cb154-17"><a href="#cb154-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-18"><a href="#cb154-18" aria-hidden="true" tabindex="-1"></a>tb_indiv_unaware</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 12 × 7
   S        X1    X2  pred type              id counterfactual
   &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;          &lt;int&gt; &lt;chr&gt;         
 1 Black  2.8   29   0.300 factual           24 none          
 2 Black  3.2   19   0.206 factual           40 none          
 3 Black  2.6   23   0.198 factual           51 none          
 4 White  3.25  37.6 0.509 counterfactual    24 fpt           
 5 White  3.6   29.9 0.419 counterfactual    40 fpt           
 6 White  3.1   32.3 0.394 counterfactual    51 fpt           
 7 White  3.20  37.6 0.502 counterfactual    24 ot            
 8 White  3.29  28.0 0.345 counterfactual    40 ot            
 9 White  2.96  32.1 0.371 counterfactual    51 ot            
10 White  3.2   37   0.491 counterfactual    24 seq           
11 White  3.5   28.5 0.381 counterfactual    40 seq           
12 White  3.1   31.5 0.379 counterfactual    51 seq           </code></pre>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb156"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="fl">4.1</span>, <span class="fl">4.1</span>, <span class="dv">0</span>, <span class="dv">0</span>))</span>
<span id="cb156-2"><a href="#cb156-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Initial characteristics with the unaware model</span></span>
<span id="cb156-3"><a href="#cb156-3" aria-hidden="true" tabindex="-1"></a>tb_indiv_unaware_factual <span class="ot">&lt;-</span> </span>
<span id="cb156-4"><a href="#cb156-4" aria-hidden="true" tabindex="-1"></a>  tb_indiv_unaware <span class="sc">|&gt;</span> <span class="fu">filter</span>(type <span class="sc">==</span> <span class="st">"factual"</span>)</span>
<span id="cb156-5"><a href="#cb156-5" aria-hidden="true" tabindex="-1"></a>colour_factual <span class="ot">&lt;-</span> <span class="st">"black"</span></span>
<span id="cb156-6"><a href="#cb156-6" aria-hidden="true" tabindex="-1"></a>colour_fpt <span class="ot">&lt;-</span> <span class="st">"#D55E00"</span></span>
<span id="cb156-7"><a href="#cb156-7" aria-hidden="true" tabindex="-1"></a>colour_ot <span class="ot">&lt;-</span> <span class="st">"#56B4E9"</span></span>
<span id="cb156-8"><a href="#cb156-8" aria-hidden="true" tabindex="-1"></a>colour_seq <span class="ot">&lt;-</span> <span class="st">"#009E73"</span></span>
<span id="cb156-9"><a href="#cb156-9" aria-hidden="true" tabindex="-1"></a>colours_all <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb156-10"><a href="#cb156-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Factual"</span> <span class="ot">=</span> colour_factual,</span>
<span id="cb156-11"><a href="#cb156-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">"fairadapt"</span> <span class="ot">=</span> colour_fpt,</span>
<span id="cb156-12"><a href="#cb156-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">"OT"</span> <span class="ot">=</span> colour_ot,</span>
<span id="cb156-13"><a href="#cb156-13" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Seq T."</span> <span class="ot">=</span> colour_seq</span>
<span id="cb156-14"><a href="#cb156-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb156-15"><a href="#cb156-15" aria-hidden="true" tabindex="-1"></a>range_x1 <span class="ot">&lt;-</span> <span class="fu">range</span>(tb_indiv_unaware<span class="sc">$</span>X1)</span>
<span id="cb156-16"><a href="#cb156-16" aria-hidden="true" tabindex="-1"></a>expansion_amount_x1 <span class="ot">&lt;-</span> .<span class="dv">1</span><span class="sc">*</span>range_x1</span>
<span id="cb156-17"><a href="#cb156-17" aria-hidden="true" tabindex="-1"></a>range_x2 <span class="ot">&lt;-</span> <span class="fu">range</span>(tb_indiv_unaware<span class="sc">$</span>X2)</span>
<span id="cb156-18"><a href="#cb156-18" aria-hidden="true" tabindex="-1"></a>expansion_amount_x2 <span class="ot">&lt;-</span> .<span class="dv">05</span><span class="sc">*</span>range_x2</span>
<span id="cb156-19"><a href="#cb156-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-20"><a href="#cb156-20" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb156-21"><a href="#cb156-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> tb_indiv_unaware_factual<span class="sc">$</span>X1,</span>
<span id="cb156-22"><a href="#cb156-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> tb_indiv_unaware_factual<span class="sc">$</span>X2,</span>
<span id="cb156-23"><a href="#cb156-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> colour_factual,</span>
<span id="cb156-24"><a href="#cb156-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">"X1 (UGPA)"</span>, <span class="at">ylab =</span> <span class="st">"X2 (LSAT)"</span>,</span>
<span id="cb156-25"><a href="#cb156-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlim =</span> <span class="fu">c</span>(range_x1[<span class="dv">1</span>] <span class="sc">-</span> expansion_amount_x1[<span class="dv">1</span>], range_x1[<span class="dv">2</span>] <span class="sc">+</span> expansion_amount_x1[<span class="dv">2</span>]),</span>
<span id="cb156-26"><a href="#cb156-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylim =</span> <span class="fu">c</span>(range_x2[<span class="dv">1</span>] <span class="sc">-</span> expansion_amount_x2[<span class="dv">1</span>], range_x2[<span class="dv">2</span>] <span class="sc">+</span> expansion_amount_x2[<span class="dv">2</span>]),</span>
<span id="cb156-27"><a href="#cb156-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">pch =</span> <span class="dv">19</span>,</span>
<span id="cb156-28"><a href="#cb156-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">axes =</span> <span class="cn">FALSE</span></span>
<span id="cb156-29"><a href="#cb156-29" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb156-30"><a href="#cb156-30" aria-hidden="true" tabindex="-1"></a><span class="fu">axis</span>(<span class="dv">1</span>)</span>
<span id="cb156-31"><a href="#cb156-31" aria-hidden="true" tabindex="-1"></a><span class="fu">axis</span>(<span class="dv">2</span>)</span>
<span id="cb156-32"><a href="#cb156-32" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(</span>
<span id="cb156-33"><a href="#cb156-33" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> tb_indiv_unaware_factual<span class="sc">$</span>X1, </span>
<span id="cb156-34"><a href="#cb156-34" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> tb_indiv_unaware_factual<span class="sc">$</span>X2 <span class="sc">+</span> <span class="dv">1</span>,</span>
<span id="cb156-35"><a href="#cb156-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste0</span>(<span class="fu">round</span>(<span class="dv">100</span><span class="sc">*</span>tb_indiv_unaware_factual<span class="sc">$</span>pred, <span class="dv">2</span>), <span class="st">"%"</span>),</span>
<span id="cb156-36"><a href="#cb156-36" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> colour_factual</span>
<span id="cb156-37"><a href="#cb156-37" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb156-38"><a href="#cb156-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Transported characteristics with fairadapt</span></span>
<span id="cb156-39"><a href="#cb156-39" aria-hidden="true" tabindex="-1"></a>tb_indiv_unaware_fpt <span class="ot">&lt;-</span> </span>
<span id="cb156-40"><a href="#cb156-40" aria-hidden="true" tabindex="-1"></a>  tb_indiv_unaware <span class="sc">|&gt;</span> <span class="fu">filter</span>(counterfactual <span class="sc">==</span> <span class="st">"fpt"</span>)</span>
<span id="cb156-41"><a href="#cb156-41" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(</span>
<span id="cb156-42"><a href="#cb156-42" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> tb_indiv_unaware_fpt<span class="sc">$</span>X1,</span>
<span id="cb156-43"><a href="#cb156-43" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> tb_indiv_unaware_fpt<span class="sc">$</span>X2,</span>
<span id="cb156-44"><a href="#cb156-44" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> colour_fpt,</span>
<span id="cb156-45"><a href="#cb156-45" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">"X1"</span>, <span class="at">ylab =</span> <span class="st">"X2"</span>,</span>
<span id="cb156-46"><a href="#cb156-46" aria-hidden="true" tabindex="-1"></a>  <span class="at">pch =</span> <span class="dv">19</span></span>
<span id="cb156-47"><a href="#cb156-47" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb156-48"><a href="#cb156-48" aria-hidden="true" tabindex="-1"></a><span class="co"># x1 then x2</span></span>
<span id="cb156-49"><a href="#cb156-49" aria-hidden="true" tabindex="-1"></a><span class="fu">segments</span>(</span>
<span id="cb156-50"><a href="#cb156-50" aria-hidden="true" tabindex="-1"></a>  <span class="at">x0 =</span> tb_indiv_unaware_factual<span class="sc">$</span>X1, </span>
<span id="cb156-51"><a href="#cb156-51" aria-hidden="true" tabindex="-1"></a>  <span class="at">y0 =</span> tb_indiv_unaware_factual<span class="sc">$</span>X2,</span>
<span id="cb156-52"><a href="#cb156-52" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> tb_indiv_unaware_fpt<span class="sc">$</span>X1, </span>
<span id="cb156-53"><a href="#cb156-53" aria-hidden="true" tabindex="-1"></a>  <span class="at">y1 =</span> tb_indiv_unaware_factual<span class="sc">$</span>X2, </span>
<span id="cb156-54"><a href="#cb156-54" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> colour_fpt,</span>
<span id="cb156-55"><a href="#cb156-55" aria-hidden="true" tabindex="-1"></a>  <span class="at">lty =</span> <span class="dv">2</span></span>
<span id="cb156-56"><a href="#cb156-56" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb156-57"><a href="#cb156-57" aria-hidden="true" tabindex="-1"></a><span class="fu">segments</span>(</span>
<span id="cb156-58"><a href="#cb156-58" aria-hidden="true" tabindex="-1"></a>  <span class="at">x0 =</span> tb_indiv_unaware_fpt<span class="sc">$</span>X1, </span>
<span id="cb156-59"><a href="#cb156-59" aria-hidden="true" tabindex="-1"></a>  <span class="at">y0 =</span> tb_indiv_unaware_factual<span class="sc">$</span>X2,</span>
<span id="cb156-60"><a href="#cb156-60" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> tb_indiv_unaware_fpt<span class="sc">$</span>X1, </span>
<span id="cb156-61"><a href="#cb156-61" aria-hidden="true" tabindex="-1"></a>  <span class="at">y1 =</span> tb_indiv_unaware_fpt<span class="sc">$</span>X2, </span>
<span id="cb156-62"><a href="#cb156-62" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> colour_fpt,</span>
<span id="cb156-63"><a href="#cb156-63" aria-hidden="true" tabindex="-1"></a>  <span class="at">lty =</span> <span class="dv">2</span></span>
<span id="cb156-64"><a href="#cb156-64" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb156-65"><a href="#cb156-65" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(</span>
<span id="cb156-66"><a href="#cb156-66" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> tb_indiv_unaware_fpt<span class="sc">$</span>X1, </span>
<span id="cb156-67"><a href="#cb156-67" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> tb_indiv_unaware_fpt<span class="sc">$</span>X2 <span class="sc">+</span> <span class="dv">1</span>,</span>
<span id="cb156-68"><a href="#cb156-68" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste0</span>(<span class="fu">round</span>(<span class="dv">100</span><span class="sc">*</span>tb_indiv_unaware_fpt<span class="sc">$</span>pred, <span class="dv">2</span>), <span class="st">"%"</span>),</span>
<span id="cb156-69"><a href="#cb156-69" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> colour_fpt</span>
<span id="cb156-70"><a href="#cb156-70" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb156-71"><a href="#cb156-71" aria-hidden="true" tabindex="-1"></a><span class="co"># Transported characteristics with OT</span></span>
<span id="cb156-72"><a href="#cb156-72" aria-hidden="true" tabindex="-1"></a>tb_indiv_unaware_ot <span class="ot">&lt;-</span> </span>
<span id="cb156-73"><a href="#cb156-73" aria-hidden="true" tabindex="-1"></a>  tb_indiv_unaware <span class="sc">|&gt;</span> <span class="fu">filter</span>(counterfactual <span class="sc">==</span> <span class="st">"ot"</span>)</span>
<span id="cb156-74"><a href="#cb156-74" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(</span>
<span id="cb156-75"><a href="#cb156-75" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> tb_indiv_unaware_ot<span class="sc">$</span>X1,</span>
<span id="cb156-76"><a href="#cb156-76" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> tb_indiv_unaware_ot<span class="sc">$</span>X2,</span>
<span id="cb156-77"><a href="#cb156-77" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> colour_ot,</span>
<span id="cb156-78"><a href="#cb156-78" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">"X1"</span>, <span class="at">ylab =</span> <span class="st">"X2"</span>,</span>
<span id="cb156-79"><a href="#cb156-79" aria-hidden="true" tabindex="-1"></a>  <span class="at">pch =</span> <span class="dv">19</span></span>
<span id="cb156-80"><a href="#cb156-80" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb156-81"><a href="#cb156-81" aria-hidden="true" tabindex="-1"></a><span class="co"># x1 then x2</span></span>
<span id="cb156-82"><a href="#cb156-82" aria-hidden="true" tabindex="-1"></a><span class="fu">segments</span>(</span>
<span id="cb156-83"><a href="#cb156-83" aria-hidden="true" tabindex="-1"></a>  <span class="at">x0 =</span> tb_indiv_unaware_factual<span class="sc">$</span>X1, </span>
<span id="cb156-84"><a href="#cb156-84" aria-hidden="true" tabindex="-1"></a>  <span class="at">y0 =</span> tb_indiv_unaware_factual<span class="sc">$</span>X2,</span>
<span id="cb156-85"><a href="#cb156-85" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> tb_indiv_unaware_ot<span class="sc">$</span>X1, </span>
<span id="cb156-86"><a href="#cb156-86" aria-hidden="true" tabindex="-1"></a>  <span class="at">y1 =</span> tb_indiv_unaware_factual<span class="sc">$</span>X2, </span>
<span id="cb156-87"><a href="#cb156-87" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> colour_ot,</span>
<span id="cb156-88"><a href="#cb156-88" aria-hidden="true" tabindex="-1"></a>  <span class="at">lty =</span> <span class="dv">2</span></span>
<span id="cb156-89"><a href="#cb156-89" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb156-90"><a href="#cb156-90" aria-hidden="true" tabindex="-1"></a><span class="fu">segments</span>(</span>
<span id="cb156-91"><a href="#cb156-91" aria-hidden="true" tabindex="-1"></a>  <span class="at">x0 =</span> tb_indiv_unaware_ot<span class="sc">$</span>X1, </span>
<span id="cb156-92"><a href="#cb156-92" aria-hidden="true" tabindex="-1"></a>  <span class="at">y0 =</span> tb_indiv_unaware_factual<span class="sc">$</span>X2,</span>
<span id="cb156-93"><a href="#cb156-93" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> tb_indiv_unaware_ot<span class="sc">$</span>X1, </span>
<span id="cb156-94"><a href="#cb156-94" aria-hidden="true" tabindex="-1"></a>  <span class="at">y1 =</span> tb_indiv_unaware_ot<span class="sc">$</span>X2, </span>
<span id="cb156-95"><a href="#cb156-95" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> colour_ot,</span>
<span id="cb156-96"><a href="#cb156-96" aria-hidden="true" tabindex="-1"></a>  <span class="at">lty =</span> <span class="dv">2</span></span>
<span id="cb156-97"><a href="#cb156-97" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb156-98"><a href="#cb156-98" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(</span>
<span id="cb156-99"><a href="#cb156-99" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> tb_indiv_unaware_ot<span class="sc">$</span>X1 <span class="sc">-</span> .<span class="dv">15</span>, </span>
<span id="cb156-100"><a href="#cb156-100" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> tb_indiv_unaware_ot<span class="sc">$</span>X2,</span>
<span id="cb156-101"><a href="#cb156-101" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste0</span>(<span class="fu">round</span>(<span class="dv">100</span><span class="sc">*</span>tb_indiv_unaware_ot<span class="sc">$</span>pred, <span class="dv">2</span>), <span class="st">"%"</span>),</span>
<span id="cb156-102"><a href="#cb156-102" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> colour_ot</span>
<span id="cb156-103"><a href="#cb156-103" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb156-104"><a href="#cb156-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-105"><a href="#cb156-105" aria-hidden="true" tabindex="-1"></a><span class="co"># Transported characteristics with Sequential transport</span></span>
<span id="cb156-106"><a href="#cb156-106" aria-hidden="true" tabindex="-1"></a>tb_indiv_unaware_seq <span class="ot">&lt;-</span> </span>
<span id="cb156-107"><a href="#cb156-107" aria-hidden="true" tabindex="-1"></a>  tb_indiv_unaware <span class="sc">|&gt;</span> <span class="fu">filter</span>(counterfactual <span class="sc">==</span> <span class="st">"seq"</span>)</span>
<span id="cb156-108"><a href="#cb156-108" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(</span>
<span id="cb156-109"><a href="#cb156-109" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> tb_indiv_unaware_seq<span class="sc">$</span>X1,</span>
<span id="cb156-110"><a href="#cb156-110" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> tb_indiv_unaware_seq<span class="sc">$</span>X2,</span>
<span id="cb156-111"><a href="#cb156-111" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> colour_seq,</span>
<span id="cb156-112"><a href="#cb156-112" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">"X1"</span>, <span class="at">ylab =</span> <span class="st">"X2"</span>,</span>
<span id="cb156-113"><a href="#cb156-113" aria-hidden="true" tabindex="-1"></a>  <span class="at">pch =</span> <span class="dv">19</span></span>
<span id="cb156-114"><a href="#cb156-114" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb156-115"><a href="#cb156-115" aria-hidden="true" tabindex="-1"></a><span class="co"># x1 then x2</span></span>
<span id="cb156-116"><a href="#cb156-116" aria-hidden="true" tabindex="-1"></a><span class="fu">segments</span>(</span>
<span id="cb156-117"><a href="#cb156-117" aria-hidden="true" tabindex="-1"></a>  <span class="at">x0 =</span> tb_indiv_unaware_factual<span class="sc">$</span>X1, </span>
<span id="cb156-118"><a href="#cb156-118" aria-hidden="true" tabindex="-1"></a>  <span class="at">y0 =</span> tb_indiv_unaware_factual<span class="sc">$</span>X2,</span>
<span id="cb156-119"><a href="#cb156-119" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> tb_indiv_unaware_seq<span class="sc">$</span>X1, </span>
<span id="cb156-120"><a href="#cb156-120" aria-hidden="true" tabindex="-1"></a>  <span class="at">y1 =</span> tb_indiv_unaware_factual<span class="sc">$</span>X2, </span>
<span id="cb156-121"><a href="#cb156-121" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> colour_seq,</span>
<span id="cb156-122"><a href="#cb156-122" aria-hidden="true" tabindex="-1"></a>  <span class="at">lty =</span> <span class="dv">2</span></span>
<span id="cb156-123"><a href="#cb156-123" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb156-124"><a href="#cb156-124" aria-hidden="true" tabindex="-1"></a><span class="fu">segments</span>(</span>
<span id="cb156-125"><a href="#cb156-125" aria-hidden="true" tabindex="-1"></a>  <span class="at">x0 =</span> tb_indiv_unaware_seq<span class="sc">$</span>X1, </span>
<span id="cb156-126"><a href="#cb156-126" aria-hidden="true" tabindex="-1"></a>  <span class="at">y0 =</span> tb_indiv_unaware_factual<span class="sc">$</span>X2,</span>
<span id="cb156-127"><a href="#cb156-127" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> tb_indiv_unaware_seq<span class="sc">$</span>X1, </span>
<span id="cb156-128"><a href="#cb156-128" aria-hidden="true" tabindex="-1"></a>  <span class="at">y1 =</span> tb_indiv_unaware_seq<span class="sc">$</span>X2, </span>
<span id="cb156-129"><a href="#cb156-129" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> colour_seq,</span>
<span id="cb156-130"><a href="#cb156-130" aria-hidden="true" tabindex="-1"></a>  <span class="at">lty =</span> <span class="dv">2</span></span>
<span id="cb156-131"><a href="#cb156-131" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb156-132"><a href="#cb156-132" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(</span>
<span id="cb156-133"><a href="#cb156-133" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> tb_indiv_unaware_seq<span class="sc">$</span>X1 <span class="sc">-</span> .<span class="dv">11</span>, </span>
<span id="cb156-134"><a href="#cb156-134" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> tb_indiv_unaware_seq<span class="sc">$</span>X2 <span class="sc">-</span> <span class="dv">1</span>,</span>
<span id="cb156-135"><a href="#cb156-135" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste0</span>(<span class="fu">round</span>(<span class="dv">100</span><span class="sc">*</span>tb_indiv_unaware_seq<span class="sc">$</span>pred, <span class="dv">2</span>), <span class="st">"%"</span>),</span>
<span id="cb156-136"><a href="#cb156-136" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> colour_seq</span>
<span id="cb156-137"><a href="#cb156-137" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb156-138"><a href="#cb156-138" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(</span>
<span id="cb156-139"><a href="#cb156-139" aria-hidden="true" tabindex="-1"></a>  <span class="st">"topleft"</span>, </span>
<span id="cb156-140"><a href="#cb156-140" aria-hidden="true" tabindex="-1"></a>  <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">col =</span> colours_all, <span class="at">legend =</span> <span class="fu">names</span>(colours_all)</span>
<span id="cb156-141"><a href="#cb156-141" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-example-3-black-inviv-unaware" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-example-3-black-inviv-unaware-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1.19: Predictions by the unaware model for three Black individuals.
</figcaption>
<div aria-describedby="fig-example-3-black-inviv-unaware-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="law_dataset_files/figure-html/fig-example-3-black-inviv-unaware-1.png" class="img-fluid figure-img" width="576">
</div>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-2-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb157"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb157-1"><a href="#cb157-1" aria-hidden="true" tabindex="-1"></a>tb_indiv_aware <span class="ot">&lt;-</span> </span>
<span id="cb157-2"><a href="#cb157-2" aria-hidden="true" tabindex="-1"></a>  factuals_aware <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">id =</span> <span class="fu">row_number</span>(), <span class="at">counterfactual =</span> <span class="st">"none"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb157-3"><a href="#cb157-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fairadapt</span></span>
<span id="cb157-4"><a href="#cb157-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(</span>
<span id="cb157-5"><a href="#cb157-5" aria-hidden="true" tabindex="-1"></a>    counterfactuals_aware_fpt <span class="sc">|&gt;</span> </span>
<span id="cb157-6"><a href="#cb157-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">id =</span> <span class="fu">row_number</span>(), <span class="at">counterfactual =</span> <span class="st">"fpt"</span>)</span>
<span id="cb157-7"><a href="#cb157-7" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb157-8"><a href="#cb157-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Multivariate optimal transport</span></span>
<span id="cb157-9"><a href="#cb157-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(</span>
<span id="cb157-10"><a href="#cb157-10" aria-hidden="true" tabindex="-1"></a>    counterfactuals_aware_ot <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">id =</span> <span class="fu">row_number</span>(), <span class="at">counterfactual =</span> <span class="st">"ot"</span>)</span>
<span id="cb157-11"><a href="#cb157-11" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb157-12"><a href="#cb157-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Sequential transport</span></span>
<span id="cb157-13"><a href="#cb157-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(</span>
<span id="cb157-14"><a href="#cb157-14" aria-hidden="true" tabindex="-1"></a>    counterfactuals_seq_aware_black <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">counterfactual =</span> <span class="st">"seq"</span>)</span>
<span id="cb157-15"><a href="#cb157-15" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb157-16"><a href="#cb157-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(id <span class="sc">%in%</span> counterfactuals_seq_aware_black<span class="sc">$</span>id[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>])</span>
<span id="cb157-17"><a href="#cb157-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-18"><a href="#cb157-18" aria-hidden="true" tabindex="-1"></a>tb_indiv_aware</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 12 × 7
   S        X1    X2   pred type              id counterfactual
   &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;          &lt;int&gt; &lt;chr&gt;         
 1 Black  2.8   29   0.133  factual           24 none          
 2 Black  3.2   19   0.0933 factual           40 none          
 3 Black  2.6   23   0.0882 factual           51 none          
 4 White  3.25  37.6 0.522  counterfactual    24 fpt           
 5 White  3.6   29.9 0.451  counterfactual    40 fpt           
 6 White  3.1   32.3 0.425  counterfactual    51 fpt           
 7 White  3.20  37.6 0.515  counterfactual    24 ot            
 8 White  3.29  28.0 0.386  counterfactual    40 ot            
 9 White  2.96  32.1 0.405  counterfactual    51 ot            
10 White  3.2   37   0.507  counterfactual    24 seq           
11 White  3.5   28.5 0.418  counterfactual    40 seq           
12 White  3.1   31.5 0.413  counterfactual    51 seq           </code></pre>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb159"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb159-1"><a href="#cb159-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar =</span> <span class="fu">c</span>(<span class="fl">4.1</span>, <span class="fl">4.1</span>, <span class="dv">0</span>, <span class="dv">0</span>))</span>
<span id="cb159-2"><a href="#cb159-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Initial characteristics with the aware model</span></span>
<span id="cb159-3"><a href="#cb159-3" aria-hidden="true" tabindex="-1"></a>tb_indiv_aware_factual <span class="ot">&lt;-</span> </span>
<span id="cb159-4"><a href="#cb159-4" aria-hidden="true" tabindex="-1"></a>  tb_indiv_aware <span class="sc">|&gt;</span> <span class="fu">filter</span>(type <span class="sc">==</span> <span class="st">"factual"</span>)</span>
<span id="cb159-5"><a href="#cb159-5" aria-hidden="true" tabindex="-1"></a>colour_factual <span class="ot">&lt;-</span> <span class="st">"black"</span></span>
<span id="cb159-6"><a href="#cb159-6" aria-hidden="true" tabindex="-1"></a>colour_fpt <span class="ot">&lt;-</span> <span class="st">"#D55E00"</span></span>
<span id="cb159-7"><a href="#cb159-7" aria-hidden="true" tabindex="-1"></a>colour_ot <span class="ot">&lt;-</span> <span class="st">"#56B4E9"</span></span>
<span id="cb159-8"><a href="#cb159-8" aria-hidden="true" tabindex="-1"></a>colour_seq <span class="ot">&lt;-</span> <span class="st">"#009E73"</span></span>
<span id="cb159-9"><a href="#cb159-9" aria-hidden="true" tabindex="-1"></a>colours_all <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb159-10"><a href="#cb159-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Factual"</span> <span class="ot">=</span> colour_factual,</span>
<span id="cb159-11"><a href="#cb159-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">"fairadapt"</span> <span class="ot">=</span> colour_fpt,</span>
<span id="cb159-12"><a href="#cb159-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">"OT"</span> <span class="ot">=</span> colour_ot,</span>
<span id="cb159-13"><a href="#cb159-13" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Seq T."</span> <span class="ot">=</span> colour_seq</span>
<span id="cb159-14"><a href="#cb159-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb159-15"><a href="#cb159-15" aria-hidden="true" tabindex="-1"></a>range_x1 <span class="ot">&lt;-</span> <span class="fu">range</span>(tb_indiv_aware<span class="sc">$</span>X1)</span>
<span id="cb159-16"><a href="#cb159-16" aria-hidden="true" tabindex="-1"></a>expansion_amount_x1 <span class="ot">&lt;-</span> .<span class="dv">1</span><span class="sc">*</span>range_x1</span>
<span id="cb159-17"><a href="#cb159-17" aria-hidden="true" tabindex="-1"></a>range_x2 <span class="ot">&lt;-</span> <span class="fu">range</span>(tb_indiv_aware<span class="sc">$</span>X2)</span>
<span id="cb159-18"><a href="#cb159-18" aria-hidden="true" tabindex="-1"></a>expansion_amount_x2 <span class="ot">&lt;-</span> .<span class="dv">05</span><span class="sc">*</span>range_x2</span>
<span id="cb159-19"><a href="#cb159-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-20"><a href="#cb159-20" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(</span>
<span id="cb159-21"><a href="#cb159-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> tb_indiv_aware_factual<span class="sc">$</span>X1,</span>
<span id="cb159-22"><a href="#cb159-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> tb_indiv_aware_factual<span class="sc">$</span>X2,</span>
<span id="cb159-23"><a href="#cb159-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> colour_factual,</span>
<span id="cb159-24"><a href="#cb159-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">""</span>, <span class="at">ylab =</span> <span class="st">""</span>,</span>
<span id="cb159-25"><a href="#cb159-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># xlab = "X1 (UGPA)", ylab = "X2 (LSAT)",</span></span>
<span id="cb159-26"><a href="#cb159-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlim =</span> <span class="fu">c</span>(range_x1[<span class="dv">1</span>] <span class="sc">-</span> expansion_amount_x1[<span class="dv">1</span>], range_x1[<span class="dv">2</span>] <span class="sc">+</span> expansion_amount_x1[<span class="dv">2</span>]),</span>
<span id="cb159-27"><a href="#cb159-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylim =</span> <span class="fu">c</span>(range_x2[<span class="dv">1</span>] <span class="sc">-</span> expansion_amount_x2[<span class="dv">1</span>], range_x2[<span class="dv">2</span>] <span class="sc">+</span> expansion_amount_x2[<span class="dv">2</span>]),</span>
<span id="cb159-28"><a href="#cb159-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">pch =</span> <span class="dv">19</span>,</span>
<span id="cb159-29"><a href="#cb159-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">axes =</span> <span class="cn">FALSE</span></span>
<span id="cb159-30"><a href="#cb159-30" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb159-31"><a href="#cb159-31" aria-hidden="true" tabindex="-1"></a><span class="fu">axis</span>(<span class="dv">1</span>)</span>
<span id="cb159-32"><a href="#cb159-32" aria-hidden="true" tabindex="-1"></a><span class="fu">mtext</span>(<span class="fu">expression</span>(X[<span class="dv">1</span>]<span class="sc">~</span>(UGCA)), <span class="at">side =</span> <span class="dv">1</span>)</span>
<span id="cb159-33"><a href="#cb159-33" aria-hidden="true" tabindex="-1"></a><span class="fu">axis</span>(<span class="dv">2</span>)</span>
<span id="cb159-34"><a href="#cb159-34" aria-hidden="true" tabindex="-1"></a><span class="fu">mtext</span>(<span class="fu">expression</span>(X[<span class="dv">2</span>]<span class="sc">~</span>(LSAT)), <span class="at">side =</span> <span class="dv">2</span>)</span>
<span id="cb159-35"><a href="#cb159-35" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(</span>
<span id="cb159-36"><a href="#cb159-36" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> tb_indiv_aware_factual<span class="sc">$</span>X1, </span>
<span id="cb159-37"><a href="#cb159-37" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> tb_indiv_aware_factual<span class="sc">$</span>X2 <span class="sc">+</span> <span class="dv">1</span>,</span>
<span id="cb159-38"><a href="#cb159-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste0</span>(<span class="fu">round</span>(<span class="dv">100</span><span class="sc">*</span>tb_indiv_aware_factual<span class="sc">$</span>pred, <span class="dv">2</span>), <span class="st">"%"</span>),</span>
<span id="cb159-39"><a href="#cb159-39" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> colour_factual</span>
<span id="cb159-40"><a href="#cb159-40" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb159-41"><a href="#cb159-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Transported characteristics with fairadapt</span></span>
<span id="cb159-42"><a href="#cb159-42" aria-hidden="true" tabindex="-1"></a>tb_indiv_aware_fpt <span class="ot">&lt;-</span> </span>
<span id="cb159-43"><a href="#cb159-43" aria-hidden="true" tabindex="-1"></a>  tb_indiv_aware <span class="sc">|&gt;</span> <span class="fu">filter</span>(counterfactual <span class="sc">==</span> <span class="st">"fpt"</span>)</span>
<span id="cb159-44"><a href="#cb159-44" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(</span>
<span id="cb159-45"><a href="#cb159-45" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> tb_indiv_aware_fpt<span class="sc">$</span>X1,</span>
<span id="cb159-46"><a href="#cb159-46" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> tb_indiv_aware_fpt<span class="sc">$</span>X2,</span>
<span id="cb159-47"><a href="#cb159-47" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> colour_fpt,</span>
<span id="cb159-48"><a href="#cb159-48" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">"X1"</span>, <span class="at">ylab =</span> <span class="st">"X2"</span>,</span>
<span id="cb159-49"><a href="#cb159-49" aria-hidden="true" tabindex="-1"></a>  <span class="at">pch =</span> <span class="dv">19</span></span>
<span id="cb159-50"><a href="#cb159-50" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb159-51"><a href="#cb159-51" aria-hidden="true" tabindex="-1"></a><span class="co"># x1 then x2</span></span>
<span id="cb159-52"><a href="#cb159-52" aria-hidden="true" tabindex="-1"></a><span class="fu">segments</span>(</span>
<span id="cb159-53"><a href="#cb159-53" aria-hidden="true" tabindex="-1"></a>  <span class="at">x0 =</span> tb_indiv_aware_factual<span class="sc">$</span>X1, </span>
<span id="cb159-54"><a href="#cb159-54" aria-hidden="true" tabindex="-1"></a>  <span class="at">y0 =</span> tb_indiv_aware_factual<span class="sc">$</span>X2,</span>
<span id="cb159-55"><a href="#cb159-55" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> tb_indiv_aware_fpt<span class="sc">$</span>X1, </span>
<span id="cb159-56"><a href="#cb159-56" aria-hidden="true" tabindex="-1"></a>  <span class="at">y1 =</span> tb_indiv_aware_factual<span class="sc">$</span>X2, </span>
<span id="cb159-57"><a href="#cb159-57" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> colour_fpt,</span>
<span id="cb159-58"><a href="#cb159-58" aria-hidden="true" tabindex="-1"></a>  <span class="at">lty =</span> <span class="dv">2</span></span>
<span id="cb159-59"><a href="#cb159-59" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb159-60"><a href="#cb159-60" aria-hidden="true" tabindex="-1"></a><span class="fu">segments</span>(</span>
<span id="cb159-61"><a href="#cb159-61" aria-hidden="true" tabindex="-1"></a>  <span class="at">x0 =</span> tb_indiv_aware_fpt<span class="sc">$</span>X1, </span>
<span id="cb159-62"><a href="#cb159-62" aria-hidden="true" tabindex="-1"></a>  <span class="at">y0 =</span> tb_indiv_aware_factual<span class="sc">$</span>X2,</span>
<span id="cb159-63"><a href="#cb159-63" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> tb_indiv_aware_fpt<span class="sc">$</span>X1, </span>
<span id="cb159-64"><a href="#cb159-64" aria-hidden="true" tabindex="-1"></a>  <span class="at">y1 =</span> tb_indiv_aware_fpt<span class="sc">$</span>X2, </span>
<span id="cb159-65"><a href="#cb159-65" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> colour_fpt,</span>
<span id="cb159-66"><a href="#cb159-66" aria-hidden="true" tabindex="-1"></a>  <span class="at">lty =</span> <span class="dv">2</span></span>
<span id="cb159-67"><a href="#cb159-67" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb159-68"><a href="#cb159-68" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(</span>
<span id="cb159-69"><a href="#cb159-69" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> tb_indiv_aware_fpt<span class="sc">$</span>X1, </span>
<span id="cb159-70"><a href="#cb159-70" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> tb_indiv_aware_fpt<span class="sc">$</span>X2 <span class="sc">+</span> <span class="dv">1</span>,</span>
<span id="cb159-71"><a href="#cb159-71" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste0</span>(<span class="fu">round</span>(<span class="dv">100</span><span class="sc">*</span>tb_indiv_aware_fpt<span class="sc">$</span>pred, <span class="dv">2</span>), <span class="st">"%"</span>),</span>
<span id="cb159-72"><a href="#cb159-72" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> colour_fpt</span>
<span id="cb159-73"><a href="#cb159-73" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb159-74"><a href="#cb159-74" aria-hidden="true" tabindex="-1"></a><span class="co"># Transported characteristics with OT</span></span>
<span id="cb159-75"><a href="#cb159-75" aria-hidden="true" tabindex="-1"></a>tb_indiv_aware_ot <span class="ot">&lt;-</span> </span>
<span id="cb159-76"><a href="#cb159-76" aria-hidden="true" tabindex="-1"></a>  tb_indiv_aware <span class="sc">|&gt;</span> <span class="fu">filter</span>(counterfactual <span class="sc">==</span> <span class="st">"ot"</span>)</span>
<span id="cb159-77"><a href="#cb159-77" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(</span>
<span id="cb159-78"><a href="#cb159-78" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> tb_indiv_aware_ot<span class="sc">$</span>X1,</span>
<span id="cb159-79"><a href="#cb159-79" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> tb_indiv_aware_ot<span class="sc">$</span>X2,</span>
<span id="cb159-80"><a href="#cb159-80" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> colour_ot,</span>
<span id="cb159-81"><a href="#cb159-81" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">"X1"</span>, <span class="at">ylab =</span> <span class="st">"X2"</span>,</span>
<span id="cb159-82"><a href="#cb159-82" aria-hidden="true" tabindex="-1"></a>  <span class="at">pch =</span> <span class="dv">19</span></span>
<span id="cb159-83"><a href="#cb159-83" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb159-84"><a href="#cb159-84" aria-hidden="true" tabindex="-1"></a><span class="co"># x1 then x2</span></span>
<span id="cb159-85"><a href="#cb159-85" aria-hidden="true" tabindex="-1"></a><span class="fu">segments</span>(</span>
<span id="cb159-86"><a href="#cb159-86" aria-hidden="true" tabindex="-1"></a>  <span class="at">x0 =</span> tb_indiv_aware_factual<span class="sc">$</span>X1, </span>
<span id="cb159-87"><a href="#cb159-87" aria-hidden="true" tabindex="-1"></a>  <span class="at">y0 =</span> tb_indiv_aware_factual<span class="sc">$</span>X2,</span>
<span id="cb159-88"><a href="#cb159-88" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> tb_indiv_aware_ot<span class="sc">$</span>X1, </span>
<span id="cb159-89"><a href="#cb159-89" aria-hidden="true" tabindex="-1"></a>  <span class="at">y1 =</span> tb_indiv_aware_factual<span class="sc">$</span>X2, </span>
<span id="cb159-90"><a href="#cb159-90" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> colour_ot,</span>
<span id="cb159-91"><a href="#cb159-91" aria-hidden="true" tabindex="-1"></a>  <span class="at">lty =</span> <span class="dv">2</span></span>
<span id="cb159-92"><a href="#cb159-92" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb159-93"><a href="#cb159-93" aria-hidden="true" tabindex="-1"></a><span class="fu">segments</span>(</span>
<span id="cb159-94"><a href="#cb159-94" aria-hidden="true" tabindex="-1"></a>  <span class="at">x0 =</span> tb_indiv_aware_ot<span class="sc">$</span>X1, </span>
<span id="cb159-95"><a href="#cb159-95" aria-hidden="true" tabindex="-1"></a>  <span class="at">y0 =</span> tb_indiv_aware_factual<span class="sc">$</span>X2,</span>
<span id="cb159-96"><a href="#cb159-96" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> tb_indiv_aware_ot<span class="sc">$</span>X1, </span>
<span id="cb159-97"><a href="#cb159-97" aria-hidden="true" tabindex="-1"></a>  <span class="at">y1 =</span> tb_indiv_aware_ot<span class="sc">$</span>X2, </span>
<span id="cb159-98"><a href="#cb159-98" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> colour_ot,</span>
<span id="cb159-99"><a href="#cb159-99" aria-hidden="true" tabindex="-1"></a>  <span class="at">lty =</span> <span class="dv">2</span></span>
<span id="cb159-100"><a href="#cb159-100" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb159-101"><a href="#cb159-101" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(</span>
<span id="cb159-102"><a href="#cb159-102" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> tb_indiv_aware_ot<span class="sc">$</span>X1 <span class="sc">-</span> .<span class="dv">15</span>, </span>
<span id="cb159-103"><a href="#cb159-103" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> tb_indiv_aware_ot<span class="sc">$</span>X2,</span>
<span id="cb159-104"><a href="#cb159-104" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste0</span>(<span class="fu">round</span>(<span class="dv">100</span><span class="sc">*</span>tb_indiv_aware_ot<span class="sc">$</span>pred, <span class="dv">2</span>), <span class="st">"%"</span>),</span>
<span id="cb159-105"><a href="#cb159-105" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> colour_ot</span>
<span id="cb159-106"><a href="#cb159-106" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb159-107"><a href="#cb159-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-108"><a href="#cb159-108" aria-hidden="true" tabindex="-1"></a><span class="co"># Transported characteristics with Sequential transport</span></span>
<span id="cb159-109"><a href="#cb159-109" aria-hidden="true" tabindex="-1"></a>tb_indiv_aware_seq <span class="ot">&lt;-</span> </span>
<span id="cb159-110"><a href="#cb159-110" aria-hidden="true" tabindex="-1"></a>  tb_indiv_aware <span class="sc">|&gt;</span> <span class="fu">filter</span>(counterfactual <span class="sc">==</span> <span class="st">"seq"</span>)</span>
<span id="cb159-111"><a href="#cb159-111" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(</span>
<span id="cb159-112"><a href="#cb159-112" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> tb_indiv_aware_seq<span class="sc">$</span>X1,</span>
<span id="cb159-113"><a href="#cb159-113" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> tb_indiv_aware_seq<span class="sc">$</span>X2,</span>
<span id="cb159-114"><a href="#cb159-114" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> colour_seq,</span>
<span id="cb159-115"><a href="#cb159-115" aria-hidden="true" tabindex="-1"></a>  <span class="at">xlab =</span> <span class="st">"X1"</span>, <span class="at">ylab =</span> <span class="st">"X2"</span>,</span>
<span id="cb159-116"><a href="#cb159-116" aria-hidden="true" tabindex="-1"></a>  <span class="at">pch =</span> <span class="dv">19</span></span>
<span id="cb159-117"><a href="#cb159-117" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb159-118"><a href="#cb159-118" aria-hidden="true" tabindex="-1"></a><span class="co"># x1 then x2</span></span>
<span id="cb159-119"><a href="#cb159-119" aria-hidden="true" tabindex="-1"></a><span class="fu">segments</span>(</span>
<span id="cb159-120"><a href="#cb159-120" aria-hidden="true" tabindex="-1"></a>  <span class="at">x0 =</span> tb_indiv_aware_factual<span class="sc">$</span>X1, </span>
<span id="cb159-121"><a href="#cb159-121" aria-hidden="true" tabindex="-1"></a>  <span class="at">y0 =</span> tb_indiv_aware_factual<span class="sc">$</span>X2,</span>
<span id="cb159-122"><a href="#cb159-122" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> tb_indiv_aware_seq<span class="sc">$</span>X1, </span>
<span id="cb159-123"><a href="#cb159-123" aria-hidden="true" tabindex="-1"></a>  <span class="at">y1 =</span> tb_indiv_aware_factual<span class="sc">$</span>X2, </span>
<span id="cb159-124"><a href="#cb159-124" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> colour_seq,</span>
<span id="cb159-125"><a href="#cb159-125" aria-hidden="true" tabindex="-1"></a>  <span class="at">lty =</span> <span class="dv">2</span></span>
<span id="cb159-126"><a href="#cb159-126" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb159-127"><a href="#cb159-127" aria-hidden="true" tabindex="-1"></a><span class="fu">segments</span>(</span>
<span id="cb159-128"><a href="#cb159-128" aria-hidden="true" tabindex="-1"></a>  <span class="at">x0 =</span> tb_indiv_aware_seq<span class="sc">$</span>X1, </span>
<span id="cb159-129"><a href="#cb159-129" aria-hidden="true" tabindex="-1"></a>  <span class="at">y0 =</span> tb_indiv_aware_factual<span class="sc">$</span>X2,</span>
<span id="cb159-130"><a href="#cb159-130" aria-hidden="true" tabindex="-1"></a>  <span class="at">x1 =</span> tb_indiv_aware_seq<span class="sc">$</span>X1, </span>
<span id="cb159-131"><a href="#cb159-131" aria-hidden="true" tabindex="-1"></a>  <span class="at">y1 =</span> tb_indiv_aware_seq<span class="sc">$</span>X2, </span>
<span id="cb159-132"><a href="#cb159-132" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> colour_seq,</span>
<span id="cb159-133"><a href="#cb159-133" aria-hidden="true" tabindex="-1"></a>  <span class="at">lty =</span> <span class="dv">2</span></span>
<span id="cb159-134"><a href="#cb159-134" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb159-135"><a href="#cb159-135" aria-hidden="true" tabindex="-1"></a><span class="fu">text</span>(</span>
<span id="cb159-136"><a href="#cb159-136" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> tb_indiv_aware_seq<span class="sc">$</span>X1 <span class="sc">-</span> .<span class="dv">11</span>, </span>
<span id="cb159-137"><a href="#cb159-137" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> tb_indiv_aware_seq<span class="sc">$</span>X2 <span class="sc">-</span> <span class="dv">1</span>,</span>
<span id="cb159-138"><a href="#cb159-138" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste0</span>(<span class="fu">round</span>(<span class="dv">100</span><span class="sc">*</span>tb_indiv_aware_seq<span class="sc">$</span>pred, <span class="dv">2</span>), <span class="st">"%"</span>),</span>
<span id="cb159-139"><a href="#cb159-139" aria-hidden="true" tabindex="-1"></a>  <span class="at">col =</span> colour_seq</span>
<span id="cb159-140"><a href="#cb159-140" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb159-141"><a href="#cb159-141" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(</span>
<span id="cb159-142"><a href="#cb159-142" aria-hidden="true" tabindex="-1"></a>  <span class="st">"topleft"</span>, </span>
<span id="cb159-143"><a href="#cb159-143" aria-hidden="true" tabindex="-1"></a>  <span class="at">pch =</span> <span class="dv">19</span>, <span class="at">col =</span> colours_all, <span class="at">legend =</span> <span class="fu">names</span>(colours_all)</span>
<span id="cb159-144"><a href="#cb159-144" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="fig-example-3-black-inviv-aware" class="quarto-figure quarto-figure-center quarto-float anchored">
<figure class="quarto-float quarto-float-fig figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-fig" id="fig-example-3-black-inviv-aware-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1.20: Predictions by the aware model for three Black individuals.
</figcaption>
<div aria-describedby="fig-example-3-black-inviv-aware-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="law_dataset_files/figure-html/fig-example-3-black-inviv-aware-1.png" class="img-fluid figure-img" width="576">
</div>
</figure>
</div>
</div>
</div>
</div>
</div>
</div>


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-black2020fliptest" class="csl-entry" role="listitem">
Black, Emily, Samuel Yeom, and Matt Fredrikson. 2020. <span>“Fliptest: Fairness Testing via Optimal Transport.”</span> In <em>Proceedings of the 2020 Conference on Fairness, Accountability, and Transparency</em>, 111–21.
</div>
<div id="ref-de2024transport" class="csl-entry" role="listitem">
De Lara, Lucas, Alberto González-Sanz, Nicholas Asher, Laurent Risser, and Jean-Michel Loubes. 2024. <span>“Transport-Based Counterfactual Models.”</span> <em>Journal of Machine Learning Research</em> 25 (136): 1–59.
</div>
<div id="ref-Kusner17" class="csl-entry" role="listitem">
Kusner, Matt J, Joshua Loftus, Chris Russell, and Ricardo Silva. 2017. <span>“Counterfactual Fairness.”</span> In <em>Advances in Neural Information Processing Systems 30</em>, edited by I. Guyon, U. V. Luxburg, S. Bengio, H. Wallach, R. Fergus, S. Vishwanathan, and R. Garnett, 4066–76. NIPS.
</div>
<div id="ref-delara2021transportbased" class="csl-entry" role="listitem">
Lara, Lucas de, Alberto González-Sanz, Nicholas Asher, and Jean-Michel Loubes. 2021. <span>“Transport-Based Counterfactual Models.”</span> <em>arXiv</em> 2108.13025.
</div>
<div id="ref-plevcko2021fairadapt" class="csl-entry" role="listitem">
Plečko, Drago, Nicolas Bennett, and Nicolai Meinshausen. 2021. <span>“Fairadapt: Causal Reasoning for Fair Data Pre-Processing.”</span> <em>arXiv Preprint arXiv:2110.10200</em>.
</div>
<div id="ref-sander2004systemic" class="csl-entry" role="listitem">
Sander, Richard H. 2004. <span>“A Systemic Analysis of Affirmative Action in American Law Schools.”</span> <em>Stan. L. Rev.</em> 57: 367.
</div>
<div id="ref-Wightman1998LSACNL" class="csl-entry" role="listitem">
Wightman, Linda F. 1998. <span>“LSAC National Longitudinal Bar Passage Study. LSAC Research Report Series.”</span> In. <a href="https://api.semanticscholar.org/CorpusID:151073942">https://api.semanticscholar.org/CorpusID:151073942</a>.
</div>
</div>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./index.html" class="pagination-link" aria-label="Introduction">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Introduction</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./references.html" class="pagination-link" aria-label="References">
        <span class="nav-page-text">References</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>