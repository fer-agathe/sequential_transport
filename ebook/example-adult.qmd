# Adult Dataset {#sec-adult-dataset}



::: callout-note

## Objectives

In this chapter, we extend the analysis from the previous part to the Adult Income dataset from the [UCI Machine Learning Repository](https://archive.ics.uci.edu/dataset/2/adult). We use a cleaned version of this dataset available in the {[fairadapt](https://github.com/dplecko/fairadapt)} R package.

:::

```{r setup, message=FALSE, warning=FALSE}
#| code-fold: true
#| code-summary: Display the setting codes

# Required packages----
library(tidyverse)

# Graphs----
font_main = font_title = 'Times New Roman'
extrafont::loadfonts(quiet = T)
face_text='plain'
face_title='plain'
size_title = 14
size_text = 11
legend_size = 11

global_theme <- function() {
  theme_minimal() %+replace%
    theme(
      text = element_text(family = font_main, size = size_text, face = face_text),
      legend.text = element_text(family = font_main, size = legend_size),
      axis.text = element_text(size = size_text, face = face_text), 
      plot.title = element_text(
        family = font_title, 
        size = size_title, 
        hjust = 0.5
      ),
      plot.subtitle = element_text(hjust = 0.5)
    )
}

# Seed
set.seed(2025)

colours_all <- c(
  "factual" = "gray",
  "source" = "#00A08A",
  "reference" = "#F2AD00",
  "naive" = "#000000",
  "ot" = "#0072B2",
  "fairadapt" = '#D55E00',
  "seq" = "#CC79A7"
)
```

The adult dataset contains information that allow to predict whether a person's income (Y) is over $50,000 a year. We will use gender as the protected binary variable here (S). Other characteristics such as the age, the native country, the marital status and so on will be used. Note that unlike previously, the set of covariates includes both numerical and categorical variables.


```{r define-vars}
vars <- c(
  "sex", "age", "native_country", "marital_status", "education_num",
  "workclass", "hours_per_week", "occupation", "income"
)
s <- "sex"
y <- "income"
```

The data can be loaded as follows:

```{r adult-dataset}
library(fairadapt)
# reading in the UCI Adult data
adult <- readRDS(
  system.file("extdata", "uci_adult.rds", package = "fairadapt")
) |>
  as_tibble() |> 
  select(!!vars)
```

We can have a quick glance at the proportion of women and men among people who earn more, or less, than $50k a year.
```{r show-prop-gender-income}
adult |> count(income, sex) |> 
  group_by(income) |> 
  mutate(pct_gender = round(100* n / sum(n), 2))
```

We will assume the same causal graph as in @plevcko2020fair (Figure 4, p. 27).

```{r}
# Adjacency matrix
adj_mat <- c(
  0, 0, 0, 1, 1, 1, 1, 1, 1, # sex
  0, 0, 0, 1, 1, 1, 1, 1, 1, # age
  0, 0, 0, 1, 1, 1, 1, 1, 1, # native_country
  0, 0, 0, 0, 1, 1, 1, 1, 1, # marital_status
  0, 0, 0, 0, 0, 1, 1, 1, 1, # education_num
  0, 0, 0, 0, 0, 0, 0, 0, 1, # workclass
  0, 0, 0, 0, 0, 0, 0, 0, 1, # hours_per_week
  0, 0, 0, 0, 0, 0, 0, 0, 1, # occupation
  0, 0, 0, 0, 0, 0, 0, 0, 0  # income
) |> matrix(
  nrow = length(vars), ncol = length(vars),
  dimnames = list(vars, vars), byrow = TRUE
)
```

```{r}
#| fig-cap: "Assumed Causal Graph"
#| label: fig-causal-graph-adult
causal_graph <- fairadapt::graphModel(adj_mat)
plot(causal_graph)
```

We can visualize this causal graph with a prettier representation, using a tikz picture.

```{r code-create-graph}
#| code-fold: true
#| code-summary: R codes to generate a prettier causal graph
G <- igraph::graph_from_adjacency_matrix(adj_mat)
L <- igraph::layout_with_fr(G)
N <- rownames(adj_mat)
N[3] <- "native country"
N[4] <- "marital status"
N[5] <- "education"
N[7] <- "hours per week"
E <- matrix(NA, sum(adj_mat), 2)

# plot(L, col = "white")
# text(L[, 1], L[, 2], N, pos = 1)
i_s = 0
for (i in 1:nrow(adj_mat)) {
  for (j in which(adj_mat[i, ] > 0)) {
    i_s <- i_s + 1
    # arrows(L[i, 1], L[i, 2], L[j, 1], L[j, 2], length = .1)
    E[i_s, ] <- c(i, j)
  }
}

edges <- list()
for(i in 1:nrow(E)) edges[[i]] <- E[i,]

CRDNT <- L
CRDNT[, 1] <- (L[, 1] - min(L[, 1])) * 10 / (max(L[, 1]) - min(L[, 1]))
CRDNT[, 2] <- (L[, 2] - min(L[, 2])) * 5 / (max(L[, 2]) - min(L[, 2]))

coordinates <- list()
for (i in 1:nrow(CRDNT)) coordinates[[i]] <- CRDNT[i, ]

name_nodes <- N

generate_nodes <- function(coordinates) {
  tikz_nodes <- ""
  for (i in seq_along(coordinates)) {
    x <- coordinates[[i]][1]
    y <- coordinates[[i]][2]
    nm <- name_nodes[i]
    ligne <- paste0(
      sprintf("\\node[fill=yellow!60] (n%d) at (%.1f, %.1f) {", i, x, y),
      nm, "};\n"
    )
    tikz_nodes <- paste0(tikz_nodes, ligne)
  }
  tikz_nodes
}

#' Function to generate TikZ code for edges
generate_edges <- function(edges) {
  tikz_edges <- ""
  for (edge in edges) {
    tikz_edges <- paste0(
      tikz_edges,
      sprintf("\\draw[->, black] (n%d) -- (n%d);\n", edge[1], edge[2])
    )
  }
  tikz_edges
}

# Combine and print the TikZ code
generate_tikz <- function(coordinates, edges) {
  nodes <- generate_nodes(coordinates)
  edges <- generate_edges(edges)
  tikz_code <- paste0(
    "\\begin{tikzpicture}\n", nodes, edges, "\\end{tikzpicture}"
  )
  tikz_code
}

# Generate and print the TikZ code
# cat(generate_tikz(coordinates, edges))
tikz_code <- generate_tikz(coordinates, edges)
```

```{r}
#| include: false
add_tikz_graph <- function(tikz_code) {
  res <- knitr::knit_child(
    text = glue::glue(r"(
             ```{{tikz}}
             #| label: fig-tikz-ex
             #| fig-cap: Causal Graph
             #| fig-ext: png
             #| code-fold: true
             #| code-summary: Tikz code
             \usetikzlibrary{{arrows}}
             {tikz_code}
             ```)"
  ), 
  quiet = TRUE
  )
  knitr::asis_output(res)
}
```

`r add_tikz_graph(tikz_code)`



## Classifier

We load functions defined in our small package (notably, `split_dataset()`{.R}):

```{r}
library(devtools)
load_all("../seqtransfairness/")
```


We fit a logistic regression model on the data to predict the outcome binary variable. First, we split the dataset into two sets: train (70%) and test (30%).
```{r}
seed <- 2025
sets <- split_dataset(adult, seed, train_ratio = 0.7)
data_train <- sets$data_train
data_test <- sets$data_test
```

As in [Chapter -@sec-classifier], we train two models:

1. **unaware logistic regression classifier**: model without including the sensitive attribute.
2. **aware logistic regression classifier**: model with the sensitive attribute included in the set of features.


To do so, we define the training function, `log_reg_train()`{.R}.

```{r define-log_reg_train}
#| code-fold: true
#| code-summary: The `log_reg_train()`{.R} function.
#' @param train_data Train set.
#' @param test_data Test set.
#' @param s Name of the sensitive attribute.
#' @param y Name of the target variable.
#' @param type If `"type=aware"`, the model includes the sensitive attributes,
#'        otherwise, if `type=unaware`, it does not.
#' 
#' @returns A list with three elements:
#' * `model`: The estimated logistic regression model.
#' * `pred_train`: Estimated scores on the train set.
#' * `pred_test`: Estimated scores on the test set.
#' 
#' @importFrom dplyr select
#' @importFrom rlang !!
#' @importFrom stats glm predict as.formula
log_reg_train <- function(train_data,
                          test_data,
                          s,
                          y,
                          type = c("aware", "unaware")) {
  if (type == "unaware") {
    train_data_ <- train_data %>% select(-!!s)
    test_data_ <- test_data %>% select(-!!s)
  } else {
    train_data_ <- train_data
    test_data_ <- test_data
  }
  # Train the logistic regression model
  form <- paste0(y, "~.")
  model <- glm(as.formula(form), data = train_data_, family = binomial)
  # Predictions on train and test sets
  pred_train <- predict(model, newdata = train_data_, type = "response")
  pred_test <- predict(model, newdata = test_data_, type = "response")
  list(
    model = model,
    pred_train = pred_train,
    pred_test = pred_test
  )
}
```


Let us train the two models. Then, we extract the predicted values on both the train set and the test set.

```{r define-pred_unaware}
# Unaware logistic regression classifier (model without S)
pred_unaware <- log_reg_train(data_train, data_test, s = s, y = y, type = "unaware")
pred_unaware_train <- pred_unaware$pred_train
pred_unaware_test <- pred_unaware$pred_test

# Aware logistic regression classifier (model with S)
pred_aware <- log_reg_train(data_train, data_test, s = s, y = y, type = "aware")
pred_aware_train <- pred_aware$pred_train
pred_aware_test <- pred_aware$pred_test
```

We create a table for each model, with the sensitive attribute and the predicted value by the model ($\hat{y}$), only for observations from the test set.

```{r define-df_test_unaware}
df_test_unaware <- tibble(
  S = data_test |> pull(!!s),
  pred = pred_unaware_test
)

df_test_aware <- tibble(
  S = data_test |> pull(!!s),
  pred = pred_aware_test
)
```


### Predictions

We predict values with the unaware model on the factuals:

```{r define-model_unaware}
model_unaware <- pred_unaware$model
pred_unaware_all <- predict(
  model_unaware,
  newdata = adult,
  type = "response"
)
```

And with the aware model:
```{r define-model_aware}
model_aware <- pred_aware$model
pred_aware_all <- predict(
  model_aware,
  newdata = adult,
  type = "response"
)
```

### Saving Objects

```{r save-classifier-results}
save(pred_aware, file = "../data/pred_aware_adult.rda")
save(pred_unaware, file = "../data/pred_unaware_adult.rda")
save(pred_unaware_all, file = "../data/pred_unaware_all_adult.rda")
save(pred_aware_all, file = "../data/pred_aware_all_adult.rda")
```

## Naive approach: _ceteris paribus_

Let us change the sensitive attribute of individuals from the source group (women) to the target group (men). Then, we use both models (unaware and aware) to predict the target binary variable.

```{r define-pred_unaware_naive}
pred_unaware_naive_women <- predict(
  model_unaware,
  newdata = adult |> filter(sex == "Female") |> mutate(sex = "Male"),
  type = "response"
)
pred_aware_naive_women <- predict(
  model_aware,
  newdata = adult |> filter(sex == "Female") |>  mutate(sex = "Male"),
  type = "response"
)

ind_women <- which(adult$sex == "Female")
ind_men <- which(adult$sex == "Male")

counterfactuals_unaware_naive_women <- 
  adult |> filter(sex == "Female") |> 
  mutate(
    sex_origin = sex,
    sex = "Male",
    pred = pred_unaware_naive_women,
    type = "counterfactual",
    id_indiv = ind_women
  )
counterfactuals_aware_naive_women <- 
  adult |> filter(sex == "Female") |> 
  mutate(
    sex_origin = sex,
    sex = "Male",
    pred = pred_aware_naive_women,
    type = "counterfactual",
    id_indiv = ind_women
  )
```

### Unaware Model

Let us have a look at the distribution of the predicted scores of the classifier in both groups, when the predictions are made after setting the sex attribute of all women to "Male". Since the model does not use the sensitive attribute, changing it will result in absolutely no change in its predictions in this case.

The predicted values using the initial characteristics (the factuals), for the unaware model are stored in the object `pred_unaware_all`. We put in a table the initial characteristics (factuals) and the prediction made by the unaware model:

```{r define-factuals_unaware}
factuals_unaware <-
  adult |> 
  as_tibble() |>
  mutate(
    sex_origin = sex,
    pred = pred_unaware_all,
    type = "factual"
  ) |> 
    mutate(id_indiv = row_number())
```


```{r define-unaware_naive}
unaware_naive_women <- 
  factuals_unaware |> mutate(sex_origin = sex) |> 
  bind_rows(counterfactuals_unaware_naive_women)
```

The unaware model is blind to the sensitive attribute. Hence, changing the sensitive attribute does not affect the predicted scores.

```{r, message=FALSE, warning=FALSE}
#| fig-cap: "Unaware model, Sensitive: Sex, Woman -> Man"
#| label: fig-naive-unaware-adult-ref-men
#| fig-width: 8
ggplot(
  unaware_naive_women |> mutate(
    group = case_when(
      sex_origin == "Female" & sex == "Female" ~ "Women (Original)",
      sex_origin == "Female" & sex == "Male" ~ "Women -> Men (Counterfactual)",
      sex_origin == "Male" & sex == "Male" ~ "Men (Original)"
    ),
    group = factor(
      group, 
      levels = c(
        "Women (Original)", "Women -> Men (Counterfactual)", "Men (Original)"
      )
    )
  ),
  aes(x = pred, fill = group, colour = group)
) +
  geom_histogram(
    mapping = aes(
      y = after_stat(density)), alpha = 0.5, colour = NA,
    position = "identity", binwidth = 0.05
  ) +
  geom_density(alpha = 0.3, linewidth = 1) +
  facet_wrap(~sex) +
  scale_fill_manual(
    NULL, values = c(
      "Women (Original)" = colours_all[["source"]],
      "Women -> Men (Counterfactual)" = colours_all[["naive"]],
      "Men (Original)" = colours_all[["reference"]]
    )
  ) +
  scale_colour_manual(
    NULL, values = c(
      "Women (Original)" = colours_all[["source"]],
      "Women -> Men (Counterfactual)" = colours_all[["naive"]],
      "Men (Original)" = colours_all[["reference"]]
    )
  ) +
  labs(
    x = "Predictions for Y",
    y = "Density"
  ) +
  global_theme() +
  theme(legend.position = "bottom")
```

Then, we focus on the distribution of predicted scores for ccounterfactual of Women and factuals of men. Again, since the model is blind to the sensitive attribute, the distributions are perfectly aligned.

```{r, message=FALSE, warning=FALSE}
#| fig-cap: "Distribution of Predicted Scores for Minority Class (Women), Unaware model, Sensitive: Race, Woman -> Man"
#| label: fig-naive-unaware-sex-ref-men-source-only
#| code-fold: true
#| fig-width: 7
ggplot(
  data = unaware_naive_women |> 
    mutate(
      group = case_when(
        sex_origin == "Female" & sex == "Female" ~ "Women (Original)",
        sex_origin == "Female" & sex == "Male" ~ "Women -> Men (Counterfactual)",
        sex_origin == "Male" & sex == "Male" ~ "Men (Original)"
      ),
      group = factor(
        group, 
        levels = c(
          "Women (Original)", "Women -> Men (Counterfactual)", "Men (Original)"
        )
      )
    ) |> 
    filter(sex_origin == "Female"),
  mapping = aes(x = pred, fill = group)
) +
  geom_histogram(
    mapping = aes(y = after_stat(density)), 
    alpha = 0.5, position = "identity", binwidth = 0.05
  ) +
  geom_density(alpha = 0.5) +
  scale_fill_manual(
    NULL, values = c(
      "Women (Original)" = colours_all[["source"]],
      "Women -> Men (Counterfactual)" = colours_all[["naive"]],
      "Men (Original)" = colours_all[["reference"]]
    )
  ) +
  scale_colour_manual(
    NULL, values = c(
      "Women (Original)" = colours_all[["source"]],
      "Women -> Men (Counterfactual)" = colours_all[["naive"]],
      "Men (Original)" = colours_all[["reference"]]
    )
  ) +
  labs(
    x = "Predictions for Y",
    y = "Density"
  ) +
  global_theme() +
  theme(legend.position = "bottom")
```



### Aware Model

We turn to the aware model. This time, the sensitive attribute is used by the classifier when it is trained. Hence, changing the sensitive attribute of individuals in the source group to that of the target group may change the predicted values for the binary outcome variable.

The predicted values by the model, on the initial characteristics (on the factuals) are stored in the `pred_aware_all` object.

We create a tibble with the factuals and the predictions by the aware model:
```{r define-fairadapt-factuals_aware}
factuals_aware <-
  adult |> 
  as_tibble() |>
  mutate(
    sex_origin = sex,
    pred = pred_aware_all,
    type = "factual"
  ) |> 
    mutate(id_indiv = row_number())
```

```{r define-aware_naive}
aware_naive_women <- 
  factuals_aware |> mutate(sex_origin = sex) |> 
  bind_rows(counterfactuals_aware_naive_women)
```

```{r, message=FALSE, warning=FALSE}
#| fig-cap: "Aware model, Sensitive: Sex, Woman -> Man"
#| label: fig-naive-aware-adult-ref-men
#| fig-width: 8
ggplot(
  aware_naive_women |> mutate(
    group = case_when(
      sex_origin == "Female" & sex == "Female" ~ "Women (Original)",
      sex_origin == "Female" & sex == "Male" ~ "Women -> Men (Counterfactual)",
      sex_origin == "Male" & sex == "Male" ~ "Men (Original)"
    ),
    group = factor(
      group, 
      levels = c(
        "Women (Original)", "Women -> Men (Counterfactual)", "Men (Original)"
      )
    )
  ),
  aes(x = pred, fill = group, colour = group)
) +
  geom_histogram(
    mapping = aes(
      y = after_stat(density)), alpha = 0.5, colour = NA,
    position = "identity", binwidth = 0.05
  ) +
  geom_density(alpha = 0.3, linewidth = 1) +
  facet_wrap(~sex) +
  scale_fill_manual(
    NULL, values = c(
      "Women (Original)" = colours_all[["source"]],
      "Women -> Men (Counterfactual)" = colours_all[["naive"]],
      "Men (Original)" = colours_all[["reference"]]
    )
  ) +
  scale_colour_manual(
    NULL, values = c(
      "Women (Original)" = colours_all[["source"]],
      "Women -> Men (Counterfactual)" = colours_all[["naive"]],
      "Men (Original)" = colours_all[["reference"]]
    )
  ) +
  labs(
    x = "Predictions for Y",
    y = "Density"
  ) +
  global_theme() +
  theme(legend.position = "bottom")
```

Then, we focus on the distribution of predicted scores for ccounterfactual of Women and factuals of men.

```{r, message=FALSE, warning=FALSE}
#| fig-cap: "Distribution of Predicted Scores for Minority Class (Women), Aware model, Sensitive: Race, Woman -> Man"
#| label: fig-naive-aware-sex-ref-men-source-only
#| code-fold: true
#| fig-width: 7
ggplot(
  data = aware_naive_women |> 
    mutate(
      group = case_when(
        sex_origin == "Female" & sex == "Female" ~ "Women (Original)",
        sex_origin == "Female" & sex == "Male" ~ "Women -> Men (Counterfactual)",
        sex_origin == "Male" & sex == "Male" ~ "Men (Original)"
      ),
      group = factor(
        group, 
        levels = c(
          "Women (Original)", "Women -> Men (Counterfactual)", "Men (Original)"
        )
      )
    ) |> 
    filter(sex_origin == "Female"),
  mapping = aes(x = pred, fill = group)
) +
  geom_histogram(
    mapping = aes(y = after_stat(density)), 
    alpha = 0.5, position = "identity", binwidth = 0.05
  ) +
  geom_density(alpha = 0.5) +
  scale_fill_manual(
    NULL, values = c(
      "Women (Original)" = colours_all[["source"]],
      "Women -> Men (Counterfactual)" = colours_all[["naive"]],
      "Men (Original)" = colours_all[["reference"]]
    )
  ) +
  scale_colour_manual(
    NULL, values = c(
      "Women (Original)" = colours_all[["source"]],
      "Women -> Men (Counterfactual)" = colours_all[["naive"]],
      "Men (Original)" = colours_all[["reference"]]
    )
  ) +
  labs(
    x = "Predictions for Y",
    y = "Density"
  ) +
  global_theme() +
  theme(legend.position = "bottom")
```

## Fairadapt {#sec-adult-dataset-fairadapt}

We have already assumed a causal graph (see @fig-causal-graph-adult).

Let us consider that we want to build counterfactuals for women: what if the individual had been a man and not a woman?


Let us have a look at the levels of our sensitive variable:
```{r levels-sensitive}
levels(adult |> pull(!!s))
```

Two configurations will be considered in turn:

1. The reference class consists of men, and fairadapt will be used to obtain the counterfactual values for women as if they had been men.
1. The reference class consists of women, and fairadapt will be used to obtain the counterfactual values for men as if they had been women.


```{r define-adapt_df_women}
# Women (factuals) --> Men (counterfactuals)
df_fpt <- adult |> mutate(sex = fct_relevel(sex, "Female", after = Inf))
fpt_model_women <- fairadapt(
  income ~ .,
  train.data = df_fpt,
  prot.attr = "sex", adj.mat = adj_mat,
  quant.method = rangerQuants
)
adapt_df_women <- adaptedData(fpt_model_women)

# Men (factuals) --> Women (counterfactuals)
df_fpt <- df_fpt |> mutate(sex = fct_relevel(sex, "Male", after = Inf))
fpt_model_men <- fairadapt(
  income ~ .,
  train.data = df_fpt,
  prot.attr = "sex", adj.mat = adj_mat,
  quant.method = rangerQuants
)
adapt_df_men <- adaptedData(fpt_model_men)
```


Let us wrap up:

- we have **two predictive models** for the income variable (greater than 50k per year, or lower than or equal to 50k per year): 

  - **unaware** (without S)
  - **aware** (with S)

- we have the **counterfactual characteristics** obtained with fairadapt in two situations depending on the reference class:

  - **women** individuals as **reference**
  - **men** individuals as **reference**.
  
The predictive models will be used to **compare predictions** made using:

- Raw characteristics (initial characteristics).
- Characteristics possibly altered through fairadapt for individuals who were not in the reference group (i.e., using counterfactuals).

### Unaware Model

Let us build a dataset containing only counterfactual characteristics obtained with fairadapt.

```{r define-df_counterfactuals_fpt, message=FALSE, warning=FALSE}
pred_unaware_fpt_women <- predict(
  model_unaware, 
  newdata = adapt_df_women[ind_women, ], 
  type = "response"
)
pred_unaware_fpt_men <- predict(
  model_unaware, 
  newdata = adapt_df_men[ind_men, ],
  type = "response"
)
```

We create a table with the counterfactual characteristics and the prediction by the unaware model:


```{r define-pred_unaware_fpt}
counterfactuals_unaware_fpt_women <- 
  as_tibble(adapt_df_women[ind_women, ]) |> 
  mutate(
    sex_origin = adult$sex[ind_women],
    pred = pred_unaware_fpt_women,
    type = "counterfactual",
    id_indiv = ind_women
  )

counterfactuals_unaware_fpt_men <- 
  as_tibble(adapt_df_men[ind_men, ]) |> 
  mutate(
    sex_origin = adult$sex[ind_men],
    pred = pred_unaware_fpt_men,
    type = "counterfactual",
    id_indiv = ind_men
  )
```


We merge the two datasets, `factuals_unaware` and `counterfactuals_unaware_fpt_women` (or `counterfactuals_unaware_fpt_men`) in a single one.
```{r define-unaware_fpt}
unaware_fpt_women <- 
  factuals_unaware |> mutate(sex_origin = sex) |> 
  bind_rows(counterfactuals_unaware_fpt_women)
  
unaware_fpt_men <- 
  factuals_unaware |> mutate(sex_origin = sex) |> 
  bind_rows(counterfactuals_unaware_fpt_men)
```


:::{.panel-tabset}

#### Woman -> Man

```{r, message=FALSE, warning=FALSE}
#| fig-cap: "Unaware model, Sensitive: Sex, Woman -> Man"
#| label: fig-fpt-unaware-sex-ref-men
#| code-fold: true
#| fig-width: 7
ggplot(
  data = unaware_fpt_women |> 
    mutate(
      group = case_when(
        sex_origin == "Female" & sex == "Female" ~ "Women (Original)",
        sex_origin == "Female" & sex == "Male" ~ "Women -> Men (Counterfactual)",
        sex_origin == "Male" & sex == "Male" ~ "Men (Original)"
      ),
      group = factor(
        group, 
        levels = c(
          "Women (Original)", "Women -> Men (Counterfactual)", "Men (Original)"
        )
      )
    ),
  aes(x = pred, fill = group, colour = group)
) +
  geom_histogram(
    mapping = aes(
      y = after_stat(density)), alpha = 0.5, colour = NA,
    position = "identity", binwidth = 0.05
  ) +
  geom_density(alpha = 0.3, linewidth = 1) +
  facet_wrap(~sex) +
  scale_fill_manual(
    NULL, values = c(
      "Women (Original)" = colours_all[["source"]],
      "Women -> Men (Counterfactual)" = colours_all[["fairadapt"]],
      "Men (Original)" = colours_all[["reference"]]
    )
  ) +
  scale_colour_manual(
    NULL, values = c(
      "Women (Original)" = colours_all[["source"]],
      "Women -> Men (Counterfactual)" = colours_all[["fairadapt"]],
      "Men (Original)" = colours_all[["reference"]]
    )
  ) +
  labs(
    x = "Predictions for Y",
    y = "Density"
  ) +
  global_theme() +
  theme(legend.position = "bottom")
```

#### Man -> Woman

```{r, message=FALSE, warning=FALSE}
#| fig-cap: "Unaware model, Sensitive: Sex, Man -> Woman"
#| label: fig-fpt-unaware-sex-ref-women
#| code-fold: true
#| fig-width: 7
ggplot(
  data = unaware_fpt_men |> 
    mutate(
      group = case_when(
        sex_origin == "Male" & sex == "Male" ~ "Men (Original)",
        sex_origin == "Male" & sex == "Female" ~ "Men -> Women (Counterfactual)",
        sex_origin == "Female" & sex == "Female" ~ "Women (Original)"
      ),
      group = factor(
        group, 
        levels = c(
          "Men (Original)", "Men -> Women (Counterfactual)", "Women (Original)"
        )
      )
    ),
  aes(x = pred, fill = group, colour = group)
) +
  geom_histogram(
    mapping = aes(
      y = after_stat(density)), alpha = 0.5, colour = NA,
    position = "identity", binwidth = 0.05
  ) +
  geom_density(alpha = 0.3, linewidth = 1) +
  facet_wrap(~sex) +
  scale_fill_manual(
    NULL, values = c(
      "Men (Original)" = colours_all[["source"]],
      "Men -> Women (Counterfactual)" = colours_all[["fairadapt"]],
      "Women (Original)" = colours_all[["reference"]]
    )
  ) +
  scale_colour_manual(
    NULL, values = c(
      "Men (Original)" = colours_all[["source"]],
      "Men -> Women (Counterfactual)" = colours_all[["fairadapt"]],
      "Women (Original)" = colours_all[["reference"]]
    )
  ) +
  labs(
    x = "Predictions for Y",
    y = "Density"
  ) +
  global_theme() +
  theme(legend.position = "bottom")
```

:::

Then, we focus on the distribution of predicted scores for counterfactual of women and factuals of men.


:::{.panel-tabset}

#### Woman -> Man

```{r, message=FALSE, warning=FALSE}
#| fig-cap: "Distribution of Predicted Scores for Minority Class (Women), Unaware model, Sensitive: Sex, Woman -> Man"
#| label: fig-fpt-unaware-sex-ref-men-source-only
#| code-fold: true
#| fig-width: 7
ggplot(
  data = unaware_fpt_women |> 
    mutate(
      group = case_when(
        sex_origin == "Female" & sex == "Female" ~ "Women (Original)",
        sex_origin == "Female" & sex == "Male" ~ "Women -> Men (Counterfactual)",
        sex_origin == "Male" & sex == "Male" ~ "Men (Original)"
      ),
      group = factor(
        group, 
        levels = c(
          "Women (Original)", "Women -> Men (Counterfactual)", "Men (Original)"
        )
      )
    ) |> 
    filter(sex_origin == "Female"),
  mapping = aes(x = pred, fill = group)
) +
  geom_histogram(
    mapping = aes(y = after_stat(density)), 
    alpha = 0.5, position = "identity", binwidth = 0.05
  ) +
  geom_density(alpha = 0.5) +
  scale_fill_manual(
    NULL, values = c(
      "Women (Original)" = colours_all[["source"]],
      "Women -> Men (Counterfactual)" = colours_all[["fairadapt"]],
      "Men (Original)" = colours_all[["reference"]]
    )
  ) +
  scale_colour_manual(
    NULL, values = c(
      "Women (Original)" = colours_all[["source"]],
      "Women -> Men (Counterfactual)" = colours_all[["fairadapt"]],
      "Men (Original)" = colours_all[["reference"]]
    )
  ) +
  labs(
    x = "Predictions for Y",
    y = "Density"
  ) +
  global_theme() +
  theme(legend.position = "bottom")
```

#### Man -> Woman

```{r, message=FALSE, warning=FALSE}
#| fig-cap: "Distribution of Predicted Scores for Minority Class (White), Unaware model, Sensitive: Race, Man -> Woman"
#| label: fig-fpt-unaware-sex-ref-women-source-only
#| code-fold: true
#| fig-width: 7
ggplot(
  data = unaware_fpt_men |> 
    mutate(
      group = case_when(
        sex_origin == "Male" & sex == "Male" ~ "Men (Original)",
        sex_origin == "Male" & sex == "Female" ~ "Men -> Women (Counterfactual)",
        sex_origin == "Female" & sex == "Female" ~ "Women (Original)"
      ),
      group = factor(
        group, 
        levels = c(
          "Men (Original)", "Men -> Women (Counterfactual)", "Women (Original)"
        )
      )
    ) |> 
    filter(sex_origin == "Male"),
  mapping = aes(x = pred, fill = group)) +
  geom_histogram(
    mapping = aes(y = after_stat(density)), 
    alpha = 0.5, position = "identity", binwidth = 0.05
  ) +
  geom_density(alpha = 0.5) +
  scale_fill_manual(
    NULL, values = c(
      "Men (Original)" = colours_all[["source"]],
      "Men -> Women (Counterfactual)" = colours_all[["fairadapt"]]
    )
  ) +
  scale_colour_manual(
    NULL, values = c(
      "Men (Original)" = colours_all[["source"]],
      "Men -> Women (Counterfactual)" = colours_all[["fairadapt"]]
    )
  ) +
  labs(
    x = "Predictions for Y",
    y = "Density"
  ) +
  global_theme() +
  theme(legend.position = "bottom")
```

:::


### Aware Model

Now, we turn to the model that includes the sensitive attribute, i.e., the aware model. Let us get the predicted values for the counterfactuals, using the aware model:

```{r predict-fairadapt-aware-counterfactuals, message=FALSE, warning=FALSE}
pred_aware_fpt_women <- predict(
  model_aware, 
  newdata = adapt_df_women[ind_women, ], 
  type = "response"
)
pred_aware_fpt_men <- predict(
  model_aware, 
  newdata = adapt_df_men[ind_men, ],
  type = "response"
)
```

Then, we create a table with the counterfactuals and the predicted value by the aware model:
```{r define-fairadapt-counterfactuals_aware}
counterfactuals_aware_fpt_women <- 
  as_tibble(adapt_df_women[ind_women, ]) |> 
  mutate(
    sex_origin = adult$sex[ind_women],
    pred = pred_aware_fpt_women,
    type = "counterfactual",
    id_indiv = ind_women
  )

counterfactuals_aware_fpt_men <- 
  as_tibble(adapt_df_men[ind_men, ]) |> 
  mutate(
    sex_origin = adult$sex[ind_men],
    pred = pred_aware_fpt_men,
    type = "counterfactual",
    id_indiv = ind_men
  )
```

We merge the two datasets, `factuals_unaware` and `counterfactuals_aware_fpt_women` (or `counterfactuals_aware_fpt_men`) in a single one.

```{r define-aware_fpt_women}
# dataset with counterfactuals, for aware model
aware_fpt_women <- 
  factuals_aware |> mutate(ses_origin = sex) |> 
  bind_rows(counterfactuals_aware_fpt_women)
  
aware_fpt_men <- 
  factuals_aware |> mutate(sew_origin = sex) |> 
  bind_rows(counterfactuals_aware_fpt_men)
```


:::{.panel-tabset}

#### Women -> Men

```{r, message=FALSE, warning=FALSE}
#| fig-cap: "Aware model, Sensitive: Race, Reference: Men individuals"
#| label: fig-fpt-aware-sex-ref-men
#| code-fold: true
#| fig-width: 7
ggplot(
  data = aware_fpt_women |> 
    mutate(
      group = case_when(
        sex_origin == "Female" & sex == "Female" ~ "Women (Original)",
        sex_origin == "Female" & sex == "Male" ~ "Women -> Men (Counterfactual)",
        sex_origin == "Male" & sex == "Male" ~ "Men (Original)"
      ),
      group = factor(
        group, 
        levels = c(
          "Women (Original)", "Women -> Men (Counterfactual)", "Men (Original)"
        )
      )
    ),
  aes(x = pred, fill = group, colour = group)
) +
  geom_histogram(
    mapping = aes(
      y = after_stat(density)), alpha = 0.5, colour = NA,
    position = "identity", binwidth = 0.05
  ) +
  geom_density(alpha = 0.3, linewidth = 1) +
  facet_wrap(~sex) +
  scale_fill_manual(
    NULL, values = c(
      "Women (Original)" = colours_all[["source"]],
      "Women -> Men (Counterfactual)" = colours_all[["fairadapt"]],
      "Men (Original)" = colours_all[["reference"]]
    )
  ) +
  scale_colour_manual(
    NULL, values = c(
      "Women (Original)" = colours_all[["source"]],
      "Women -> Men (Counterfactual)" = colours_all[["fairadapt"]],
      "Men (Original)" = colours_all[["reference"]]
    )
  ) +
  labs(
    x = "Predictions for Y",
    y = "Density"
  ) +
  global_theme() +
  theme(legend.position = "bottom")
```

#### Men -> Women

```{r, message=FALSE, warning=FALSE}
#| fig-cap: "Aware model, Sensitive: Race, Reference: Women individuals"
#| label: fig-fpt-aware-sex-ref-women
#| code-fold: true
#| fig-width: 7
ggplot(
  data = aware_fpt_men |> 
    mutate(
      group = case_when(
        sex_origin == "Male" & sex == "Male" ~ "Men (Original)",
        sex_origin == "Male" & sex == "Female" ~ "Men -> Women (Counterfactual)",
        sex_origin == "Female" & sex == "Female" ~ "Women (Original)"
      ),
      group = factor(
        group, 
        levels = c(
          "Men (Original)", "Men -> Women (Counterfactual)", "Women (Original)"
        )
      )
    ),
  aes(x = pred, fill = group, colour = group)
) +
  geom_histogram(
    mapping = aes(
      y = after_stat(density)), alpha = 0.5, colour = NA,
    position = "identity", binwidth = 0.05
  ) +
  geom_density(alpha = 0.3, linewidth = 1) +
  facet_wrap(~sex) +
  scale_fill_manual(
    NULL, values = c(
      "Men (Original)" = colours_all[["source"]],
      "Men -> Women (Counterfactual)" = colours_all[["fairadapt"]],
      "Women (Original)" = colours_all[["reference"]]
    )
  ) +
  scale_colour_manual(
    NULL, values = c(
      "Men (Original)" = colours_all[["source"]],
      "Men -> Women (Counterfactual)" = colours_all[["fairadapt"]],
      "Women (Original)" = colours_all[["reference"]]
    )
  ) +
  labs(
    x = "Predictions for Y",
    y = "Density"
  ) +
  global_theme() +
  theme(legend.position = "bottom")
```

:::
  
Then, we focus on the distribution of predicted scores forcounterfactual of Women students and factuals of men students.


:::{.panel-tabset}

#### Women -> Men

```{r, message=FALSE, warning=FALSE}
#| fig-cap: "Distribution of Predicted Scores for Minority Class (Women), Aware model, Sensitive: Race, Reference: Men individuals"
#| label: fig-fpt-aware-sex-ref-men-source-only
#| code-fold: true
#| fig-width: 7
ggplot(
  data = aware_fpt_women |> 
    mutate(
      group = case_when(
        sex_origin == "Female" & sex == "Female" ~ "Women (Original)",
        sex_origin == "Female" & sex == "Male" ~ "Women -> Men (Counterfactual)",
        sex_origin == "Male" & sex == "Male" ~ "Men (Original)"
      ),
      group = factor(
        group, 
        levels = c(
          "Women (Original)", "Women -> Men (Counterfactual)", "Men (Original)"
        )
      )
    ) |> 
    filter(sex_origin == "Female"),
  mapping = aes(x = pred, fill = group)
) +
  geom_histogram(
    mapping = aes(y = after_stat(density)), 
    alpha = 0.5, position = "identity", binwidth = 0.05
  ) +
  geom_density(alpha = 0.5) +
  scale_fill_manual(
    NULL, values = c(
      "Women (Original)" = colours_all[["source"]],
      "Women -> Men (Counterfactual)" = colours_all[["fairadapt"]],
      "Men (Original)" = colours_all[["reference"]]
    )
  ) +
  scale_colour_manual(
    NULL, values = c(
      "Women (Original)" = colours_all[["source"]],
      "Women -> Men (Counterfactual)" = colours_all[["fairadapt"]],
      "Men (Original)" = colours_all[["reference"]]
    )
  ) +
  labs(
    x = "Predictions for Y",
    y = "Density"
  ) +
  global_theme() +
  theme(legend.position = "bottom")
```

#### Men -> Women

```{r, message=FALSE, warning=FALSE}
#| fig-cap: "Distribution of Predicted Scores for Minority Class (Men), Aware model, Sensitive: Race, Reference: Women individuals"
#| label: fig-fpt-aware-sex-ref-women-source-only
#| code-fold: true
#| fig-width: 7
ggplot(
  data = aware_fpt_men |> 
    mutate(
      group = case_when(
        sex_origin == "Male" & sex == "Male" ~ "Men (Original)",
        sex_origin == "Male" & sex == "Female" ~ "Men -> Women (Counterfactual)",
        sex_origin == "Female" & sex == "Female" ~ "Women (Original)"
      ),
      group = factor(
        group, 
        levels = c(
          "Men (Original)", "Men -> Women (Counterfactual)", "Women (Original)"
        )
      )
    ) |> 
    filter(sex_origin == "Male"),
  mapping = aes(x = pred, fill = group)) +
  geom_histogram(
    mapping = aes(y = after_stat(density)), 
    alpha = 0.5, position = "identity", binwidth = 0.05
  ) +
  geom_density(alpha = 0.5) +
  scale_fill_manual(
    NULL, values = c(
      "Men (Original)" = colours_all[["source"]],
      "Men -> Women (Counterfactual)" = colours_all[["fairadapt"]]
    )
  ) +
  scale_colour_manual(
    NULL, values = c(
      "Men (Original)" = colours_all[["source"]],
      "Men -> Women (Counterfactual)" = colours_all[["fairadapt"]]
    )
  ) +
  labs(
    x = "Predictions for Y",
    y = "Density"
  ) +
  global_theme() +
  theme(legend.position = "bottom")
```

:::
  

## Sequential Transport

We now turn to sequential transport (the methodology developed in our paper). We use the `seq_trans()`{.R} function defined in our small package to perform a fast sequential transport on causal graph.

We use the same causal graph as in @sec-adult-dataset-fairadapt.

```{r define-trans_x1_then_x2}
sequential_transport <- seq_trans(
  data = adult, adj = adj_mat, s = "sex", S_0 = "Female", y = "income"
)
```

We build a dataset with the sensitive attribute of Women changed to Male, and their characteristics changed to their transported characteristics:

```{r define-df_counterfactuals_seq_women}
df_counterfactuals_seq_women <- 
  as_tibble(sequential_transport$transported) |> 
  mutate(
    id_indiv = ind_women,
    sex_origin = "Female",
    sex = "Male"
  )
```

We make predictions based on those counterfactuals obtained with sequential transport, on both models (the unaware model, and the aware model):
```{r seqt-pred_seqt_unaware, warning=FALSE}
pred_seq_unaware <- predict(
  model_unaware, newdata = df_counterfactuals_seq_women, type = "response"
)

pred_seq_aware <- predict(
  model_aware, newdata = df_counterfactuals_seq_women, type = "response"
)
```

```{r define-counterfactuals_unaware_seq_women}
counterfactuals_unaware_seq_women <- 
  df_counterfactuals_seq_women |> 
  mutate(pred = pred_seq_unaware, type = "counterfactual")
counterfactuals_aware_seq_women <- 
  df_counterfactuals_seq_women |> 
  mutate(pred = pred_seq_aware, type = "counterfactual")
```

Let us put in a single table the predictions made by the classifier (either aware or unaware) on Women based on their factual characteristics, and those made based on the counterfactuals:
```{r define-aware_seq_black}
aware_seq_women <- bind_rows(
  factuals_aware |> mutate(id_indiv = row_number(), sex_origin = sex), 
  counterfactuals_aware_seq_women |> mutate(S_origin = "Female")
)
unaware_seq_women <- bind_rows(
  factuals_unaware |> mutate(id_indiv = row_number(), sex_origin = sex), 
  counterfactuals_unaware_seq_women |> mutate(S_origin = "Female")
)
```

:::{.panel-tabset}


### Unaware

```{r, message=FALSE, warning=FALSE}
#| fig-cap: "Unaware model, Sensitive: Race, Woman -> Man"
#| label: fig-seq-unaware-sex-ref-men
#| code-fold: true
#| fig-width: 7
ggplot(
  data = unaware_seq_women |> 
    mutate(
      group = case_when(
        sex_origin == "Female" & sex == "Female" ~ "Women (Original)",
        sex_origin == "Female" & sex == "Male" ~ "Women -> Men (Counterfactual)",
        sex_origin == "Male" & sex == "Male" ~ "Men (Original)"
      ),
      group = factor(
        group, 
        levels = c(
          "Women (Original)", "Women -> Men (Counterfactual)", "Men (Original)"
        )
      )
    ),
  aes(x = pred, fill = group, colour = group)
) +
  geom_histogram(
    mapping = aes(
      y = after_stat(density)), alpha = 0.5, colour = NA,
    position = "identity", binwidth = 0.05
  ) +
  geom_density(alpha = 0.3, linewidth = 1) +
  facet_wrap(~sex) +
  scale_fill_manual(
    NULL, values = c(
      "Women (Original)" = colours_all[["source"]],
      "Women -> Men (Counterfactual)" = colours_all[["seq"]],
      "Men (Original)" = colours_all[["reference"]]
    )
  ) +
  scale_colour_manual(
    NULL, values = c(
      "Women (Original)" = colours_all[["source"]],
      "Women -> Men (Counterfactual)" = colours_all[["seq"]],
      "Men (Original)" = colours_all[["reference"]]
    )
  ) +
  labs(
    x = "Predictions for Y",
    y = "Density"
  ) +
  global_theme() +
  theme(legend.position = "bottom")
```

### Aware

```{r}
#| fig-cap: "Aware model, Sensitive: Race, Woman -> Man"
#| label: fig-seq-aware-sex-ref-men
#| code-fold: true
#| fig-width: 7
ggplot(
  data = aware_seq_women |> 
    mutate(
      group = case_when(
        sex_origin == "Female" & sex == "Female" ~ "Women (Original)",
        sex_origin == "Female" & sex == "Male" ~ "Women -> Men (Counterfactual)",
        sex_origin == "Male" & sex == "Male" ~ "Men (Original)"
      ),
      group = factor(
        group, 
        levels = c(
          "Women (Original)", "Women -> Men (Counterfactual)", "Men (Original)"
        )
      )
    ),
  aes(x = pred, fill = group, colour = group)
) +
  geom_histogram(
    mapping = aes(
      y = after_stat(density)), alpha = 0.5, colour = NA,
    position = "identity", binwidth = 0.05
  ) +
  geom_density(alpha = 0.3, linewidth = 1) +
  facet_wrap(~sex) +
  scale_fill_manual(
    NULL, values = c(
      "Women (Original)" = colours_all[["source"]],
      "Women -> Men (Counterfactual)" = colours_all[["seq"]],
      "Men (Original)" = colours_all[["reference"]]
    )
  ) +
  scale_colour_manual(
    NULL, values = c(
      "Women (Original)" = colours_all[["source"]],
      "Women -> Men (Counterfactual)" = colours_all[["seq"]],
      "Men (Original)" = colours_all[["reference"]]
    )
  ) +
  labs(
    x = "Predictions for Y",
    y = "Density"
  ) +
  global_theme() +
  theme(legend.position = "bottom")
```


:::
  
Then, we focus on the distribution of predicted scores forcounterfactual of Women students and factuals of white students.

:::{.panel-tabset}

### Unaware

```{r, message=FALSE, warning=FALSE}
#| fig-cap: "Distribution of Predicted Scores for Minority Class (Women), Unaware model, Sensitive: Race, Woman -> Man"
#| label: fig-seq-unaware-sex-ref-men-source-only
#| code-fold: true
#| fig-width: 7
ggplot(
  data = unaware_seq_women |> 
    mutate(
      group = case_when(
        sex_origin == "Female" & sex == "Female" ~ "Women (Original)",
        sex_origin == "Female" & sex == "Male" ~ "Women -> Men (Counterfactual)",
        sex_origin == "Male" & sex == "Male" ~ "Men (Original)"
      ),
      group = factor(
        group, 
        levels = c(
          "Women (Original)", "Women -> Men (Counterfactual)", "Men (Original)"
        )
      )
    ) |> 
    filter(sex_origin == "Female"),
  mapping = aes(x = pred, fill = group)
) +
  geom_histogram(
    mapping = aes(y = after_stat(density)), 
    alpha = 0.5, position = "identity", binwidth = 0.05
  ) +
  geom_density(alpha = 0.5) +
  scale_fill_manual(
    NULL, values = c(
      "Women (Original)" = colours_all[["source"]],
      "Women -> Men (Counterfactual)" = colours_all[["seq"]],
      "Men (Original)" = colours_all[["reference"]]
    )
  ) +
  scale_colour_manual(
    NULL, values = c(
      "Women (Original)" = colours_all[["source"]],
      "Women -> Men (Counterfactual)" = colours_all[["seq"]],
      "Men (Original)" = colours_all[["reference"]]
    )
  ) +
  labs(
    x = "Predictions for Y",
    y = "Density"
  ) +
  global_theme() +
  theme(legend.position = "bottom")
```

### Aware

```{r, message=FALSE, warning=FALSE}
#| fig-cap: "Distribution of Predicted Scores for Minority Class (Women), Aware model, Sensitive: Race, Woman -> Man"
#| label: fig-seq-aware-sex-ref-men-source-only
#| code-fold: true
#| fig-width: 7
ggplot(
  data = aware_seq_women |> 
    mutate(
      group = case_when(
        sex_origin == "Female" & sex == "Female" ~ "Women (Original)",
        sex_origin == "Female" & sex == "Male" ~ "Women -> Men (Counterfactual)",
        sex_origin == "Male" & sex == "Male" ~ "Men (Original)"
      ),
      group = factor(
        group, 
        levels = c(
          "Women (Original)", "Women -> Men (Counterfactual)", "Men (Original)"
        )
      )
    ) |> 
    filter(sex_origin == "Female"),
  mapping = aes(x = pred, fill = group)
) +
  geom_histogram(
    mapping = aes(y = after_stat(density)), 
    alpha = 0.5, position = "identity", binwidth = 0.05
  ) +
  geom_density(alpha = 0.5) +
  scale_fill_manual(
    NULL, values = c(
      "Women (Original)" = colours_all[["source"]],
      "Women -> Men (Counterfactual)" = colours_all[["seq"]],
      "Men (Original)" = colours_all[["reference"]]
    )
  ) +
  scale_colour_manual(
    NULL, values = c(
      "Women (Original)" = colours_all[["source"]],
      "Women -> Men (Counterfactual)" = colours_all[["seq"]],
      "Men (Original)" = colours_all[["reference"]]
    )
  ) +
  labs(
    x = "Predictions for Y",
    y = "Density"
  ) +
  global_theme() +
  theme(legend.position = "bottom")
```

:::


## Comparison

Let us now compare the results.


:::{.panel-tabset}

### Unaware Model

```{r}
tb_unaware <- 
  factuals_unaware |> mutate(counterfactual = "none") |>
  # Naive
  bind_rows(
    counterfactuals_unaware_naive_women |> mutate(counterfactual = "naive")
  ) |> 
  # Fairadapt
  bind_rows(
    counterfactuals_unaware_fpt_women |> mutate(counterfactual = "fpt")
  ) |> 
  # Sequential transport
  bind_rows(
    counterfactuals_unaware_seq_women |> mutate(counterfactual = "seq")
  )
```




### Aware Model

```{r}
tb_aware <- 
  factuals_aware |> mutate(counterfactual = "none") |> 
  # Naive
  bind_rows(
    counterfactuals_aware_naive_women |> mutate(counterfactual = "naive")
  ) |> 
  # Fairadapt
  bind_rows(
    counterfactuals_aware_fpt_women |> mutate(counterfactual = "fpt")
  ) |> 
  # Sequential transport
  bind_rows(
    counterfactuals_aware_seq_women |> mutate(counterfactual = "seq")
  )
```

:::


Let us compare the densities of the predicted values.


:::{.panel-tabset}

### Unaware model

```{r}
#| fig-cap: Densities of predicted scores for Women with factuals and with counterfactuals. The yellow dashed line corresponds to the density of predicted scores for Women, using factuals.
#| label: fig-densities-counterfactuals-unaware-adult
#| fig-width: 4
#| fig-height: 4
#| code-fold: true
# Factuals
tb_unaware_factuals <- tb_unaware |> filter(counterfactual == "none")
# Predicted values
pred_unaware_factuals_women <- tb_unaware_factuals |> filter(sex == "Female") |> pull("pred")
pred_unaware_factuals_men <- tb_unaware_factuals |> filter(sex == "Male") |> pull("pred")
# Estimated densities
d_unaware_factuals_women <- density(pred_unaware_factuals_women)
d_unaware_factuals_men <- density(pred_unaware_factuals_men)

par(mfrow = c(3, 1), mar = c(2, 2, 0, 0))
x_lim <- c(0, .8)
y_lim <- c(0, 10)

# Naive
tb_unaware_naive <- tb_unaware |> filter(counterfactual == "naive")
# Predicted values, focusing on Black --> White
pred_unaware_naive_women_star <- tb_unaware_naive |> filter(sex == "Male") |> pull("pred")
# Estimated densities
d_unaware_naive_women_star <- density(pred_unaware_naive_women_star)

plot(
  d_unaware_factuals_women,
  main = "", xlab = "", ylab = "",
  axes = FALSE, col = NA,
  xlim = x_lim, ylim = y_lim
)
axis(1)
axis(2)
polygon(d_unaware_factuals_women, col = alpha(colours_all[["source"]], .5), border = NA)
lines(d_unaware_factuals_men, col = colours_all[["reference"]], lty = 2, lwd = 2)
polygon(d_unaware_naive_women_star, col = alpha(colours_all[["naive"]], .5), border = NA)
pos_arrow_ref <- .6
text(x = pos_arrow_ref, y = 8, "Factuals - Men", col = colours_all[["reference"]])
ind_min_ref <- which.min(abs(d_unaware_factuals_men$x - pos_arrow_ref))
arrows(
  x1 = d_unaware_factuals_men$x[ind_min_ref],
  y1 = d_unaware_factuals_men$y[ind_min_ref],
  x0 = pos_arrow_ref, 
  y0 = 7,
  length = 0.05, col = colours_all[["reference"]]
)
text(x = .09, y = 8, "Naive", col = colours_all[["naive"]])


# Fairadapt
tb_unaware_fpt <- tb_unaware |> filter(counterfactual == "fpt")
# Predicted values, focusing on Black --> White
pred_unaware_fpt_women_star <- 
  tb_unaware_fpt |> filter(sex == "Male") |> pull("pred")
# Estimated densities
d_unaware_fpt_women_star <- density(pred_unaware_fpt_women_star)

plot(
  d_unaware_factuals_women,
  main = "", xlab = "", ylab = "",
  axes = FALSE, col = NA,
  xlim = x_lim, ylim = y_lim
)
axis(1)
axis(2)
polygon(d_unaware_factuals_women, col = alpha(colours_all[["source"]], .5), border = NA)
lines(d_unaware_factuals_men, col = colours_all[["reference"]], lty = 2, lwd = 2)
polygon(d_unaware_fpt_women_star, col = alpha(colours_all[["fairadapt"]], .5), border = NA)
text(x = .15, y = 6, "Factuals - Women", col = colours_all[["source"]])
pos_arrow <- .07
ind_min <- which.min(abs(d_unaware_factuals_women$x - pos_arrow))
arrows(
  x1 = d_unaware_factuals_women$x[ind_min],
  y1 = d_unaware_factuals_women$y[ind_min],
  x0 = .15, 
  y0 = 5,
  length = 0.05, col = colours_all[["source"]]
)
text(x = .4, y = 6, "fairadapt", col = colours_all[["fairadapt"]])


# Sequential transport
tb_unaware_seq <- tb_unaware |> filter(counterfactual == "seq")
# Predicted values, focusing on Black --> White
pred_unaware_seq_women_star <- tb_unaware_seq |> filter(sex == "Male") |> pull("pred")
# Estimated densities
d_unaware_seq_women_star <- density(pred_unaware_seq_women_star)

plot(
  d_unaware_factuals_women,
  main = "", xlab = "", ylab = "",
  axes = FALSE, col = NA,
  xlim = x_lim, ylim = y_lim
)
axis(1)
axis(2)
polygon(d_unaware_factuals_women, col = alpha(colours_all[["source"]], .5), border = NA)
lines(d_unaware_factuals_men, col = colours_all[["reference"]], lty = 2, lwd = 2)
polygon(d_unaware_seq_women_star, col = alpha(colours_all[["seq"]], .5), border = NA)
text(x = .4, y = 6, "Seq. T.", col = colours_all[["seq"]])
```

### Aware model

```{r}
#| fig-cap: Densities of predicted scores for Women with factuals and with counterfactuals. The yellow dashed line corresponds to the density of predicted scores for Women, using factuals.
#| label: fig-densities-counterfactuals-aware-adult
#| fig-width: 4
#| fig-height: 4
#| code-fold: true
# Factuals
tb_aware_factuals <- tb_aware |> filter(counterfactual == "none")
# Predicted values
pred_aware_factuals_women <- tb_aware_factuals |> filter(sex == "Female") |> pull("pred")
pred_aware_factuals_men <- tb_aware_factuals |> filter(sex == "Male") |> pull("pred")
# Estimated densities
d_aware_factuals_women <- density(pred_aware_factuals_women)
d_aware_factuals_men <- density(pred_aware_factuals_men)

par(mfrow = c(3, 1), mar = c(2, 2, 0, 0))
x_lim <- c(0, .8)
y_lim <- c(0, 16)

# Naive
tb_aware_naive <- tb_aware |> filter(counterfactual == "naive")
# Predicted values, focusing on Black --> White
pred_aware_naive_women_star <- tb_aware_naive |> filter(sex == "Male") |> pull("pred")
# Estimated densities
d_aware_naive_women_star <- density(pred_aware_naive_women_star)

plot(
  d_aware_factuals_women,
  main = "", xlab = "", ylab = "",
  axes = FALSE, col = NA,
  xlim = x_lim, ylim = y_lim
)
axis(1)
axis(2)
polygon(d_aware_factuals_women, col = alpha(colours_all[["source"]], .5), border = NA)
lines(d_aware_factuals_men, col = colours_all[["reference"]], lty = 2, lwd = 2)
polygon(d_aware_naive_women_star, col = alpha(colours_all[["naive"]], .5), border = NA)
text(x = .15, y = 13, "Factuals - Women", col = colours_all[["source"]])
pos_arrow <- .03
ind_min <- which.min(abs(d_aware_factuals_women$x - pos_arrow))
arrows(
  x1 = d_aware_factuals_women$x[ind_min],
  y1 = d_aware_factuals_women$y[ind_min],
  x0 = .15, 
  y0 = 11,
  length = 0.05, col = colours_all[["source"]]
)
pos_arrow_ref <- .6
text(x = pos_arrow_ref, y = 13, "Factuals - Men", col = colours_all[["reference"]])
ind_min_ref <- which.min(abs(d_aware_factuals_men$x - pos_arrow_ref))
arrows(
  x1 = d_aware_factuals_men$x[ind_min_ref],
  y1 = d_aware_factuals_men$y[ind_min_ref],
  x0 = pos_arrow_ref, 
  y0 = 11,
  length = 0.05, col = colours_all[["reference"]]
)
text(x = .4, y = 6, "Naive", col = colours_all[["naive"]])


# Fairadapt
tb_aware_fpt <- tb_aware |> filter(counterfactual == "fpt")
# Predicted values, focusing on Black --> White
pred_aware_fpt_women_star <- 
  tb_aware_fpt |> filter(sex == "Male") |> pull("pred")
# Estimated densities
d_aware_fpt_women_star <- density(pred_aware_fpt_women_star)

plot(
  d_aware_factuals_women,
  main = "", xlab = "", ylab = "",
  axes = FALSE, col = NA,
  xlim = x_lim, ylim = y_lim
)
axis(1)
axis(2)
polygon(d_aware_factuals_women, col = alpha(colours_all[["source"]], .5), border = NA)
lines(d_aware_factuals_men, col = colours_all[["reference"]], lty = 2, lwd = 2)
polygon(d_aware_fpt_women_star, col = alpha(colours_all[["fairadapt"]], .5), border = NA)
text(x = .4, y = 6, "fairadapt", col = colours_all[["fairadapt"]])


# Sequential transport
tb_aware_seq <- tb_aware |> filter(counterfactual == "seq")
# Predicted values, focusing on Black --> White
pred_aware_seq_women_star <- tb_aware_seq |> filter(sex == "Male") |> pull("pred")
# Estimated densities
d_aware_seq_women_star <- density(pred_aware_seq_women_star)

plot(
  d_aware_factuals_women,
  main = "", xlab = "", ylab = "",
  axes = FALSE, col = NA,
  xlim = x_lim, ylim = y_lim
)
axis(1)
axis(2)
polygon(d_aware_factuals_women, col = alpha(colours_all[["source"]], .5), border = NA)
lines(d_aware_factuals_men, col = colours_all[["reference"]], lty = 2, lwd = 2)
polygon(d_aware_seq_women_star, col = alpha(colours_all[["seq"]], .5), border = NA)
text(x = .4, y = 6, "Seq. T.", col = colours_all[["seq"]])
```

:::


## Metrics


We define a small function, `get_prob()`{.R}, to compute the average score predicted by the model (either the aware model or the unaware model) in sub-groups identified by positions of observations.
```{r define-get_prob}
#| code-fold: true
#| code-summary: The `get_prob()`{.R} function.

#' Computes the average predicted score returned by one of the classifiers.
#' 
#' @param type Either `"factual"`, `"naive"`, `"fairadapt"`, or `"seq"`.
#' @param model Type of model: `"aware"` is the classifier used the sensitive
#'        attribute, `"unaware"` otherwise.
#' @param ind Index of rows in the datasets to compute the statistics on.
#' @param sensitive Name of the sensitive group in which the focus is on.
get_prob <- function(type, model = "aware", ind, sensitive = "Women") {
  if (type == "factual") {
    x <- get(paste0("factuals_", model))
  } else if (type == "naive") {
    x <- get(paste0("counterfactuals_", model, "_naive_women"))
  } else if (type == "fairadapt") {
    x <- get(paste0("counterfactuals_", model, "_fpt_women"))
  } else if (type == "seq") {
    x <- get(paste0("counterfactuals_", model, "_seq_women"))
  } else {
    stop("Error type.")
  }
  
  val <- x |> filter(id_indiv %in% ind) |> pull("pred")
  
  tribble(
    ~type, ~model, ~sensitive, ~value_type, ~value,
    type, model, sensitive, "mean", mean(val),
    type, model, sensitive, "sd", sd(val)
  )
}
```

We identify the following sub-groups:

```{r define-subgroups}
adult <- adult |> mutate(id_indiv = row_number())

ind_women <- adult |> filter(sex == "Female") |> pull("id_indiv")
ind_men <- adult |> filter(sex == "Male") |> pull("id_indiv")
ind_pos <- adult |> filter(income == ">50K") |> pull("id_indiv")
ind_neg <- adult |> filter(income == "<=50K") |> pull("id_indiv")
ind_true_pos <- intersect(ind_pos, ind_women)
ind_pos_women <- intersect(ind_pos, ind_women)
ind_pos_men <- intersect(ind_pos, ind_men)
ind_neg_women <- intersect(ind_neg, ind_women)
ind_neg_men <- intersect(ind_neg, ind_men)
```


Then, we compute the three metrics and merge them in a single table:
```{r define-conditional_demographic_parity}
conditional_demographic_parity <- NULL
eq_op_pos <- NULL
eq_op_neg <- NULL
for (type in c("factual", "naive", "fairadapt", "seq")) {
  for (model in c("aware", "unaware")) {
    if (type == "factual") {
      for (sensitive in c("Women", "Men")) {
        # Conditional Demographic Parity
        tmp_cdp <- 
          get_prob(type = type, model = model, ind = ind_women) |> 
          bind_rows(
            get_prob(
              type = type, model = model, ind = ind_men, sensitive = "Men"
            )
          )
        # ~ Equal Opportunity for Y=1
        tmp_eq_op_pos <- 
          get_prob(type = type, model = model, ind = ind_pos_women) |> 
          bind_rows(
            get_prob(
              type = type, model = model, ind = ind_pos_men, 
              sensitive = "Men"
            )
          )
        # ~ Equal Opportunity for Y=0
        tmp_eq_op_neg <- 
          get_prob(type = type, model = model, ind = ind_neg_women) |> 
          bind_rows(
            get_prob(
              type = type, model = model, ind = ind_neg_men, 
              sensitive = "Men"
            )
          )
      } 
    } else {
      tmp_cdp <- get_prob(type = type, model = model, ind = ind_women)
      tmp_eq_op_pos <- get_prob(type = type, model = model, ind = ind_pos_women)
      tmp_eq_op_neg <- get_prob(type = type, model = model, ind = ind_neg_women)
    }
    conditional_demographic_parity <- 
      bind_rows(conditional_demographic_parity, tmp_cdp)
    eq_op_pos <- bind_rows(eq_op_pos, tmp_eq_op_pos)
    eq_op_neg <- bind_rows(eq_op_neg, tmp_eq_op_neg)
  }
}

# Merge those in a single table:
metrics <- 
  conditional_demographic_parity |> mutate(metric = "CDP") |> 
  bind_rows(eq_op_pos |> mutate(metric = "Eq. Opp. Y=1")) |> 
  bind_rows(eq_op_neg |> mutate(metric = "Eq. Opp. Y=0"))

```


```{r}
#| code-fold: true
#| code-summary: The code to create the table.
#| tbl-cap: Fairness metrics computed on scores predicted by the classifier based on the factuals or the different versions of the counterfactuals, for the aware model (sensitive variable used to train the classifier) and the unaware model (sentitive variable not provided to train the classifier).
#| label: tbl-fairness-metrics-adult
# digits <- 2
num_accuracy <- 0.01
tb_res <- 
  metrics |> 
  mutate(type = ifelse(
    type == "factual" & sensitive == "Men", "factual_men", type),
    type = factor(type, levels = c("factual_men", "factual", "naive","fairadapt", "seq"))
  ) |> 
  select(-sensitive) |> 
  pivot_wider(names_from = "value_type", values_from = "value") |> 
  mutate(value = paste0(
    scales::number(mean, accuracy = num_accuracy),
    " (",
    scales::number(sd, accuracy = num_accuracy),
    ")")
  ) |> 
  select(-mean, -sd) |> 
  pivot_wider(names_from = "type", values_from = "value", names_sort = TRUE) |> 
  arrange(model, metric)
knitr::kable(
  tb_res[, -1], 
  col.names = c("Metric", "Factual", "Factual", "Naive", "Fairadapt", "Seq. Transport")
) |> 
  kableExtra::kable_styling("striped", full_width = F) %>%
  kableExtra::add_header_above(
    c(" " = 1, "Men"=1, "Women"=4)
  ) |> 
  kableExtra::pack_rows(index = table(tb_res$model))
```


```{r, eval=FALSE}
#| code-fold: true
#| code-summary: LaTeX Table
knitr::kable(
  tb_res[,-1], format = "latex", booktabs = TRUE
) |> 
  kableExtra::kable_styling("striped", full_width = F) %>%
  kableExtra::add_header_above(
    c(" " = 1, "Men"=1, "Women"=4)
  ) |> 
  kableExtra::pack_rows(index = table(tb_res$model))
```


